<!doctype html>
<html lang="fr" data-theme="light">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Paramètres — LoveNow</title>
  <meta name="description" content="Personnalisez vos préférences LoveNow et gérez votre expérience en toute simplicité."/>
  <link rel="stylesheet" href="/styles/tokens.css">
  <link rel="stylesheet" href="/styles/components.css">
  <script src="/js/features.js"></script>
  <script src="/config.js"></script>
  <script defer src="/js/ui.js"></script>
  <style>
    .settings-shell{display:grid;gap:24px;margin:48px auto 96px}
    .settings-card{display:grid;gap:16px}
    .account-meta{display:grid;gap:6px;padding:14px 18px;background:rgba(255,255,255,0.65);border-radius:var(--radius);box-shadow:0 18px 36px -32px rgba(47,22,52,0.35)}
    [data-theme="dark"] .account-meta{background:rgba(29,28,54,0.65);box-shadow:none}
    .settings-form{display:grid;gap:18px}
    .form-row{display:grid;gap:18px;grid-template-columns:repeat(auto-fit,minmax(200px,1fr))}
    #prefStatus{min-height:1.2em}
    #prefStatus[data-state="success"]{color:#25694a}
    #prefStatus[data-state="error"]{color:#7e2f32}
    #prefStatus[data-state="warn"]{color:#7a5123}
  </style>
</head>
<body>
  <header class="site-header">
    <div class="wrap nav-bar">
      <a class="brand" href="/" aria-label="LoveNow">
        <img src="/assets/brand/logo.svg" alt="Logo LoveNow" />
        <span>LoveNow</span>
      </a>
      <button class="nav-toggle" type="button" aria-expanded="false" aria-controls="primary-menu" data-toggle-nav>
        <span></span>
        <span class="sr-only">Ouvrir le menu</span>
      </button>
      <nav id="primary-menu" class="site-menu" aria-label="Navigation principale">
        <a href="/">Accueil</a>
        <a href="/matchmaking.html">Matching</a>
        <a href="/conversations.html">Conversations</a>
        <a href="/profile.html">Mon profil</a>
        <a href="/settings.html" aria-current="page">Paramètres</a>
        <a href="/privacy.html">Confidentialité</a>
        <div class="session-slot" id="header-session">
          <a class="btn" href="/login.html#signup">Rejoins-nous</a>
        </div>
      </nav>
      <button class="mode-toggle" type="button" data-toggle-theme aria-label="Basculer le mode d'affichage">
        <svg aria-hidden="true" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6">
          <path d="M12 3a1 1 0 0 1 1 1v1.1a1 1 0 0 1-1 1h-.2a1 1 0 0 1-1-.8 3 3 0 0 0-2.9 2.9 1 1 0 0 1-.8 1H6a1 1 0 0 1-1-1A7 7 0 0 1 12 3Z" />
          <path d="M7 12a5 5 0 1 0 10 0 5 5 0 0 0-10 0Z" />
        </svg>
        <span>Mode</span>
      </button>
    </div>
  </header>

  <main>
    <section class="page-section">
      <div class="wrap settings-shell">
        <div id="verifyBanner" class="banner" hidden>
          <div><strong>E-mail non vérifié.</strong> Vérifie ton adresse pour gérer tous les paramètres.</div>
          <div class="actions">
            <button id="btnResend" class="btn">Renvoyer le lien</button>
            <button id="btnRefresh" class="btn ghost">Rafraîchir</button>
          </div>
        </div>

        <div class="page-card settings-card">
          <h1>Paramètres du compte</h1>
          <p class="muted">Retrouve ici tes informations principales et un accès rapide aux réglages clés.</p>
          <div class="account-meta">
            <p><strong>E-mail :</strong> <span id="accountEmail">—</span></p>
            <p class="tiny">UID : <span id="accountUid">—</span></p>
            <p class="tiny">Statut : <span id="accountStatus">—</span></p>
            <span id="devBadge" class="badge badge--dev" hidden>Mode test</span>
          </div>
          <div class="actions">
            <a class="btn" href="/profile.html">Modifier mon profil</a>
            <a class="btn ghost" href="/privacy.html">Consulter la confidentialité</a>
            <button id="btnLogout" class="btn ghost" type="button">Se déconnecter</button>
          </div>
        </div>

        <div class="page-card settings-card">
          <h2>Filtres par défaut</h2>
          <p class="muted">Ces filtres s’appliquent automatiquement sur la page Découvrir. Tu peux les modifier à tout moment.</p>
          <form id="prefForm" class="settings-form">
            <div class="form-row">
              <div>
                <label for="prefAgeMin">Âge min</label>
                <input id="prefAgeMin" type="number" min="18" max="99" inputmode="numeric">
              </div>
              <div>
                <label for="prefAgeMax">Âge max</label>
                <input id="prefAgeMax" type="number" min="18" max="99" inputmode="numeric">
              </div>
              <div>
                <label for="prefCity">Ville</label>
                <input id="prefCity" type="text" placeholder="Paris">
              </div>
            </div>
            <div class="actions">
              <button id="btnSavePrefs" class="btn" type="submit">Enregistrer</button>
              <span id="prefStatus" class="tiny" role="status" aria-live="polite"></span>
            </div>
          </form>
        </div>

        <div class="page-card settings-card">
          <h2>Notifications</h2>
          <p class="muted">Les notifications e-mail et push arrivent bientôt. Tu pourras choisir le canal et la fréquence.</p>
          <p class="tiny">Fonctionnalité en préparation.</p>
        </div>

        <div class="page-card settings-card">
          <h2>Mode discret</h2>
          <p class="muted">Masque ton profil temporairement lorsqu’il sera disponible. Les matchs existants resteront accessibles.</p>
          <p class="tiny">Disponible prochainement.</p>
        </div>
      </div>
    </section>
  </main>

  <footer>
    <div class="wrap footer-card">
      <small>© LoveNow</small>
      <div class="footer-links">
        <a href="/privacy.html">Confidentialité</a>
        <a href="/cgu.html">CGU</a>
      </div>
    </div>
  </footer>

  <script type="module">
    import {
      setupFirebase,
      renderVerifyBanner,
      applySessionToHeader,
      safeSignOut,
      ensureUserDocuments,
      getUserPreferences,
      updateUserPreferences,
      isDevBypassEnabled,
    } from '/js/app-core.js';

    const state = {
      devBypass: isDevBypassEnabled(),
    };

    const $ = (selector) => document.querySelector(selector);
    const verifyBanner = $('#verifyBanner');
    const btnResend = $('#btnResend');
    const btnRefresh = $('#btnRefresh');
    const headerSlot = $('#header-session');
    const accountEmail = $('#accountEmail');
    const accountUid = $('#accountUid');
    const accountStatus = $('#accountStatus');
    const devBadge = $('#devBadge');
    const btnLogout = $('#btnLogout');
    const prefForm = $('#prefForm');
    const ageMinInput = $('#prefAgeMin');
    const ageMaxInput = $('#prefAgeMax');
    const cityInput = $('#prefCity');
    const prefStatus = $('#prefStatus');

    const setPrefStatus = (message, tone = 'info') => {
      if (!prefStatus) return;
      prefStatus.textContent = message;
      prefStatus.dataset.state = tone;
    };

    const updateAccountMeta = (user) => {
      if (!user) return;
      if (accountEmail) accountEmail.textContent = user.email || '—';
      if (accountUid) accountUid.textContent = user.uid;
      if (accountStatus) {
        if (user.emailVerified) {
          accountStatus.textContent = 'E-mail vérifié ✅';
          accountStatus.dataset.state = 'success';
        } else if (state.devBypass) {
          accountStatus.textContent = 'Mode test : e-mail non vérifié';
          accountStatus.dataset.state = 'warn';
        } else {
          accountStatus.textContent = 'E-mail non vérifié';
          accountStatus.dataset.state = 'error';
        }
      }
      if (devBadge) devBadge.hidden = !state.devBypass;
    };

    const fillPreferences = (prefs = {}) => {
      if (ageMinInput) ageMinInput.value = prefs.ageMin ?? '';
      if (ageMaxInput) ageMaxInput.value = prefs.ageMax ?? '';
      if (cityInput) cityInput.value = prefs.city ?? '';
    };

    (async () => {
      const { auth, db, authModule, firestoreModule } = await setupFirebase();
      const {
        onAuthStateChanged,
        signOut,
        sendEmailVerification,
        reload,
      } = authModule;

      renderVerifyBanner({
        banner: verifyBanner,
        resendBtn: btnResend,
        refreshBtn: btnRefresh,
        onResend: async () => {
          if (!auth.currentUser) return;
          await sendEmailVerification(auth.currentUser);
          setPrefStatus('Lien de vérification envoyé ✅', 'success');
        },
        onRefresh: async () => {
          if (!auth.currentUser) return;
          await reload(auth.currentUser);
          updateAccountMeta(auth.currentUser);
          if (auth.currentUser.emailVerified || state.devBypass) {
            verifyBanner.hidden = true;
          }
        },
      });

      onAuthStateChanged(auth, async (user) => {
        if (!user) {
          window.location.href = '/login.html#log_in';
          return;
        }

        updateAccountMeta(user);
        applySessionToHeader(headerSlot, user, {
          onSignOutClick: (event) => safeSignOut(auth, signOut, event?.currentTarget || btnLogout),
        });
        await ensureUserDocuments(db, firestoreModule, user);
        verifyBanner.hidden = user.emailVerified || state.devBypass;

        try {
          const prefs = await getUserPreferences(db, firestoreModule, user.uid);
          fillPreferences(prefs);
          setPrefStatus('');
        } catch (error) {
          console.error('load preferences failed', error);
          setPrefStatus('Impossible de charger les préférences.', 'error');
        }
      });

      prefForm?.addEventListener('submit', async (event) => {
        event.preventDefault();
        if (!auth.currentUser) return;
        const ageMin = Number(ageMinInput?.value) || null;
        const ageMax = Number(ageMaxInput?.value) || null;
        if (Number.isFinite(ageMin) && Number.isFinite(ageMax) && ageMin > ageMax) {
          setPrefStatus('L’âge min ne peut pas dépasser l’âge max.', 'warn');
          return;
        }
        const payload = {
          ageMin: Number.isFinite(ageMin) ? ageMin : null,
          ageMax: Number.isFinite(ageMax) ? ageMax : null,
          city: (cityInput?.value || '').trim(),
        };
        try {
          await updateUserPreferences(db, firestoreModule, auth.currentUser.uid, payload);
          setPrefStatus('Préférences enregistrées ✅', 'success');
        } catch (error) {
          console.error('save preferences failed', error);
          setPrefStatus('Enregistrement impossible pour le moment.', 'error');
        }
      });

      btnLogout?.addEventListener('click', (event) => {
        safeSignOut(auth, signOut, event?.currentTarget || btnLogout);
      });
    })();
  </script>
</body>
</html>
