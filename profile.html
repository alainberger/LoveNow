<!doctype html>
<html lang="fr" data-theme="light">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Mon profil ‚Äî LoveNow</title>
  <meta name="description" content="G√®re ton profil LoveNow : photo, bio, ville, √¢ge, genre."/>
  <link rel="stylesheet" href="/styles/tokens.css">
  <link rel="stylesheet" href="/styles/components.css">
  <script src="/js/features.js"></script>
  <script src="config.js"></script>
  <script defer src="/js/ui.js"></script>
  <style>
    *{box-sizing:border-box}
    html,body{margin:0;min-height:100%;background:var(--bg);color:var(--text);font-family:'Manrope',system-ui,sans-serif}
    main{padding-bottom:72px}
    .profile-shell{width:min(960px,92vw);margin:48px auto 96px;display:grid;gap:24px}
    .profile-form{display:grid;gap:22px}
    .profile-photo{display:flex;gap:18px;align-items:center;flex-wrap:wrap}
    .profile-photo img{width:132px;height:132px;border-radius:32px;object-fit:cover;box-shadow:0 24px 48px -28px rgba(47,22,52,0.4)}
    .profile-photo input{width:auto}
    .field-row{display:grid;gap:18px;grid-template-columns:repeat(auto-fit,minmax(220px,1fr))}
    .profile-actions{display:flex;gap:12px;flex-wrap:wrap;margin-top:12px}
  .tiny{font-size:0.85rem;color:var(--muted)}
  .account-summary{display:grid;gap:6px;background:rgba(255,255,255,0.65);border-radius:var(--radius);padding:14px 18px;box-shadow:0 18px 36px -30px rgba(47,22,52,0.35)}
  [data-theme="dark"] .account-summary{background:rgba(29,28,54,0.65);box-shadow:none}
  .account-summary strong{color:var(--text)}
  #accountStatus[data-state="warn"]{color:#7a5123}
  #accountStatus[data-state="ok"]{color:#25694a}
  #accountStatus[data-state="error"]{color:#7e2f32}
  .badge-info{display:inline-flex;align-items:center;gap:6px;padding:0.4rem 0.75rem;border-radius:999px;background:rgba(255,61,138,0.15);color:var(--brand);font-weight:600;font-size:0.85rem}
    textarea{min-height:120px}
    .profile-hint{margin-top:4px}
  </style>
</head>
<body>
<header class="site-header">
  <div class="wrap nav-bar">
    <a class="brand" href="/" aria-label="LoveNow">
      <img src="/assets/brand/logo.svg" alt="Logo LoveNow" />
      <span>LoveNow</span>
    </a>
    <button class="nav-toggle" type="button" aria-expanded="false" aria-controls="primary-menu" data-toggle-nav>
      <span></span>
      <span class="sr-only">Ouvrir le menu</span>
    </button>
    <nav id="primary-menu" class="site-menu" aria-label="Navigation principale">
      <a href="/#discover">D√©couvrir</a>
      <a href="/matchmaking.html">Matching</a>
      <a href="/conversations.html">Conversations</a>
      <a href="/profile.html" aria-current="page">Mon profil</a>
      <a href="/settings.html">Param√®tres</a>
      <div class="session-slot" id="header-session"></div>
    </nav>
    <button class="mode-toggle" type="button" data-toggle-theme aria-label="Basculer le mode d'affichage">
      <svg aria-hidden="true" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6">
        <path d="M12 3a1 1 0 0 1 1 1v1.1a1 1 0 0 1-1 1h-.2a1 1 0 0 1-1-.8 3 3 0 0 0-2.9 2.9 1 1 0 0 1-.8 1H6a1 1 0 0 1-1-1A7 7 0 0 1 12 3Z" />
        <path d="M7 12a5 5 0 1 0 10 0 5 5 0 0 0-10 0Z" />
      </svg>
      <span>Mode</span>
    </button>
  </div>
</header>

<main>
  <div class="profile-shell">
    <div id="verifyBanner" class="banner" hidden>
      <div>E-mail non v√©rifi√©. V√©rifie ton e-mail pour d√©bloquer toutes les fonctions.</div>
      <div class="actions">
        <button id="btnResend" class="btn">Renvoyer le lien</button>
        <button id="btnRefresh" class="btn ghost">Rafra√Æchir</button>
      </div>
    </div>

    <div class="page-card profile-form">
      <div class="account-summary" id="accountSummary">
        <p><strong>E-mail :</strong> <span id="accountEmail">‚Äî</span></p>
        <p class="tiny">UID : <span id="accountUid">‚Äî</span></p>
        <p class="tiny">Statut : <span id="accountStatus">‚Äî</span></p>
        <span id="devBadge" class="badge badge--dev" hidden>Mode test</span>
      </div>

      <div class="profile-photo">
        <img id="avatar" src="" alt="Ta photo">
        <div>
          <span class="badge-info">üì∏ Photo de profil</span>
          <input id="file" type="file" accept="image/*">
          <p class="tiny">JPG/PNG/WebP ‚â§ 5 Mo ‚Äî h√©berg√© sur Cloudinary.</p>
          <button id="btnUpload" class="btn ghost">T√©l√©verser la photo</button>
        </div>
      </div>

      <div class="field-row">
        <div>
          <label for="name">Nom / Pseudo</label>
          <input id="name" required>
        </div>
        <div>
          <label for="city">Ville</label>
          <input id="city" placeholder="ex. Paris">
        </div>
      </div>

      <div class="field-row">
        <div>
          <label for="age">√Çge</label>
          <input id="age" type="number" min="18" max="99" required>
        </div>
        <div>
          <label for="gender">Genre</label>
          <select id="gender">
            <option value="F">Femme</option>
            <option value="M">Homme</option>
            <option value="O">Autre</option>
          </select>
        </div>
      </div>

      <div>
        <label for="bio">Bio</label>
        <textarea id="bio" placeholder="Parle un peu de toi‚Ä¶"></textarea>
      </div>

      <div class="profile-actions">
        <button id="btnSave" class="btn">Enregistrer</button>
        <a class="btn ghost" href="index.html">Retour</a>
        <button id="btnLogout" class="btn ghost" type="button">Se d√©connecter</button>
      </div>
      <p class="tiny profile-hint">Astuce : ton profil s‚Äôaffiche en d√©couverte si nom/√¢ge/ville/genre/bio sont renseign√©s.</p>
    </div>
  </div>
</main>

<footer>
  <div class="wrap footer-card">
    <small>¬© LoveNow ‚Äî Profil</small>
    <div class="footer-links">
      <a href="/conversations.html">Conversations</a>
      <a href="/privacy.html">Confidentialit√©</a>
      <a href="/cgu.html">CGU</a>
    </div>
  </div>
</footer>

<div id="toast"></div>

<!-- Firebase + Firestore + AppCheck -->
<script type="module">
  import {
    setupFirebase,
    ensureUserDocuments,
    renderVerifyBanner,
    applySessionToHeader,
    safeSignOut,
    saveUserProfile,
    isDevBypassEnabled,
  } from '/js/app-core.js';

  const CLOUD = {
    cloudName: window.APP_CONFIG?.cloudinary?.cloudName,
    preset: window.APP_CONFIG?.cloudinary?.unsignedPreset,
    useSigned: !!window.APP_CONFIG?.cloudinary?.useSigned,
  };

  const state = {
    devBypass: isDevBypassEnabled(),
    unsubProfile: null,
  };

  const $ = (selector) => document.querySelector(selector);
  const avatar = $('#avatar');
  const fileInput = $('#file');
  const nameInput = $('#name');
  const cityInput = $('#city');
  const ageInput = $('#age');
  const genderInput = $('#gender');
  const bioInput = $('#bio');
  const btnSave = $('#btnSave');
  const btnUpload = $('#btnUpload');
  const btnLogout = $('#btnLogout');
  const accountEmail = $('#accountEmail');
  const accountUid = $('#accountUid');
  const accountStatus = $('#accountStatus');
  const devBadge = $('#devBadge');
  const verifyBanner = $('#verifyBanner');
  const btnResend = $('#btnResend');
  const btnRefresh = $('#btnRefresh');
  const headerSlot = document.getElementById('header-session');
  const toastEl = $('#toast');

  let toastTimer;
  const toast = (message) => {
    if (!toastEl) return;
    toastEl.textContent = message;
    toastEl.classList.add('show');
    clearTimeout(toastTimer);
    toastTimer = setTimeout(() => toastEl.classList.remove('show'), 2400);
  };

  const fillInputs = (data = {}, user = {}) => {
    nameInput.value = data.name ?? user.displayName ?? '';
    cityInput.value = data.city ?? '';
    ageInput.value = data.age != null ? data.age : '';
    genderInput.value = data.gender ?? 'O';
    bioInput.value = data.bio ?? '';
    avatar.src = data.photoURL || user.photoURL || 'https://images.unsplash.com/photo-1502685104226-ee32379fefbe?q=80&w=800&auto=format&fit=crop';
  };

  const updateAccountSummary = (user) => {
    if (!user) return;
    if (accountEmail) accountEmail.textContent = user.email || '‚Äî';
    if (accountUid) accountUid.textContent = user.uid;
    if (accountStatus) {
      if (user.emailVerified) {
        accountStatus.textContent = 'E-mail v√©rifi√© ‚úÖ';
        accountStatus.dataset.state = 'ok';
      } else if (state.devBypass) {
        accountStatus.textContent = 'Mode test : e-mail non v√©rifi√©';
        accountStatus.dataset.state = 'warn';
      } else {
        accountStatus.textContent = 'E-mail non v√©rifi√©';
        accountStatus.dataset.state = 'error';
      }
    }
    if (devBadge) devBadge.hidden = !state.devBypass;
  };

  (async () => {
    const { auth, db, authModule, firestoreModule } = await setupFirebase();
    const {
      onAuthStateChanged,
      updateProfile,
      sendEmailVerification,
      signOut,
      reload,
    } = authModule;
    const { doc, onSnapshot } = firestoreModule;

    renderVerifyBanner({
      banner: verifyBanner,
      resendBtn: btnResend,
      refreshBtn: btnRefresh,
      onResend: async () => {
        if (!auth.currentUser) return;
        await sendEmailVerification(auth.currentUser);
        toast('Lien de v√©rification envoy√© ‚úÖ');
      },
      onRefresh: async () => {
        if (!auth.currentUser) return;
        await reload(auth.currentUser);
        updateAccountSummary(auth.currentUser);
        if (auth.currentUser.emailVerified || state.devBypass) {
          verifyBanner.hidden = true;
        }
      },
    });

    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        window.location.href = '/login.html#log_in';
        return;
      }

      updateAccountSummary(user);
      applySessionToHeader(headerSlot, user, {
        onSignOutClick: (event) => safeSignOut(auth, signOut, event?.currentTarget || btnLogout),
      });

      if (state.unsubProfile) {
        state.unsubProfile();
        state.unsubProfile = null;
      }

      await ensureUserDocuments(db, firestoreModule, user);

      const userRef = doc(db, 'users', user.uid);
      state.unsubProfile = onSnapshot(userRef, (snapshot) => {
        const data = snapshot.data() || {};
        fillInputs(data, user);
      }, (error) => {
        console.error('Profil listen error', error);
      });

      verifyBanner.hidden = user.emailVerified || state.devBypass;
    });

    btnSave?.addEventListener('click', async () => {
      if (!auth.currentUser) return;
      btnSave.disabled = true;
      try {
        const payload = {
          name: nameInput.value.trim(),
          displayName: nameInput.value.trim(),
          city: cityInput.value.trim(),
          age: Number(ageInput.value) || null,
          gender: genderInput.value,
          bio: bioInput.value.trim(),
        };
        await saveUserProfile(db, firestoreModule, auth.currentUser.uid, payload);
        if (payload.name && payload.name !== (auth.currentUser.displayName || '')) {
          await updateProfile(auth.currentUser, { displayName: payload.name });
        }
        toast('Profil enregistr√© ‚úÖ');
      } catch (error) {
        console.error('save profile failed', error);
        toast('Impossible d‚Äôenregistrer pour le moment.');
      } finally {
        btnSave.disabled = false;
      }
    });

    btnUpload?.addEventListener('click', async () => {
      if (!auth.currentUser) return;
      const file = fileInput?.files?.[0];
      if (!file) {
        alert('Choisis d‚Äôabord une image.');
        return;
      }
      if (file.size > 5 * 1024 * 1024) {
        alert('Fichier trop lourd (max 5 Mo).');
        return;
      }
      if (!CLOUD.cloudName) {
        alert('Cloudinary non configur√© dans config.js');
        return;
      }

      btnUpload.disabled = true;
      try {
        const formData = new FormData();
        formData.append('file', file);
        if (CLOUD.useSigned) {
          const response = await fetch('/.netlify/functions/sign-upload');
          const signature = await response.json();
          formData.append('api_key', signature.apiKey);
          formData.append('timestamp', signature.timestamp);
          formData.append('signature', signature.signature);
          if (signature.preset) formData.append('upload_preset', signature.preset);
        } else {
          if (!CLOUD.preset) {
            alert('Cloudinary non configur√© dans config.js');
            return;
          }
          formData.append('upload_preset', CLOUD.preset);
        }
        const upload = await fetch(`https://api.cloudinary.com/v1_1/${CLOUD.cloudName}/image/upload`, {
          method: 'POST',
          body: formData,
        });
        const result = await upload.json();
        if (!result.secure_url) {
          throw new Error(result.error?.message || 'Upload √©chou√©');
        }
        await saveUserProfile(db, firestoreModule, auth.currentUser.uid, { photoURL: result.secure_url });
        try {
          await updateProfile(auth.currentUser, { photoURL: result.secure_url });
        } catch (err) {
          console.warn('updateProfile photo', err);
        }
        toast('Photo mise √† jour ‚úÖ');
      } catch (error) {
        console.error('upload failed', error);
        alert('Impossible de t√©l√©verser la photo : ' + (error?.message || 'erreur inconnue'));
      } finally {
        btnUpload.disabled = false;
      }
    });

    btnLogout?.addEventListener('click', async (event) => {
      await safeSignOut(auth, signOut, event?.currentTarget || btnLogout);
    });
  })();
</script>
<script>loadCrispIfEnabled();</script>
</body>
</html>