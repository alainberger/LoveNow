<!doctype html>
<html lang="fr" data-theme="dark">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Mon profil — LoveNow</title>
  <meta name="description" content="Gère ton profil LoveNow : photo, bio, ville, âge, genre."/>
  <link rel="canonical" href="https://lovenow.netlify.app/profile"/>
  <meta property="og:title" content="Mon profil — LoveNow"/>
  <meta property="og:description" content="Gère ton profil LoveNow : photo, bio, ville, âge, genre."/>
  <meta property="og:url" content="https://lovenow.netlify.app/profile"/>
  <meta property="og:image" content="https://via.placeholder.com/1200x630.png?text=LoveNow"/>
  <meta name="twitter:card" content="summary_large_image"/>
  <link rel="preload" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" as="style" onload="this.rel='stylesheet'"/>
  <style>
    :root{--bg:#0f1115;--card:#171922;--muted:#aab1c3;--text:#e9edf6;--brand:#ff2d55;--brand2:#7a5cf0;--line:#23283d}
    *{box-sizing:border-box}
    html,body{margin:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui}
    a{color:inherit;text-decoration:none}
    .wrap{max-width:900px;margin:0 auto;padding:16px}
    header{position:sticky;top:0;z-index:5;background:rgba(15,17,21,.7);backdrop-filter:saturate(140%) blur(8px);border-bottom:1px solid #202334}
    nav{display:flex;gap:8px;align-items:center;padding:10px 0}
    .spacer{flex:1}
    .btn{display:inline-flex;align-items:center;justify-content:center;padding:.6rem .9rem;border-radius:.6rem;background:#232739;border:1px solid #2b2f44;cursor:pointer}
    .btn-primary{background:linear-gradient(135deg,var(--brand),var(--brand2));border:none}
    .card{background:var(--card);border:1px solid #202334;border-radius:.9rem;padding:16px}
    label{display:block;margin:10px 0 6px;color:var(--muted)}
    input,select,textarea{width:100%;padding:.7rem;border-radius:.6rem;background:#0f1115;border:1px solid #2b2f44;color:#e9edf6}
    .row{display:grid;grid-template-columns:1fr;gap:12px}
    @media(min-width:720px){.row{grid-template-columns:1fr 1fr}}
    .photo{display:flex;gap:12px;align-items:center}
    .photo img{width:108px;height:108px;border-radius:12px;object-fit:cover;background:#0c0e12;border:1px solid #2b2f44}
    .muted{color:var(--muted)}
    .banner{background:#1a1e2b;border:1px solid #27314a;border-radius:.8rem;padding:.6rem .8rem;margin:12px 0;display:flex;gap:8px;justify-content:space-between;align-items:center}
    .toast{position:fixed;right:16px;bottom:16px;background:#111522;border:1px solid #22304a;padding:8px 12px;border-radius:8px}
    a:focus,button:focus,input:focus,select:focus,textarea:focus{outline:3px auto;outline-offset:2px}
    .danger{border-color:#c0392b}
  </style>
  <!-- Config publique (Firebase/AppCheck/Cloudinary) -->
  <script src="config.js"></script>
</head>
<body>
<header>
  <div class="wrap">
    <nav>
      <a class="btn" href="index.html">← Accueil</a>
      <strong>Mon profil</strong>
      <span class="spacer"></span>
      <a class="btn" href="conversations.html">Mes conversations</a>
      <button id="btnLogout" class="btn">Se déconnecter</button>
    </nav>
  </div>
</header>

<main class="wrap">
  <!-- Bannière e-mail -->
  <div id="verifyBanner" class="banner" hidden>
    <div>E-mail non vérifié. Vérifie ton e-mail pour débloquer toutes les fonctions.</div>
    <div style="display:flex;gap:8px">
      <button id="btnResend" class="btn">Renvoyer le lien</button>
      <button id="btnRefresh" class="btn">Rafraîchir</button>
    </div>
  </div>

  <div class="card">
    <div class="photo">
      <img id="avatar" src="" alt="Ta photo">
      <div>
        <input id="file" type="file" accept="image/*">
        <div class="muted" style="font-size:.9rem">Carré 512×512 recommandé (JPG/PNG &lt; 5 Mo) — hébergé sur Cloudinary.</div>
        <button id="btnUpload" class="btn" style="margin-top:8px">Téléverser la photo</button>
        <div id="upWarn" class="muted" style="margin-top:6px;display:none"></div>
      </div>
    </div>

    <div class="row" style="margin-top:12px">
      <div>
        <label for="name">Nom / Pseudo</label>
        <input id="name" required>
      </div>
      <div>
        <label for="city">Ville</label>
        <input id="city" placeholder="ex. Paris">
      </div>
    </div>

    <div class="row">
      <div>
        <label for="age">Âge</label>
        <input id="age" type="number" min="18" max="99" required aria-describedby="ageErr">
        <div id="ageErr" class="muted" aria-live="polite" style="display:none"></div>
      </div>
      <div>
        <label for="gender">Genre</label>
        <select id="gender">
          <option value="F">Femme</option>
          <option value="M">Homme</option>
          <option value="O">Autre</option>
        </select>
      </div>
    </div>

    <label for="bio">Bio</label>
    <textarea id="bio" rows="4" placeholder="Parle un peu de toi…"></textarea>

    <div style="display:flex;gap:8px;margin-top:12px">
      <button id="btnSave" class="btn btn-primary">Enregistrer</button>
      <a class="btn" href="index.html">Retour</a>
    </div>
    <p class="muted" style="margin-top:8px">Astuce : enregistre ton profil pour qu’il apparaisse dans la découverte.</p>
  </div>
</main>

<div id="toast" class="toast" role="status" aria-live="polite" hidden></div>

<!-- App : Firebase + Firestore + AppCheck + Cloudinary unsigned -->
<script type="module">
  /* ===== Imports Firebase ===== */
  const cfg = window.APP_CONFIG?.firebase;
  const siteKey = window.APP_CONFIG?.appCheck?.recaptchaV3SiteKey;

  import { initializeApp, getApps, getApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
  import { getAuth, onAuthStateChanged, updateProfile, sendEmailVerification, signOut } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
  import { initializeAppCheck, ReCaptchaV3Provider } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app-check.js";
  import { getFirestore, doc, getDoc, setDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

  /* ===== Init Firebase (safe idempotent) ===== */
  const app = getApps().length ? getApp() : initializeApp(cfg);
  if (siteKey) initializeAppCheck(app, { provider: new ReCaptchaV3Provider(siteKey), isTokenAutoRefreshEnabled: true });
  const auth = getAuth(app);
  const db   = getFirestore(app);

  /* ===== Helpers UI ===== */
  const $ = s => document.querySelector(s);
  function showToast(msg){const t=$("#toast");t.textContent=msg;t.hidden=false;setTimeout(()=>t.hidden=true,3000);}
  const bust = (url)=> url ? url + (url.includes("?")?"&":"?") + "v=" + Date.now() : "";

  // Cloudinary (unsigned)
  const CLOUD = {
    cloudName: window.APP_CONFIG?.cloudinary?.cloudName,
    preset:    window.APP_CONFIG?.cloudinary?.unsignedPreset
  };

  // UI refs
  const avatar=$("#avatar"), file=$("#file"), upWarn=$("#upWarn");
  const name=$("#name"), city=$("#city"), age=$("#age"), gender=$("#gender"), bio=$("#bio");
  const verifyBanner=$("#verifyBanner"), btnResend=$("#btnResend"), btnRefresh=$("#btnRefresh");

  // Affiche un avertissement si Cloudinary n’est pas configuré
  if (!CLOUD.cloudName || !CLOUD.preset){
    upWarn.style.display="block";
    upWarn.textContent = "Téléversement désactivé : configure APP_CONFIG.cloudinary (cloudName + unsignedPreset).";
    $("#btnUpload").disabled = true;
    $("#file").classList.add("danger");
  }

  /* ===== Auth gate ===== */
  onAuthStateChanged(auth, async (user)=>{
    if(!user){ location.href="login.html#login"; return; }

    const verified = !!user.emailVerified;
    document.documentElement.dataset.verified = verified ? "true" : "false";
    verifyBanner.hidden = verified;

    // Charge / initialise le profil public
    const ref = doc(db,"profiles",user.uid);
    const snap = await getDoc(ref);
    if(!snap.exists()){
      await setDoc(ref,{
        uid: user.uid,
        email: user.email || "",
        name: user.displayName || "",
        age: null, gender:"O", city:"", bio:"",
        photoURL: user.photoURL || "",
        createdAt: serverTimestamp(), updatedAt: serverTimestamp()
      }, { merge:true });
    }
    const data = (await getDoc(ref)).data() || {};

    // Bind UI
    avatar.src = bust(data.photoURL || user.photoURL || "https://images.unsplash.com/photo-1502685104226-ee32379fefbe?q=80&w=800&auto=format&fit=crop");
    name.value = data.name || user.displayName || "";
    city.value = data.city || "";
    age.value  = data.age  || "";
    gender.value = (data.gender||"O");
    bio.value  = data.bio  || "";

    // Sauvegarde profil
    $("#btnSave").onclick = async ()=>{
      const a = Number(age.value)||null;
      if(!Number.isFinite(a) || a<18){ const err=$("#ageErr"); err.textContent="Vous devez avoir 18 ans ou plus."; err.style.display="block"; age.focus(); return; }
      $("#ageErr").style.display="none";

      const payload = {
        name: name.value.trim(),
        city: city.value.trim(),
        age:  a,
        gender: gender.value,
        bio:  bio.value.trim(),
        updatedAt: serverTimestamp()
      };
      await setDoc(ref, payload, { merge:true });
      try{
        if (auth.currentUser && payload.name && payload.name !== (auth.currentUser.displayName||"")){
          await updateProfile(auth.currentUser, { displayName: payload.name });
        }
      }catch{}
      showToast("Profil enregistré ✅");
    };

    // Upload Cloudinary (unsigned)
    $("#btnUpload").onclick = async ()=>{
      if (!CLOUD.cloudName || !CLOUD.preset){ alert("Upload indisponible (Cloudinary non configuré)."); return; }
      const f = file.files?.[0];
      if(!f){ alert("Choisis d’abord une image."); return; }

      try{
        let toUpload=f;
        try{
          const img=await new Promise((res,rej)=>{const i=new Image();i.onload=()=>res(i);i.onerror=rej;i.src=URL.createObjectURL(f);});
          if(f.size>5*1024*1024 || img.width>1024){
            const canvas=document.createElement('canvas');
            const scale=Math.min(1024/img.width,1024/img.height,1);
            canvas.width=img.width*scale; canvas.height=img.height*scale;
            const ctx=canvas.getContext('2d'); ctx.drawImage(img,0,0,canvas.width,canvas.height);
            const blob=await new Promise(r=>canvas.toBlob(r,'image/jpeg',0.8));
            toUpload=new File([blob], f.name.replace(/\.[^.]+$/,'.jpg'), {type:'image/jpeg'});
          }
        }catch(e){ console.warn('compression',e); }

        const fd = new FormData();
        fd.append("file", toUpload);
        fd.append("upload_preset", CLOUD.preset);
        // Optionnel : transformation côté Cloudinary (ex: limite largeur) → gérée par le preset

        const up = await fetch(`https://api.cloudinary.com/v1_1/${CLOUD.cloudName}/image/upload`, { method:"POST", body: fd });
        const out = await up.json();
        if(!out.secure_url){ throw new Error(out.error?.message || "Upload échoué"); }

        // Persiste l’URL Cloudinary + anti-cache et maj UI
        await setDoc(ref, { photoURL: out.secure_url, updatedAt: serverTimestamp() }, { merge:true });
        try{ await updateProfile(auth.currentUser, { photoURL: out.secure_url }); }catch{}
        avatar.src = bust(out.secure_url);
        showToast("Photo mise à jour ✅");
      }catch(e){
        console.error(e); alert("Impossible de téléverser la photo : " + e.message);
      }
    };

    // Déconnexion
    $("#btnLogout").onclick = async ()=>{ await signOut(auth); location.href="login.html"; };

    // Vérif e-mail
    btnResend?.addEventListener("click", async ()=>{
      try{
        const actionCodeSettings={ url:"https://lovenow.netlify.app/login.html?verified=1", handleCodeInApp:false };
        const btn=btnResend; const prev=btn.textContent; btn.disabled=true; btn.textContent="Envoi…";
        showToast("Envoi en cours…");
        await sendEmailVerification(auth.currentUser, actionCodeSettings);
        showToast("Lien envoyé ✅");
        btn.disabled=false; btn.textContent=prev;
      }catch(e){ console.error(e); showToast("Échec d'envoi. Réessaye."); }
    });
    btnRefresh?.addEventListener("click",()=>location.reload());
  });
</script>
</body>
</html>