<!doctype html>
<html lang="fr" data-theme="light">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Mon profil ‚Äî LoveNow</title>
  <meta name="description" content="G√®re ton profil LoveNow : photo, bio, ville, √¢ge, genre."/>
  <link rel="stylesheet" href="/styles/tokens.css">
  <link rel="stylesheet" href="/styles/components.css">
  <script src="/js/features.js"></script>
  <script src="config.js"></script>
  <script defer src="/js/ui.js"></script>
  <style>
    *{box-sizing:border-box}
    html,body{margin:0;min-height:100%;background:var(--bg);color:var(--text);font-family:'Manrope',system-ui,sans-serif}
    main{padding-bottom:72px}
    .profile-shell{width:min(960px,92vw);margin:48px auto 96px;display:grid;gap:24px}
    .profile-form{display:grid;gap:22px}
    .profile-photo{display:flex;gap:18px;align-items:center;flex-wrap:wrap}
    .profile-photo img{width:132px;height:132px;border-radius:32px;object-fit:cover;box-shadow:0 24px 48px -28px rgba(47,22,52,0.4)}
    .profile-photo input{width:auto}
    .field-row{display:grid;gap:18px;grid-template-columns:repeat(auto-fit,minmax(220px,1fr))}
    .profile-actions{display:flex;gap:12px;flex-wrap:wrap;margin-top:12px}
    .tiny{font-size:0.85rem;color:var(--muted)}
    .debug-id{font-size:0.8rem;color:var(--muted)}
    .badge-info{display:inline-flex;align-items:center;gap:6px;padding:0.4rem 0.75rem;border-radius:999px;background:rgba(255,61,138,0.15);color:var(--brand);font-weight:600;font-size:0.85rem}
    textarea{min-height:120px}
    .profile-hint{margin-top:4px}
  </style>
</head>
<body>
<header class="site-header">
  <div class="wrap nav-bar">
    <a class="brand" href="/" aria-label="LoveNow">
      <img src="/assets/brand/logo.svg" alt="Logo LoveNow" />
      <span>LoveNow</span>
    </a>
    <button class="nav-toggle" type="button" aria-expanded="false" aria-controls="primary-menu" data-toggle-nav>
      <span></span>
      <span class="sr-only">Ouvrir le menu</span>
    </button>
    <nav id="primary-menu" class="site-menu" aria-label="Navigation principale">
      <a href="/#discover">D√©couvrir</a>
      <a href="/matchmaking.html">Matching</a>
      <a href="/conversations.html">Conversations</a>
      <a href="/profile.html" aria-current="page">Mon profil</a>
      <a href="/settings.html">Param√®tres</a>
      <div class="session-slot">
        <button id="btnLogout" class="btn ghost" type="button">Se d√©connecter</button>
      </div>
    </nav>
    <button class="mode-toggle" type="button" data-toggle-theme aria-label="Basculer le mode d'affichage">
      <svg aria-hidden="true" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6">
        <path d="M12 3a1 1 0 0 1 1 1v1.1a1 1 0 0 1-1 1h-.2a1 1 0 0 1-1-.8 3 3 0 0 0-2.9 2.9 1 1 0 0 1-.8 1H6a1 1 0 0 1-1-1A7 7 0 0 1 12 3Z" />
        <path d="M7 12a5 5 0 1 0 10 0 5 5 0 0 0-10 0Z" />
      </svg>
      <span>Mode</span>
    </button>
  </div>
</header>

<main>
  <div class="profile-shell">
    <div id="verifyBanner" class="banner" hidden>
      <div>E-mail non v√©rifi√©. V√©rifie ton e-mail pour d√©bloquer toutes les fonctions.</div>
      <div class="actions">
        <button id="btnResend" class="btn">Renvoyer le lien</button>
        <button id="btnRefresh" class="btn ghost">Rafra√Æchir</button>
      </div>
    </div>

    <div class="page-card profile-form">
      <div class="debug-id" id="debugId"></div>

      <div class="profile-photo">
        <img id="avatar" src="" alt="Ta photo">
        <div>
          <span class="badge-info">üì∏ Photo de profil</span>
          <input id="file" type="file" accept="image/*">
          <p class="tiny">JPG/PNG/WebP ‚â§ 5 Mo ‚Äî h√©berg√© sur Cloudinary.</p>
          <button id="btnUpload" class="btn ghost">T√©l√©verser la photo</button>
        </div>
      </div>

      <div class="field-row">
        <div>
          <label for="name">Nom / Pseudo</label>
          <input id="name" required>
        </div>
        <div>
          <label for="city">Ville</label>
          <input id="city" placeholder="ex. Paris">
        </div>
      </div>

      <div class="field-row">
        <div>
          <label for="age">√Çge</label>
          <input id="age" type="number" min="18" max="99" required>
        </div>
        <div>
          <label for="gender">Genre</label>
          <select id="gender">
            <option value="F">Femme</option>
            <option value="M">Homme</option>
            <option value="O">Autre</option>
          </select>
        </div>
      </div>

      <div>
        <label for="bio">Bio</label>
        <textarea id="bio" placeholder="Parle un peu de toi‚Ä¶"></textarea>
      </div>

      <div class="profile-actions">
        <button id="btnSave" class="btn">Enregistrer</button>
        <a class="btn ghost" href="index.html">Retour</a>
      </div>
      <p class="tiny profile-hint">Astuce : ton profil s‚Äôaffiche en d√©couverte si nom/√¢ge/ville/genre/bio sont renseign√©s.</p>
    </div>
  </div>
</main>

<footer>
  <div class="wrap footer-card">
    <small>¬© LoveNow ‚Äî Profil</small>
    <div class="footer-links">
      <a href="/conversations.html">Conversations</a>
      <a href="/privacy.html">Confidentialit√©</a>
      <a href="/cgu.html">CGU</a>
    </div>
  </div>
</footer>

<div id="toast"></div>

<!-- Firebase + Firestore + AppCheck -->
<script type="module">
  // ====== Boot ======
  const cfg = window.APP_CONFIG?.firebase;
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
  import { getAuth, onAuthStateChanged, updateProfile, sendEmailVerification, signOut } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
  import { getFirestore, doc, getDoc, setDoc, serverTimestamp, onSnapshot } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

  const app = initializeApp(cfg);
  loadAppCheck(app);
  const auth = getAuth(app);
  const db   = getFirestore(app);

  const $ = s => document.querySelector(s);
  let toastTimer;
  const toast = (t)=>{
    const el=$("#toast");
    el.textContent=t;
    el.classList.add('show');
    clearTimeout(toastTimer);
    toastTimer=setTimeout(()=>el.classList.remove('show'),2200);
  };

  // Cloudinary (unsigned)
  const CLOUD = {
    cloudName: window.APP_CONFIG?.cloudinary?.cloudName,
    preset:    window.APP_CONFIG?.cloudinary?.unsignedPreset,
    useSigned: !!window.APP_CONFIG?.cloudinary?.useSigned
  };

  // Refs UI
  const avatar=$("#avatar"), file=$("#file");
  const name=$("#name"), city=$("#city"), age=$("#age"), gender=$("#gender"), bio=$("#bio");
  const verifyBanner=$("#verifyBanner"), btnResend=$("#btnResend"), btnRefresh=$("#btnRefresh");
  const debugId=$("#debugId");

  // ====== Helpers ======
  const fillInputs = (data={}, user={})=>{
    // n‚Äô√©crase pas pendant un upload/sauvegarde locale
    name.value   = data.name   ?? user.displayName ?? "";
    city.value   = data.city   ?? "";
    age.value    = (data.age ?? "") === null ? "" : (data.age ?? "");
    gender.value = data.gender ?? "O";
    bio.value    = data.bio    ?? "";
    avatar.src   = data.photoURL || user.photoURL || "https://images.unsplash.com/photo-1502685104226-ee32379fefbe?q=80&w=800&auto=format&fit=crop";
  };

  const ensureProfileDoc = async (uid, user)=>{
    const ref = doc(db,"profiles",uid);
    const s = await getDoc(ref);
    if (!s.exists()){
      await setDoc(ref,{
        uid, email: user.email || "",
        name: user.displayName || "",
        age: null, gender:"O", city:"", bio:"",
        photoURL: user.photoURL || "",
        createdAt: serverTimestamp(), updatedAt: serverTimestamp()
      }, { merge:true });
    }
    return ref;
  };

  // ====== Main flow ======
  onAuthStateChanged(auth, async (user)=>{
    if(!user){ location.href="login.html#login"; return; }

    // Debug utile pour √©viter le mauvais UID
    debugId.textContent = `Connect√© : ${user.email || ""} ‚Äî UID: ${user.uid}`;
    const verified = !!user.emailVerified;
    document.documentElement.dataset.verified = verified ? "true" : "false";
    verifyBanner.hidden = verified;

    // Cr√©e le doc au besoin puis abonne-toi en TEMPS R√âEL
    const ref = await ensureProfileDoc(user.uid, user);

    // Live listener ‚Üí remplit les champs √† chaque update (upload, save, autre device)
    onSnapshot(ref, (snap)=>{
      const data = snap.data() || {};
      fillInputs(data, user);
    }, (err)=>console.error("onSnapshot error:", err));

    // Save profil
    $("#btnSave").onclick = async ()=>{
      const payload = {
        name: name.value.trim(),
        city: city.value.trim(),
        age:  Number(age.value)||null,
        gender: gender.value,
        bio:  bio.value.trim(),
        updatedAt: serverTimestamp()
      };
      await setDoc(ref, payload, { merge:true });
      // R√©plique c√¥t√© Auth (affichage nom/photo sur d‚Äôautres pages)
      try{
        if (auth.currentUser) {
          const upd = {};
          if (payload.name && payload.name !== (auth.currentUser.displayName||"")) upd.displayName = payload.name;
          if (Object.keys(upd).length) await updateProfile(auth.currentUser, upd);
        }
      }catch(e){ console.warn("updateProfile name:", e); }
      toast("Profil enregistr√© ‚úÖ");
    };

    // Logout
    $("#btnLogout").onclick = async ()=>{ await signOut(auth); location.href="login.html"; };

    // Verify banner actions
    btnResend?.addEventListener("click", async ()=>{
      try{
        const actionCodeSettings={ url:"https://lovenow.netlify.app/login.html?verified=1", handleCodeInApp:false };
        await sendEmailVerification(auth.currentUser, actionCodeSettings);
        toast("Lien envoy√© ‚úÖ");
      }catch(e){ console.error(e); toast("√âchec envoi lien"); }
    });
    btnRefresh?.addEventListener("click",()=>location.reload());

    // Upload Cloudinary (unsigned preset)
    $("#btnUpload").onclick = async ()=>{
      const f = file.files?.[0];
      if(!f){ alert("Choisis d‚Äôabord une image."); return; }
      if(f.size > 5*1024*1024){ alert("Fichier trop lourd (max 5 Mo)."); return; }
      if(!CLOUD.cloudName){ alert("Cloudinary non configur√© dans config.js"); return; }

      try{
        const fd = new FormData();
        fd.append("file", f);
        if(CLOUD.useSigned){
          const sig = await fetch('/.netlify/functions/sign-upload').then(r=>r.json());
          fd.append('api_key', sig.apiKey);
          fd.append('timestamp', sig.timestamp);
          fd.append('signature', sig.signature);
          if(sig.preset) fd.append('upload_preset', sig.preset);
        }else{
          if(!CLOUD.preset){ alert("Cloudinary non configur√© dans config.js"); return; }
          fd.append('upload_preset', CLOUD.preset);
        }
        const up = await fetch(`https://api.cloudinary.com/v1_1/${CLOUD.cloudName}/image/upload`, { method:"POST", body: fd });
        const out = await up.json();
        if(!out.secure_url){ throw new Error(out.error?.message || "Upload √©chou√©"); }

        // √âcrit l‚ÄôURL et laisse onSnapshot rafra√Æchir l‚ÄôUI
        await setDoc(ref, { photoURL: out.secure_url, updatedAt: serverTimestamp() }, { merge:true });
        try{ await updateProfile(auth.currentUser, { photoURL: out.secure_url }); }catch{}
        toast("Photo mise √† jour ‚úÖ");
      }catch(e){
        console.error(e);
        alert("Impossible de t√©l√©verser la photo : " + e.message);
      }
    };
  });
</script>
<script>loadCrispIfEnabled();</script>
</body>
</html>