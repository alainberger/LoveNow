<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>LoveNow — Mon profil</title>
  <style>
    :root{--ln-bg:#0c0f14;--ln-panel:#111622;--ln-ink:#fff;--ln-soft:#a9b1c3;--ln-accent:#ff3b81;}
    body{margin:0;background:var(--ln-bg);color:var(--ln-ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial}
    .container{max-width:900px;margin:auto;padding:16px}
    .head{display:flex;align-items:center;gap:16px;margin:18px 0}
    .back{color:#fff;text-decoration:none;border:1px solid #ffffff30;background:#ffffff12;padding:8px 12px;border-radius:10px}
    .panel{background:var(--ln-panel);border:1px solid #ffffff14;border-radius:14px;padding:16px}
    .row{display:grid;grid-template-columns:160px 1fr;gap:16px}
    .avatar{width:160px;height:160px;object-fit:cover;border-radius:14px;background:#0b0f18}
    .field{margin:8px 0;display:flex;flex-direction:column}
    input,textarea,select{background:#12192a;border:1px solid #2a3245;color:#fff;border-radius:10px;padding:10px}
    .actions{display:flex;gap:10px;margin-top:12px}
    .ln-btn{border:1px solid #ffffff40;background:#ffffff12;color:#fff;padding:10px 14px;border-radius:10px;cursor:pointer}
    .ln-btn.primary{background:var(--ln-accent);border-color:transparent}
    .notice{display:flex;gap:8px;align-items:center;background:#2a2f3d;padding:10px;border-radius:10px;margin:10px 0}
  </style>
</head>
<body>
  <div class="container">
    <div class="head">
      <a id="backLink" href="/" class="back">← Retour</a>
      <h1 style="margin:0">Profil</h1>
    </div>

    <div id="emailBanner" class="notice" hidden>
      <span>Ton e-mail n’est pas vérifié.</span>
      <button id="sendVerify" class="ln-btn">Envoyer le lien</button>
      <button id="refreshAuth" class="ln-btn">Rafraîchir</button>
    </div>

    <!-- Edition -->
    <section id="editSection" class="panel" hidden>
      <div class="row">
        <div>
          <img id="myAvatar" class="avatar" alt="Photo de profil" />
          <div class="field">
            <input type="file" id="fileInput" accept="image/*" />
            <button id="btnUpload" class="ln-btn">Changer la photo</button>
          </div>
        </div>
        <div>
          <div class="field"><label>Nom</label><input id="nameInput" maxlength="30" /></div>
          <div class="field"><label>Âge</label><input id="ageInput" type="number" min="18" max="99" /></div>
          <div class="field">
            <label>Genre</label>
            <select id="genderInput"><option value="">—</option><option value="F">Femme</option><option value="M">Homme</option><option value="O">Autre</option></select>
          </div>
          <div class="field"><label>Ville</label><input id="cityInput" placeholder="ex. Paris" /></div>
          <div class="field"><label>Bio</label><textarea id="bioInput" rows="4" placeholder="Parle un peu de toi…"></textarea></div>
          <div class="actions">
            <button id="saveBtn" class="ln-btn primary">Enregistrer</button>
            <a class="ln-btn" href="/conversations.html">Mes conversations</a>
          </div>
        </div>
      </div>
    </section>

    <!-- Public -->
    <section id="publicSection" class="panel" hidden>
      <div class="row">
        <div><img id="pubAvatar" class="avatar" alt="Photo du profil" /></div>
        <div>
          <h2 id="publicName" style="margin:0 0 6px">—</h2>
          <div class="notice" id="pubMeta">Âge <span id="publicAge">—</span> · <span id="publicCity">—</span> · <span id="publicGender">—</span></div>
          <p id="publicBio">—</p>
          <div class="actions">
            <button id="publicMessageBtn" class="ln-btn primary">Message</button>
          </div>
        </div>
      </div>
    </section>
  </div>

  <!-- Config -->
  <script>
    window.firebaseConfig = {
      apiKey: "AIzaSyB_-cNA8bxqYCYUp3rUZs-VpiP4DX2wn3M",
      authDomain: "lovenow-officiel.firebaseapp.com",
      projectId: "lovenow-officiel",
      storageBucket: "lovenow-officiel.firebasestorage.app",
      messagingSenderId: "896585801571",
      appId: "1:896585801571:web:cdde87293291dc1900bd56",
      measurementId: "G-QGM25ND7LF"
    };
  </script>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-analytics.js";
    import { getAuth, onAuthStateChanged, sendEmailVerification } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc, updateDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";
    import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-storage.js";

    const app  = initializeApp(window.firebaseConfig);
    try { getAnalytics(app); } catch(e) {}
    const auth = getAuth(app);
    const db   = getFirestore(app);
    const st   = getStorage(app);

    document.getElementById('backLink')?.addEventListener('click',(e)=>{
      e.preventDefault();
      if(history.length>1) history.back(); else location.href='/';
    });

    const emailBanner = document.getElementById('emailBanner');
    const sendVerify  = document.getElementById('sendVerify');
    const refreshAuth = document.getElementById('refreshAuth');

    const editSection   = document.getElementById('editSection');
    const publicSection = document.getElementById('publicSection');

    const params   = new URLSearchParams(location.search);
    const targetId = params.get('uid');

    onAuthStateChanged(auth, async (user)=>{
      if(!user){ location.href='/login.html'; return; }

      emailBanner.hidden = user.emailVerified;
      sendVerify.onclick = async ()=>{ await sendEmailVerification(user); alert('E-mail de vérification envoyé.'); };
      refreshAuth.onclick = ()=> location.reload();

      const viewingOwn = !targetId || targetId === user.uid;
      if(viewingOwn){
        editSection.hidden = false; publicSection.hidden = true;
        const meRef = doc(db,'profiles', user.uid);
        const snap  = await getDoc(meRef);
        const data  = snap.exists() ? snap.data() : {};

        const nameInput = document.getElementById('nameInput');
        const ageInput  = document.getElementById('ageInput');
        const bioInput  = document.getElementById('bioInput');
        const cityInput = document.getElementById('cityInput');
        const genderInput = document.getElementById('genderInput');
        const myAvatar = document.getElementById('myAvatar');

        nameInput.value = data.name ?? '';
        ageInput.value  = data.age ?? '';
        bioInput.value  = data.bio ?? '';
        cityInput.value = data.city ?? '';
        genderInput.value = data.gender ?? '';
        myAvatar.src = data.photoUrl || 'https://images.unsplash.com/photo-1494790108377-be9c29b29330?w=1200&auto=format&fit=crop';

        document.getElementById('saveBtn')?.addEventListener('click', async ()=>{
          const payload = {
            name: nameInput.value.trim() || null,
            age: ageInput.value ? Number(ageInput.value) : null,
            bio: bioInput.value.trim() || null,
            city: cityInput.value.trim() || null,
            gender: genderInput.value || null,
            lastActive: serverTimestamp()
          };
          if(snap.exists()) await updateDoc(meRef, payload);
          else await setDoc(meRef, payload);
          alert('Profil enregistré.');
        });

        const fileInput = document.getElementById('fileInput');
        document.getElementById('btnUpload')?.addEventListener('click', async ()=>{
          const file = fileInput.files?.[0];
          if(!file){ alert('Choisis une image.'); return; }
          const storageRef = ref(st, `profilePhotos/${user.uid}.jpg`);
          await uploadBytes(storageRef, file);
          const url = await getDownloadURL(storageRef);
          await setDoc(meRef, { photoUrl: url, lastActive: serverTimestamp() }, { merge:true });
          myAvatar.src = url;
          alert('Photo mise à jour.');
        });

        if(location.hash==='#chat'){ alert("Astuce : choisis un profil dans Découvrir puis clique sur Message pour ouvrir une conversation."); }
      } else {
        editSection.hidden = true; publicSection.hidden = false;
        const pubRef = doc(db,'profiles', targetId);
        const snap = await getDoc(pubRef);
        const p = snap.exists() ? snap.data() : {};
        document.getElementById('pubAvatar').src = p.photoUrl || 'https://images.unsplash.com/photo-1527980965255-d3b416303d12?q=80&w=1200&auto=format&fit=crop';
        document.getElementById('publicName').textContent = p.name ?? '—';
        document.getElementById('publicAge').textContent  = p.age ?? '—';
        document.getElementById('publicCity').textContent = p.city ?? '—';
        document.getElementById('publicGender').textContent = p.gender ?? '—';
        document.getElementById('publicBio').textContent  = p.bio ?? '—';

        document.getElementById('publicMessageBtn')?.addEventListener('click', ()=>{
          if(!auth.currentUser.emailVerified){ alert('Valide ton e-mail pour envoyer des messages.'); return; }
          const cid = [auth.currentUser.uid, targetId].sort().join('_');
          location.href = `/conversations.html?cid=${cid}`;
        });
      }
    });
  </script>
</body>
</html>