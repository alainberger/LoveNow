<!doctype html>
<html lang="fr" data-theme="light">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>LoveNow — Connexion & Inscription</title>
  <meta name="description" content="Connectez-vous ou créez un compte LoveNow. Réservé aux 18 ans et plus.">
  <link rel="canonical" href="https://lovenow.netlify.app/login">
  <meta property="og:title" content="LoveNow — Connexion & Inscription">
  <meta property="og:description" content="Créez un compte LoveNow (18+).">
  <meta property="og:url" content="https://lovenow.netlify.app/login">
  <meta property="og:image" content="/assets/og-default.jpg">
  <meta name="twitter:card" content="summary_large_image">
  <style>
    body{ margin:0; font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Arial; color:#111 }
    .wrap{ max-width:720px; margin:0 auto; padding:24px 16px }
    h1{ margin:.3em 0 }
    .tabs{ display:flex; gap:8px; margin:8px 0 16px }
    .tab{ padding:.5rem .9rem; border:1px solid #ddd; border-radius:10px; background:#f7f7f7 }
    .tab.active{ background:#0AAEEF; color:#fff; border-color:#0AAEEF }
    label{ font-weight:600; display:block; margin-top:10px }
    input{ width:100%; padding:.6rem .7rem; border:1px solid #ddd; border-radius:10px }
    .btn{ margin-top:12px; display:inline-block; padding:.65rem 1rem; border-radius:10px; border:1px solid transparent; background:#0AAEEF; color:#fff; font-weight:600 }
    :focus{ outline:3px auto; outline-offset:2px }
    .error{ color:#b00020; margin-top:6px; min-height:1.4em }
  </style>
</head>
<body>
  <div class="wrap">
    <a href="/" aria-label="Retour accueil">← Accueil</a>
    <h1>Connexion / Inscription</h1>
    <div class="tabs" role="tablist" aria-label="Choix du mode">
      <button id="tab-login" class="tab" role="tab" aria-controls="panel-login">Connexion</button>
      <button id="tab-signup" class="tab" role="tab" aria-controls="panel-signup">Inscription</button>
    </div>

    <section id="panel-login" role="tabpanel" aria-labelledby="tab-login" hidden>
      <form id="loginForm">
        <label for="lemail">Email</label>
        <input id="lemail" type="email" required autocomplete="username">
        <label for="lpass">Mot de passe</label>
        <input id="lpass" type="password" required minlength="6" autocomplete="current-password">
        <div id="loginError" class="error" role="status" aria-live="polite"></div>
        <button class="btn" id="btnLogin" type="submit">Se connecter</button>
      </form>
    </section>

    <section id="panel-signup" role="tabpanel" aria-labelledby="tab-signup" hidden>
      <form id="signupForm">
        <label for="semail">Email</label>
        <input id="semail" type="email" required autocomplete="email">
        <label for="spass">Mot de passe (≥ 6)</label>
        <input id="spass" type="password" required minlength="6" autocomplete="new-password">
        <label for="sage">Âge (18+)</label>
        <input id="sage" type="number" inputmode="numeric" min="18" max="99" placeholder="18" required aria-describedby="ageHelp">
        <small id="ageHelp" class="muted">Le service est réservé aux personnes de 18 ans et plus.</small>
        <div id="signupError" class="error" role="status" aria-live="polite"></div>
        <button class="btn" id="btnSignup" type="submit">Créer un compte</button>
      </form>
    </section>
  </div>

  <script src="/config.js"></script>
  <script type="module">
    import { signUp, signIn } from '/js/firebase.js';
    import { getRecaptchaToken } from '/js/recaptcha.js';

    // Onglets + hash
    const tLogin = document.getElementById('tab-login');
    const tSignup = document.getElementById('tab-signup');
    const pLogin = document.getElementById('panel-login');
    const pSignup = document.getElementById('panel-signup');
    function show(which){ const s=(which==='signup'); tSignup.classList.toggle('active',s); tLogin.classList.toggle('active',!s); pSignup.hidden=!s; pLogin.hidden=s; }
    function fromHash(){ show(location.hash==='#signup'?'signup':'login'); }
    window.addEventListener('hashchange', fromHash); fromHash();

    const setLoading = (btn,on)=>{ btn.disabled=on; btn.dataset.t ??= btn.textContent; btn.textContent = on?'Chargement…':btn.dataset.t; };

    // Signup
    document.getElementById('signupForm').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const btn = document.getElementById('btnSignup'); setLoading(btn,true);
      const err = document.getElementById('signupError'); err.textContent='';
      try{
        const age = parseInt(document.getElementById('sage').value,10);
        if(!Number.isFinite(age) || age < 18){ err.textContent='Vous devez avoir 18 ans ou plus pour créer un compte.'; document.getElementById('sage').focus(); return; }

        // reCAPTCHA (optionnel selon config + Function)
        const token = await getRecaptchaToken('signup');
        if(token){
          try{
            const r = await fetch('/.netlify/functions/verify-recaptcha',{ method:'POST', headers:{'content-type':'application/json'}, body:JSON.stringify({ token }) });
            const j = await r.json().catch(()=>({success:false}));
            if(!j.success){ err.textContent='reCAPTCHA refusé (ou indisponible).'; return; }
          }catch{ err.textContent='Serveur reCAPTCHA indisponible.'; return; }
        }
        await signUp(document.getElementById('semail').value.trim(), document.getElementById('spass').value, { age });
        location.href='/profile.html';
      }catch(ex){ err.textContent = ex?.message || 'Erreur inconnue'; }
      finally{ setLoading(btn,false); }
    });

    // Login
    document.getElementById('loginForm').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const btn = document.getElementById('btnLogin'); setLoading(btn,true);
      const err = document.getElementById('loginError'); err.textContent='';
      try{
        const token = await getRecaptchaToken('login');
        if(token){
          try{
            const r = await fetch('/.netlify/functions/verify-recaptcha',{ method:'POST', headers:{'content-type':'application/json'}, body:JSON.stringify({ token }) });
            const j = await r.json().catch(()=>({success:false}));
            if(!j.success){ err.textContent='reCAPTCHA refusé (ou indisponible).'; return; }
          }catch{ err.textContent='Serveur reCAPTCHA indisponible.'; return; }
        }
        await signIn(document.getElementById('lemail').value.trim(), document.getElementById('lpass').value);
        location.href='/';
      }catch(ex){ err.textContent = ex?.message || 'Erreur inconnue'; }
      finally{ setLoading(btn,false); }
    });
  </script>
</body>
</html>