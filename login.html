<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>LoveNow — Connexion / Inscription</title>
<link rel="preload" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" as="style" onload="this.rel='stylesheet'">
<style>
  :root{--bg:#0f1115;--card:#171922;--muted:#aab1c3;--text:#e9edf6;--brand:#ff2d55;--brand2:#7a5cf0}
  body{margin:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui}
  .wrap{max-width:720px;margin:0 auto;padding:20px}
  .tabs{display:flex;gap:8px;margin:8px 0 16px}
  .tab{padding:.6rem .9rem;border-radius:.6rem;background:#1a1e2b;border:1px solid #27314a;cursor:pointer}
  .tab[aria-selected="true"]{background:linear-gradient(135deg,var(--brand),var(--brand2));border:none}
  input,select{width:100%;padding:.7rem;border-radius:.6rem;background:#0f1115;border:1px solid #2b2f44;color:var(--text)}
  label{display:block;margin:10px 0 6px;color:var(--muted)}
  .btn{display:inline-flex;align-items:center;justify-content:center;padding:.7rem 1rem;border-radius:.6rem;background:#232739;border:1px solid #2b2f44;cursor:pointer}
  .btn-primary{background:linear-gradient(135deg,var(--brand),var(--brand2));border:none}
  .card{background:var(--card);border:1px solid #202334;border-radius:.9rem;padding:16px}
  .muted{color:var(--muted)}
  .banner{background:#1a1e2b;border:1px solid #27314a;border-radius:.8rem;padding:.6rem .8rem;margin:12px 0;display:flex;gap:8px;justify-content:space-between;align-items:center}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:8px}
  @media (max-width:560px){.row{grid-template-columns:1fr}}
</style>

<!-- ta config publique -->
<script src="config.js"></script>
</head>
<body>
  <div class="wrap">
    <a class="btn" href="index.html">← Accueil</a>
    <h1>Connexion / Inscription</h1>

    <!-- bannière vérif -->
    <div class="banner" id="verifyBanner" hidden>
      <div>E-mail <span id="who" class="muted"></span> non vérifié.</div>
      <div style="display:flex;gap:8px">
        <button id="btnResend" class="btn">Envoyer le lien</button>
        <a class="btn" href="index.html">Accueil</a>
      </div>
    </div>

    <!-- onglets -->
    <div class="tabs" role="tablist" aria-label="Choisir une action">
      <button id="tab-login" role="tab" class="tab" aria-selected="true">Connexion</button>
      <button id="tab-signup" role="tab" class="tab" aria-selected="false">Inscription</button>
    </div>

    <!-- PANNEAU CONNEXION (visible par défaut sans JS) -->
    <div id="panel-login" role="tabpanel" class="card">
      <form id="login">
        <label for="liEmail">Email</label>
        <input id="liEmail" type="email" required autocomplete="username">
        <label for="liPass">Mot de passe</label>
        <input id="liPass" type="password" required autocomplete="current-password" minlength="6">
        <div style="margin-top:12px;display:flex;gap:8px">
          <button class="btn btn-primary" type="submit">Se connecter</button>
          <a class="btn" href="index.html">Accueil</a>
        </div>
      </form>
    </div>

    <!-- PANNEAU INSCRIPTION -->
    <div id="panel-signup" role="tabpanel" class="card" hidden>
      <form id="signup">
        <label for="suEmail">Email</label>
        <input id="suEmail" type="email" required autocomplete="email">
        <label for="suPass">Mot de passe (≥ 6 caractères)</label>
        <input id="suPass" type="password" required minlength="6" autocomplete="new-password">
        <label for="suName">Nom / Pseudo</label>
        <input id="suName" type="text" required>
        <div class="row">
          <div>
            <label for="suAge">Âge</label>
            <input id="suAge" type="number" min="18" max="99" required>
          </div>
          <div>
            <label for="suCity">Ville</label>
            <input id="suCity" type="text" required>
          </div>
        </div>
        <label for="suGender">Genre</label>
        <select id="suGender">
          <option value="F">Femme</option><option value="M">Homme</option><option value="O">Autre</option>
        </select>
        <div style="margin-top:12px;display:flex;gap:8px">
          <button class="btn btn-primary" type="submit">Créer mon compte</button>
          <a class="btn" href="index.html">Accueil</a>
        </div>
      </form>
    </div>

    <div style="margin-top:16px">
      <button id="btnLogout" class="btn">Se déconnecter</button>
      <span class="muted">· Après vérification e-mail, reviens ici puis « Accueil ».</span>
    </div>
  </div>

  <!-- Firebase / AppCheck / Firestore (module) -->
  <script type="module">
    const cfg = window.APP_CONFIG?.firebase;
    const siteKey = window.APP_CONFIG?.appCheck?.recaptchaV3SiteKey;

    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, updateProfile, sendEmailVerification, signOut } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
    import { initializeAppCheck, ReCaptchaV3Provider } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app-check.js";
    import { getFirestore, doc, setDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    // init
    const app = initializeApp(cfg);
    if (siteKey) initializeAppCheck(app, { provider:new ReCaptchaV3Provider(siteKey), isTokenAutoRefreshEnabled:true });
    const auth = getAuth(app);
    const db   = getFirestore(app);

    const $ = s=>document.querySelector(s);
    const showTab=(t)=>{
      $("#tab-login").setAttribute("aria-selected", t==="login");
      $("#panel-login").hidden = (t!=="login");
      $("#tab-signup").setAttribute("aria-selected", t==="signup");
      $("#panel-signup").hidden = (t!=="signup");
    };
    // par défaut : on affiche login ; #signup ouvre l’onglet inscription
    showTab(location.hash==="#signup" ? "signup" : "login");
    $("#tab-login").addEventListener("click",()=>showTab("login"));
    $("#tab-signup").addEventListener("click",()=>showTab("signup"));

    // bannière vérif
    onAuthStateChanged(auth,(user)=>{
      const b=$("#verifyBanner");
      if(user && !user.emailVerified){ b.hidden=false; $("#who").textContent=user.email||""; }
      else { b.hidden=true; $("#who").textContent=""; }
    });

    // inscription
    $("#signup").addEventListener("submit", async (e)=>{
      e.preventDefault();
      const email=$("#suEmail").value.trim();
      const pass=$("#suPass").value;
      const name=$("#suName").value.trim();
      const age = Number($("#suAge").value)||null;
      const city=$("#suCity").value.trim();
      const gender=$("#suGender").value;

      try{
        const {user}=await createUserWithEmailAndPassword(auth,email,pass);
        await updateProfile(user,{ displayName:name });
        await setDoc(doc(db,"profiles", user.uid), {
          uid:user.uid, email:user.email||"",
          name, age, city, gender,
          bio:"", photoURL:"",
          createdAt:serverTimestamp(), updatedAt:serverTimestamp()
        }, { merge:true });

        try{
          const actionCodeSettings={ url:"https://lovenow.netlify.app/login.html?verified=1", handleCodeInApp:false };
          await sendEmailVerification(user, actionCodeSettings);
        }catch{}

        alert("Compte créé. Vérifie ton e-mail pour discuter.");
        location.href="/";
      }catch(err){
        console.error(err);
        alert("Inscription impossible : "+(err?.message||""));
      }
    });

    // connexion
    $("#login").addEventListener("submit", async (e)=>{
      e.preventDefault();
      try{
        await signInWithEmailAndPassword(auth, $("#liEmail").value.trim(), $("#liPass").value);
        location.href="/";
      }catch(err){
        console.error(err);
        alert("Connexion impossible : "+(err?.message||""));
      }
    });

    // renvoi lien vérif
    $("#btnResend").addEventListener("click", async ()=>{
      const u=auth.currentUser; if(!u) return alert("Connecte-toi d’abord.");
      try{
        const actionCodeSettings={ url:"https://lovenow.netlify.app/login.html?verified=1", handleCodeInApp:false };
        await sendEmailVerification(u, actionCodeSettings);
        alert("Lien envoyé ✅");
      }catch{ alert("Échec envoi lien"); }
    });

    // logout
    $("#btnLogout").addEventListener("click", async ()=>{ await signOut(auth); alert("Déconnecté"); location.href="/"; });
  </script>

  <!-- (optionnel) snippet Crisp si tu veux le chat ici aussi 
  <script type="text/javascript">window.$crisp=[];window.CRISP_WEBSITE_ID="TON_ID_CRISP";(function(){d=document;s=d.createElement("script");s.src="https://client.crisp.chat/l.js";s.async=1;d.getElementsByTagName("head")[0].appendChild(s);})();</script>
  -->
</body>
</html>