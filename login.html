<!doctype html>
<html lang="fr" data-theme="light">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>LoveNow — Connexion / Inscription</title>
<link rel="stylesheet" href="/styles/tokens.css">
<link rel="stylesheet" href="/styles/components.css">
<script src="/js/features.js"></script>
<script src="config.js"></script>
<script defer src="/js/ui.js"></script>
<style>
  *{box-sizing:border-box}
  html,body{margin:0;min-height:100%;background:var(--bg);color:var(--text);font-family:'Manrope',system-ui,sans-serif}
  main{padding-bottom:72px}
  .auth-shell{width:min(720px,92vw);margin:72px auto 96px;display:grid;gap:24px}
  .auth-card{display:grid;gap:18px}
  .tabs{display:flex;gap:12px;background:rgba(255,255,255,0.7);padding:6px;border-radius:999px;justify-content:space-between}
  [data-theme="dark"] .tabs{background:rgba(29,28,54,0.8)}
  .tab{flex:1;display:inline-flex;align-items:center;justify-content:center;padding:.65rem 1rem;border-radius:999px;border:none;background:transparent;font-weight:600;color:var(--muted);cursor:pointer;transition:background 160ms ease,color 160ms ease,box-shadow 160ms ease}
  .tab[aria-selected="true"]{background:linear-gradient(135deg,var(--brand),var(--brand-2));color:#fff;box-shadow:0 18px 36px -24px rgba(255,61,138,0.6)}
  .auth-actions{display:flex;gap:12px;flex-wrap:wrap;margin-top:12px}
  .auth-footer{font-size:0.9rem;color:var(--muted)}
  .auth-footer strong{color:var(--brand)}
  #authStatus{min-height:1.2em;margin-top:4px}
  #authStatus[data-tone="success"]{color:#25694a}
  #authStatus[data-tone="error"]{color:#7e2f32}
  #authStatus[data-tone="warn"]{color:#7a5123}
  .form-grid{display:grid;gap:18px}
  .row{display:grid;gap:18px;grid-template-columns:repeat(auto-fit,minmax(220px,1fr))}
  .logout-wrap{display:flex;justify-content:flex-end}
</style>

  <!-- ta config publique -->
  <script src="config.js"></script>
  </head>
<body>
  <header class="site-header">
    <div class="wrap nav-bar">
      <a class="brand" href="/" aria-label="LoveNow">
        <img src="/assets/brand/logo.svg" alt="Logo LoveNow" />
        <span>LoveNow</span>
      </a>
      <button class="nav-toggle" type="button" aria-expanded="false" aria-controls="primary-menu" data-toggle-nav>
        <span></span>
        <span class="sr-only">Ouvrir le menu</span>
      </button>
      <nav id="primary-menu" class="site-menu" aria-label="Navigation principale">
        <a href="/#discover">Découvrir</a>
        <a href="/matchmaking.html">Matching</a>
        <a href="/conversations.html">Conversations</a>
        <a href="/profile.html">Mon profil</a>
        <a href="/settings.html">Paramètres</a>
        <a href="/privacy.html">Confidentialité</a>
        <a href="/cgu.html">CGU</a>
        <div class="session-slot" id="header-session"></div>
      </nav>
      <button class="mode-toggle" type="button" data-toggle-theme aria-label="Basculer le mode d'affichage">
        <svg aria-hidden="true" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6">
          <path d="M12 3a1 1 0 0 1 1 1v1.1a1 1 0 0 1-1 1h-.2a1 1 0 0 1-1-.8 3 3 0 0 0-2.9 2.9 1 1 0 0 1-.8 1H6a1 1 0 0 1-1-1A7 7 0 0 1 12 3Z" />
          <path d="M7 12a5 5 0 1 0 10 0 5 5 0 0 0-10 0Z" />
        </svg>
        <span>Mode</span>
      </button>
    </div>
  </header>

  <main>
    <div class="auth-shell">
      <div id="verifyBanner" class="banner" hidden>
        <div>
          <strong>E-mail non vérifié.</strong> Vérifie ton adresse pour accéder à toutes les fonctionnalités.
        </div>
        <div class="actions">
          <button id="btnResend" class="btn">Renvoyer le lien</button>
          <button id="btnRefresh" class="btn ghost">Rafraîchir</button>
        </div>
      </div>
      <section class="page-card auth-card">
        <h1>Connexion / Inscription</h1>
        <div class="tabs" role="tablist" aria-label="Choisir une action">
          <button id="tab-login" role="tab" class="tab" aria-selected="true">Connexion</button>
          <button id="tab-signup" role="tab" class="tab" aria-selected="false">Inscription</button>
        </div>

        <div id="authStatus" class="auth-footer" role="status" aria-live="polite"></div>

        <div id="panel-login" role="tabpanel">
          <form id="login" class="form-grid">
            <div>
              <label for="liEmail">Email</label>
              <input id="liEmail" type="email" required autocomplete="username">
            </div>
            <div>
              <label for="liPass">Mot de passe</label>
              <input id="liPass" type="password" required autocomplete="current-password" minlength="6">
            </div>
            <div class="auth-actions">
              <button class="btn" type="submit">Se connecter</button>
              <a class="btn ghost" href="/">Retour à l’accueil</a>
            </div>
          </form>
        </div>

        <div id="panel-signup" role="tabpanel" hidden>
          <form id="signup" class="form-grid">
            <div>
              <label for="suEmail">Email</label>
              <input id="suEmail" type="email" required autocomplete="email">
            </div>
            <div>
              <label for="suPass">Mot de passe (≥ 6 caractères)</label>
              <input id="suPass" type="password" required minlength="6" autocomplete="new-password">
            </div>
            <div>
              <label for="suName">Nom / Pseudo</label>
              <input id="suName" type="text" required>
            </div>
            <div class="row">
              <div>
                <label for="suAge">Âge</label>
                <input id="suAge" type="number" min="18" max="99" required>
              </div>
              <div>
                <label for="suCity">Ville</label>
                <input id="suCity" type="text" required>
              </div>
            </div>
            <div>
              <label for="suGender">Genre</label>
              <select id="suGender">
                <option value="F">Femme</option><option value="M">Homme</option><option value="O">Autre</option>
              </select>
            </div>
            <div class="auth-actions">
              <button class="btn" type="submit">Créer mon compte</button>
              <a class="btn ghost" href="/">Retour à l’accueil</a>
            </div>
          </form>
        </div>

        <p class="auth-footer">Besoin d’aide ? <strong>support@lovenow.app</strong></p>
      </section>

      <div class="auth-actions logout-wrap">
        <button id="btnLogout" class="btn ghost" type="button" hidden>Se déconnecter</button>
      </div>
    </div>
  </main>

  <footer>
    <div class="wrap footer-card">
      <small>© LoveNow — Espace membre</small>
      <div class="footer-links">
        <a href="/privacy.html">Confidentialité</a>
        <a href="/cgu.html">CGU</a>
      </div>
    </div>
  </footer>

  <!-- Firebase / AppCheck / Firestore (module) -->
  <script type="module">
    import {
      setupFirebase,
      saveUserProfile,
      ensureUserDocuments,
      renderVerifyBanner,
      applySessionToHeader,
      safeSignOut,
    } from '/js/app-core.js';

    const $ = (s) => document.querySelector(s);
    const tabLogin = $('#tab-login');
    const tabSignup = $('#tab-signup');
    const panelLogin = $('#panel-login');
    const panelSignup = $('#panel-signup');
    const statusEl = $('#authStatus');
    const banner = $('#verifyBanner');
    const btnResend = $('#btnResend');
    const btnRefresh = $('#btnRefresh');
    const headerSlot = document.getElementById('header-session');
    const logoutBtn = $('#btnLogout');
    const loginForm = $('#login');
    const signupForm = $('#signup');

    const setStatus = (message, tone = 'info') => {
      if (!statusEl) return;
      statusEl.textContent = message;
      statusEl.dataset.tone = tone;
    };

    const showTab = (tab) => {
      const isLogin = tab === 'login';
      tabLogin?.setAttribute('aria-selected', isLogin ? 'true' : 'false');
      panelLogin.hidden = !isLogin;
      tabSignup?.setAttribute('aria-selected', !isLogin ? 'true' : 'false');
      panelSignup.hidden = isLogin;
    };

    const tabFromHash = () => {
      const hash = (location.hash || '').toLowerCase();
      if (hash === '#signup' || hash === '#sign_up') return 'signup';
      return 'login';
    };

    showTab(tabFromHash());
    window.addEventListener('hashchange', () => showTab(tabFromHash()));
    tabLogin?.addEventListener('click', () => {
      location.hash = '#log_in';
      showTab('login');
    });
    tabSignup?.addEventListener('click', () => {
      location.hash = '#signup';
      showTab('signup');
    });

    (async () => {
      const { auth, db, authModule, firestoreModule } = await setupFirebase();
      const {
        onAuthStateChanged,
        createUserWithEmailAndPassword,
        signInWithEmailAndPassword,
        updateProfile,
        sendEmailVerification,
        signOut,
        reload,
      } = authModule;
      const { serverTimestamp } = firestoreModule;

      renderVerifyBanner({
        banner,
        resendBtn: btnResend,
        refreshBtn: btnRefresh,
        onResend: async () => {
          if (!auth.currentUser) return;
          await sendEmailVerification(auth.currentUser);
          setStatus('Lien de vérification envoyé ✅', 'success');
        },
        onRefresh: async () => {
          if (!auth.currentUser) return;
          await reload(auth.currentUser);
          if (auth.currentUser.emailVerified) {
            banner.hidden = true;
            setStatus('Adresse vérifiée, merci !', 'success');
          }
        },
      });

      onAuthStateChanged(auth, async (user) => {
        if (user) {
          applySessionToHeader(headerSlot, user, {
            onSignOutClick: (event) => safeSignOut(auth, signOut, event?.currentTarget || logoutBtn),
          });
          logoutBtn.hidden = false;
          logoutBtn.disabled = false;
          await ensureUserDocuments(db, firestoreModule, user);
          if (user.emailVerified) {
            banner.hidden = true;
            setStatus('Connexion réussie. Tu peux accéder à LoveNow.', 'success');
          } else {
            banner.hidden = false;
            setStatus('Vérifie ton e-mail pour débloquer toutes les fonctionnalités.', 'warn');
          }
        } else {
          applySessionToHeader(headerSlot, null, { onSignOutClick: () => {} });
          banner.hidden = true;
          logoutBtn.hidden = true;
          setStatus('Connecte-toi ou crée ton compte pour continuer.');
        }
      });

      loginForm?.addEventListener('submit', async (event) => {
        event.preventDefault();
        const email = $('#liEmail')?.value.trim();
        const password = $('#liPass')?.value;
        if (!email || !password) return;
        const submitBtn = loginForm.querySelector('button[type="submit"]');
        submitBtn.disabled = true;
        setStatus('Connexion en cours…');
        try {
          await signInWithEmailAndPassword(auth, email, password);
          setStatus('Connexion réussie ✅', 'success');
          location.href = '/';
        } catch (err) {
          console.error(err);
          setStatus('Connexion impossible : ' + (err?.message || 'vérifie tes identifiants'), 'error');
        } finally {
          submitBtn.disabled = false;
        }
      });

      signupForm?.addEventListener('submit', async (event) => {
        event.preventDefault();
        const email = $('#suEmail')?.value.trim();
        const password = $('#suPass')?.value;
        const name = $('#suName')?.value.trim();
        const age = Number($('#suAge')?.value) || null;
        const city = $('#suCity')?.value.trim();
        const gender = $('#suGender')?.value;
        if (!email || !password || !name) return;
        const submitBtn = signupForm.querySelector('button[type="submit"]');
        submitBtn.disabled = true;
        setStatus('Création du compte…');
        try {
          const { user } = await createUserWithEmailAndPassword(auth, email, password);
          await updateProfile(user, { displayName: name });
          await saveUserProfile(db, firestoreModule, user.uid, {
            uid: user.uid,
            email,
            emailVerified: false,
            name,
            displayName: name,
            age,
            gender,
            city,
            bio: '',
            photoURL: user.photoURL || '',
            createdAt: serverTimestamp(),
          });
          await sendEmailVerification(user);
          setStatus('Compte créé. Vérifie ton e-mail pour continuer ✅', 'success');
          location.hash = '#log_in';
        } catch (err) {
          console.error(err);
          setStatus('Inscription impossible : ' + (err?.message || 'réessaye plus tard'), 'error');
        } finally {
          submitBtn.disabled = false;
        }
      });

      logoutBtn?.addEventListener('click', async () => {
        await safeSignOut(auth, signOut, logoutBtn);
      });
    })();
  </script>
  <script>loadCrispIfEnabled();</script>

</body>
</html>