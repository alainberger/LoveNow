<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>LoveNow — Connexion</title>
  <meta name="description" content="Connectez-vous à LoveNow pour discuter en privé et rencontrer des personnes proches.">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#0b0c10; --card:#151921; --line:#222a35; --txt:#f6f8fa; --muted:#aeb6c2;
      --acc:#ff4d6d; --acc2:#8f51ea; --acc3:#ff6bb5; --danger:#ff6464; --warn:#ffcf40;
    }
    *{box-sizing:border-box}
    html,body{margin:0;background:
      radial-gradient(1200px 600px at -10% -10%, rgba(255,77,109,.15), transparent 60%),
      radial-gradient(900px 500px at 110% -10%, rgba(143,81,234,.18), transparent 60%),
      linear-gradient(180deg, #0b0c10, #0d1016); color:var(--txt); font-family:'Poppins',system-ui,Segoe UI,Arial,sans-serif}
    a{color:var(--acc3);text-decoration:none}
    .wrap{max-width:900px;margin:0 auto;padding:16px 18px}
    header{position:sticky;top:0;z-index:20;backdrop-filter:saturate(140%) blur(8px);
      background:linear-gradient(180deg,rgba(0,0,0,.7),rgba(0,0,0,.45));border-bottom:1px solid var(--line)}
    .row{display:flex;gap:14px;align-items:center;justify-content:space-between}
    .logo{font-weight:800;color:var(--acc)}
    .nav-btn{border:1px solid #ffffffaa;padding:8px 14px;border-radius:999px;background:none;color:#fff;cursor:pointer}
    .nav-btn:hover{background:#fff;color:#000}
    .hero{display:grid;place-items:center;min-height:30vh;text-align:center;padding:36px 18px}
    .hero h1{font-size:clamp(26px,5.5vw,40px);margin:6px 0 10px;font-weight:800}
    .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:18px}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    @media(max-width:900px){.grid{grid-template-columns:1fr}}
    .form{display:grid;gap:10px}
    .form input{width:100%;border-radius:10px;border:1px solid var(--line);background:#0f1320;color:#fff;padding:10px}
    .form button{border:0;border-radius:10px;padding:12px 16px;background:var(--acc);color:#000;font-weight:800;cursor:pointer}
    .tabs{display:flex;gap:8px;margin-bottom:10px}
    .tabs button{border:1px solid var(--line);background:#0f1320;color:#fff;border-radius:10px;padding:8px 12px;cursor:pointer}
    .tabs button.active{outline:2px solid var(--acc)}
    .muted{color:var(--muted)}
    .banner{display:none;background:#201a00;color:#ffe58f;border:1px solid #665500;padding:10px;border-radius:10px;margin:10px 0}
    .btn-small{border:0;background:#ffcf40;color:#000;border-radius:8px;padding:6px 10px;font-weight:800;cursor:pointer;margin-left:6px}
    #toast{position:fixed;left:50%;transform:translateX(-50%);bottom:18px;background:#000d;border:1px solid var(--line);
      padding:10px 14px;border-radius:12px;display:none;z-index:90;min-width:240px;text-align:center}
    footer{padding:24px 18px;border-top:1px solid var(--line);text-align:center;color:var(--muted);font-size:14px}
  </style>
</head>
<body>
  <header>
    <div class="wrap row">
      <div class="logo">💘 LoveNow</div>
      <nav>
        <a href="/" class="nav-btn">Accueil</a>
      </nav>
    </div>
  </header>

  <main class="wrap">
    <section class="hero">
      <div>
        <h1>Connexion / Inscription</h1>
        <p class="muted">Reprenez vos conversations et découvrez des profils proches.</p>
      </div>
    </section>

    <section class="grid">
      <div class="card">
        <div class="tabs">
          <button data-tab="login" class="active">Connexion</button>
          <button data-tab="signup">Inscription</button>
        </div>

        <div id="paneLogin">
          <form id="loginForm" class="form">
            <label>Email <input id="liEmail" type="email" required autocomplete="email"></label>
            <label>Mot de passe <input id="liPass" type="password" minlength="6" required autocomplete="current-password"></label>
            <button type="submit" id="btnLogin">Se connecter</button>
            <button type="button" id="btnForgot" class="nav-btn" style="margin-top:8px">Mot de passe oublié</button>
          </form>
        </div>

        <div id="paneSignup" style="display:none">
          <form id="signupForm" class="form">
            <label>Email <input id="suEmail" type="email" required autocomplete="email"></label>
            <label>Mot de passe <input id="suPass" type="password" minlength="6" required autocomplete="new-password"></label>
            <label>Nom <input id="suName" maxlength="30" required></label>
            <label>Âge <input id="suAge" type="number" min="18" max="100" required></label>
            <label>Bio <input id="suBio" maxlength="120" placeholder="Quelques mots sur vous (optionnel)"></label>
            <button type="submit" id="btnSignup">Créer mon compte</button>
          </form>
        </div>
      </div>

      <div class="card">
        <h3>Vérification d’e-mail</h3>
        <p class="muted">Après inscription, validez votre adresse e-mail pour envoyer des messages.</p>
        <div id="verifyBox" class="banner">
          Votre e-mail n’est pas vérifié.
          <button id="btnSendVerify" class="btn-small">Envoyer le lien</button>
          <button id="btnRefreshVerify" class="btn-small">Rafraîchir</button>
        </div>
        <p class="muted">Besoin d’aide ? Consultez les <a href="/privacy.html">règles de confidentialité</a> et les <a href="/cgu.html">CGU</a>.</p>
      </div>
    </section>
  </main>

  <footer>
    © 2025 LoveNow — <a href="/mentions-legales.html">Mentions légales</a> · <a href="/privacy.html">Confidentialité</a> · <a href="/cgu.html">CGU</a>
  </footer>

  <div id="toast" role="status" aria-live="polite"></div>

  <script type="module">
    // UI helpers
    const $=(s,c=document)=>c.querySelector(s);
    const $$=(s,c=document)=>Array.from(c.querySelectorAll(s));
    const toast=(m,ms=2500)=>{const t=$("#toast");t.textContent=m;t.style.display="block";setTimeout(()=>t.style.display="none",ms)};
    const setTab=(w)=>{const L=$("#paneLogin"), S=$("#paneSignup"); L.style.display=w==="login"?"block":"none"; S.style.display=w==="signup"?"block":"none";
      $$("[data-tab]").forEach(b=>b.classList.toggle("active", b.dataset.tab===w)); };
    $$("[data-tab]").forEach(b=>b.addEventListener("click",()=>setTab(b.dataset.tab)));

    // Firebase CDN
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-analytics.js";
    import {
      getAuth,onAuthStateChanged,createUserWithEmailAndPassword,signInWithEmailAndPassword,
      sendPasswordResetEmail,sendEmailVerification,reload
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { initializeAppCheck, ReCaptchaV3Provider } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app-check.js";

    // Config (identiques à index.html)
    const firebaseConfig={
      apiKey:"AIzaSyB_-cNA8bxqYCYUp3rUZs-VpiP4DX2wn3M",
      authDomain:"lovenow-officiel.firebaseapp.com",
      projectId:"lovenow-officiel",
      storageBucket:"lovenow-officiel.firebasestorage.app",
      messagingSenderId:"896585801571",
      appId:"1:896585801571:web:cdde87293291dc1900bd56",
      measurementId:"G-QGM25ND7LF"
    };
    const RECAPTCHA_SITE_KEY="6LfjpsErAAAAAExN2IvBq-K475TeJooeNzl9liPD";

    const app=initializeApp(firebaseConfig); try{getAnalytics(app)}catch{}
    initializeAppCheck(app,{provider:new ReCaptchaV3Provider(RECAPTCHA_SITE_KEY),isTokenAutoRefreshEnabled:true});
    const auth=getAuth(app);

    const verifyBox=$("#verifyBox");
    const friendlyError=(e)=> e?.code?.includes("unauthorized-continue-uri")
      ? "Domaine de retour non autorisé (Firebase > Auth > Domaines autorisés)."
      : (e?.message||"Erreur");

    // Auth flows
    $("#loginForm").addEventListener("submit", async (e)=>{
      e.preventDefault();
      const email=$("#liEmail").value.trim(), pass=$("#liPass").value.trim();
      try{ await signInWithEmailAndPassword(auth,email,pass); toast("Connexion réussie"); location.href="/"; }
      catch(err){ toast(friendlyError(err)); }
    });

    $("#signupForm").addEventListener("submit", async (e)=>{
      e.preventDefault();
      const email=$("#suEmail").value.trim(), pass=$("#suPass").value.trim();
      const name=$("#suName").value.trim(), age=+$("#suAge").value, bio=$("#suBio").value.trim().slice(0,120);
      if(age<18){ toast("18+ requis"); return; }
      try{
        const cred=await createUserWithEmailAndPassword(auth,email,pass);
        // On ne crée pas le profil ici (côté index) pour rester léger. L’essentiel est la vérification e-mail.
        try{ await sendEmailVerification(cred.user, { url: window.location.origin + "/?verified=1", handleCodeInApp:false }); }
        catch(err){ if((err?.code||"").includes("unauthorized-continue-uri")) await sendEmailVerification(cred.user); }
        toast("Compte créé. Vérifiez votre e-mail ✉️");
        setTab("login");
      }catch(err){ toast(friendlyError(err)); }
    });

    $("#btnForgot").addEventListener("click", async ()=>{
      const email=$("#liEmail").value.trim(); if(!email){toast("Saisissez votre e-mail d’abord"); return;}
      try{
        try{ await sendPasswordResetEmail(auth,email,{ url: window.location.origin + "/?reset=1", handleCodeInApp:false }); }
        catch(err){ if((err?.code||"").includes("unauthorized-continue-uri")) await sendPasswordResetEmail(auth,email); }
        toast("Lien de réinitialisation envoyé.");
      }catch(err){ toast(friendlyError(err)); }
    });

    async function sendVerify(){ const u=auth.currentUser; if(!u){toast("Connectez-vous d’abord.");return;}
      try{ await sendEmailVerification(u,{ url: window.location.origin + "/?verified=1", handleCodeInApp:false }); }
      catch(err){ if((err?.code||"").includes("unauthorized-continue-uri")) await sendEmailVerification(u); else throw err; }
      toast("E-mail envoyé ✉️"); }
    async function refreshVerify(){ const u=auth.currentUser; if(!u) return; try{ await reload(u); updateVerifyBox(u); }catch{} }

    function updateVerifyBox(user){ verifyBox.style.display = user && !user.emailVerified ? "block" : "none"; }
    $("#btnSendVerify").addEventListener("click", sendVerify);
    $("#btnRefreshVerify").addEventListener("click", refreshVerify);

    onAuthStateChanged(auth, user=>{ updateVerifyBox(user); });
  </script>
</body>
</html>
