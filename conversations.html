<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>LoveNow ‚Äî Conversations</title>
  <meta name="description" content="Vos conversations priv√©es sur LoveNow.">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;800&display=swap" rel="stylesheet">
  <style>
    :root{--bg:#0b0c10;--line:#222a35;--txt:#f6f8fa;--muted:#aeb6c2;--acc:#ff4d6d}
    *{box-sizing:border-box} html,body{margin:0;background:
      radial-gradient(900px 450px at 15% 0%,rgba(255,77,109,.18),transparent 60%),
      radial-gradient(900px 450px at 85% 0%,rgba(143,81,234,.22),transparent 60%),
      linear-gradient(180deg,#0b0c10,#0d1016);color:var(--txt);font-family:'Poppins',system-ui}
    .wrap{max-width:1100px;margin:0 auto;padding:18px}
    header{display:flex;justify-content:space-between;align-items:center;padding:12px 0;border-bottom:1px solid var(--line)}
    .logo{font-weight:800;color:var(--acc)} a{color:#ff6bb5;text-decoration:none}
    .grid{display:grid;grid-template-columns:280px 1fr;gap:16px} @media(max-width:900px){.grid{grid-template-columns:1fr}}
    .card{background:#151921;border:1px solid var(--line);border-radius:14px;padding:18px}
    .list{max-height:70vh;overflow:auto} .item{display:flex;gap:10px;border-bottom:1px solid var(--line);padding:10px 0;cursor:pointer}
    .item img{width:36px;height:36px;border-radius:50%;object-fit:cover}
    .badge{margin-left:auto;background:#ff6bb5;color:#000;border-radius:999px;font-weight:800;padding:2px 8px;font-size:12px}
    .chat{display:grid;grid-template-rows:auto 1fr auto;min-height:70vh}
    .head{display:flex;gap:8px;align-items:center;border-bottom:1px solid var(--line);padding-bottom:10px}
    .head img{width:40px;height:40px;border-radius:50%;object-fit:cover}
    .messages{padding:10px;display:flex;flex-direction:column;gap:6px;overflow:auto}
    .msg{max-width:80%;padding:8px 10px;border-radius:10px;border:1px solid var(--line)}
    .me{align-self:flex-end;background:#1c1f27} .them{align-self:flex-start;background:#11141b}
    .send{display:flex;gap:8px;border-top:1px solid var(--line);padding-top:10px} .send input{flex:1}
    #toast{position:fixed;left:50%;transform:translateX(-50%);bottom:18px;background:#000c;border:1px solid var(--line);padding:10px 14px;border-radius:12px;display:none}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="logo">üíò LoveNow</div>
      <nav><a href="index.html">‚Üê Accueil</a></nav>
    </header>

    <div class="grid">
      <div class="card">
        <h3>Mes conversations</h3>
        <div id="convList" class="list"></div>
      </div>
      <div class="card chat">
        <div class="head"><img id="peerAvatar" src="https://placehold.co/56x56?text=%F0%9F%91%A4" alt=""><div id="peerTitle" class="muted">Aucune conversation</div></div>
        <div id="inviteBox" class="muted" style="display:none"></div>
        <div id="msgs" class="messages"></div>
        <form id="send" class="send">
          <input id="msg" placeholder="√âcrire un message‚Ä¶" maxlength="500">
          <button type="submit">Envoyer</button>
        </form>
      </div>
    </div>
  </div>

  <div id="toast" role="status" aria-live="polite"></div>

  <script type="module">
    const $=s=>document.querySelector(s); const toast=(m,ms=2400)=>{const t=$("#toast");t.textContent=m;t.style.display="block";setTimeout(()=>t.style.display="none",ms)}
    const chatIdFor=(a,b)=>[a,b].sort().join("_"); const sanitize=s=>(s||"").replace(/[<>]/g,"");
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-analytics.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc, updateDoc, collection, query, where, orderBy, onSnapshot, serverTimestamp, addDoc, increment } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    import { initializeAppCheck, ReCaptchaV3Provider } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app-check.js";

    const firebaseConfig={
      apiKey:"AIzaSyB_-cNA8bxqYCYUp3rUZs-VpiP4DX2wn3M",
      authDomain:"lovenow-officiel.firebaseapp.com",
      projectId:"lovenow-officiel",
      storageBucket:"lovenow-officiel.firebasestorage.app",
      messagingSenderId:"896585801571",
      appId:"1:896585801571:web:cdde87293291dc1900bd56",
      measurementId:"G-QGM25ND7LF"
    };
    const RECAPTCHA_SITE_KEY="6LfjpsErAAAAAExN2IvBq-K475TeJooeNzl9liPD";
    const app=initializeApp(firebaseConfig); try{getAnalytics(app)}catch{}
    initializeAppCheck(app,{provider:new ReCaptchaV3Provider(RECAPTCHA_SITE_KEY),isTokenAutoRefreshEnabled:true});
    const auth=getAuth(app); const db=getFirestore(app);

    let me=null, currentPeer=null, unsubConv=null, unsubMsgs=null;
    const userCache=new Map(); async function getUser(uid){ if(userCache.has(uid)) return userCache.get(uid);
      const s=await getDoc(doc(db,"users",uid)); const u=s.exists()?s.data():{}; const o={name:u.name||"Profil",photo:u.photoUrl||"https://placehold.co/56x56?text=%F0%9F%91%A4"}; userCache.set(uid,o); return o;}

    onAuthStateChanged(auth, async user=>{
      if(!user){ location.href="login.html"; return; } me=user; listenConversations();
    });

    function listenConversations(){
      if(unsubConv){unsubConv();unsubConv=null} const qConv=query(collection(db,"conversations"), where("members","array-contains",me.uid), orderBy("lastAt","desc"));
      unsubConv=onSnapshot(qConv, async snap=>{
        const conv=$("#convList"); conv.innerHTML="";
        for(const c of snap.docs){
          const data=c.data(); const otherId=data.members.find(x=>x!==me.uid); const other=await getUser(otherId);
          const div=document.createElement("div"); div.className="item";
          div.innerHTML=`<img src="${other.photo}"><div><div><strong>${other.name}</strong></div><small>${data.lastText||""}</small></div>${(data.unread&&data.unread[me.uid])?`<span class="badge">${data.unread[me.uid]}</span>`:""}`;
          div.addEventListener("click",()=>openChatWith(otherId)); conv.appendChild(div);
        }
      });
    }

    async function ensureConversation(peerUid){
      const cid=chatIdFor(me.uid,peerUid); const ref=doc(db,"conversations",cid); const s=await getDoc(ref);
      if(!s.exists()) await setDoc(ref,{members:[me.uid,peerUid],status:{[me.uid]:"accepted",[peerUid]:"pending"},lastText:"",lastSender:"",lastSenderName:"",lastAt:serverTimestamp(),unread:{[me.uid]:0,[peerUid]:0},createdAt:serverTimestamp()});
      return ref;
    }

    async function openChatWith(peerUid){
      currentPeer=peerUid; const peer=await getUser(peerUid); $("#peerTitle").textContent=peer.name; $("#peerAvatar").src=peer.photo;
      const ref=await ensureConversation(peerUid); const s=await getDoc(ref); const st=s.data()?.status||{}; const my=st[me.uid]||"accepted", other=st[peerUid]||"accepted";
      const inv=$("#inviteBox"); inv.style.display="none"; inv.textContent="";
      if(my==="pending"){ inv.style.display="block"; inv.textContent="Invitation re√ßue ‚Äî accepter pour discuter dans l‚Äôaccueil (index.html)."; }
      if(other==="pending"){ inv.style.display="block"; inv.textContent="En attente d‚Äôacceptation‚Ä¶"; }
      if(unsubMsgs){unsubMsgs();unsubMsgs=null}
      const q=query(collection(db,"messages"), where("chatId","==",chatIdFor(me.uid,peerUid)), orderBy("createdAt","asc"));
      unsubMsgs=onSnapshot(q,snap=>{ const box=$("#msgs"); box.innerHTML=""; snap.forEach(d=>{const m=d.data(); const div=document.createElement("div"); div.className="msg "+(m.senderId===me.uid?"me":"them"); div.textContent=m.text; box.appendChild(div);}); box.scrollTop=box.scrollHeight; });
      try{ await updateDoc(ref,{["unread."+me.uid]:0}); }catch{}
    }

    $("#send").addEventListener("submit", async (e)=>{
      e.preventDefault(); if(!me||!currentPeer) return toast("Choisissez une conversation.");
      const t=$("#msg").value.trim(); if(!t) return; const cid=chatIdFor(me.uid,currentPeer); const ref=doc(db,"conversations",cid); const s=await getDoc(ref); const st=s.data()?.status||{};
      if(st[me.uid]!=="accepted"||st[currentPeer]==="blocked"){toast("Invitation non accept√©e.");return;}
      await addDoc(collection(db,"messages"),{chatId:cid,senderId:me.uid,receiverId:currentPeer,text:sanitize(t),createdAt:serverTimestamp()});
      try{await updateDoc(ref,{lastText:t,lastSender:me.uid,lastSenderName:me.displayName||"Quelqu‚Äôun",lastAt:serverTimestamp(),["unread."+currentPeer]:increment(1)})}catch{}
      $("#msg").value="";
    });
  </script>
</body>
</html>
