<!doctype html>
<html lang="fr" data-theme="light">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Conversations — LoveNow</title>
  <meta name="description" content="Discute en temps réel avec les membres LoveNow."/>
  <link rel="stylesheet" href="/styles/tokens.css">
  <link rel="stylesheet" href="/styles/components.css">
  <script src="/js/features.js"></script>
  <script src="config.js"></script>
  <script defer src="/js/ui.js"></script>
  <style>
    *{box-sizing:border-box}
    html,body{margin:0;min-height:100%;background:var(--bg);color:var(--text);font-family:'Manrope',system-ui,sans-serif}
    a{color:inherit;text-decoration:none}

    main{padding-bottom:48px}

    .conversation-app{display:grid;grid-template-columns:minmax(260px,320px) minmax(0,1fr);gap:24px;margin:32px auto 64px;width:min(1180px,94vw)}
    @media(max-width:900px){.conversation-app{grid-template-columns:1fr;}}
    @media(max-width:900px){.sidebar{order:2}}

    .sidebar{background:rgba(255,255,255,0.82);border:1px solid rgba(255,255,255,0.9);border-radius:28px;box-shadow:0 28px 48px -34px rgba(47,22,52,0.35);overflow:hidden;display:flex;flex-direction:column}
    [data-theme="dark"] .sidebar{background:rgba(29,28,54,0.92);border-color:rgba(161,110,255,0.22);box-shadow:0 32px 60px -34px rgba(10,6,27,0.85)}

    .search{padding:22px;border-bottom:1px solid rgba(255,61,138,0.16);display:grid;gap:12px}
    .search input{width:100%}
    .search .muted{font-size:0.85rem}
    .search .tip{margin:6px 0 0}

    .list{flex:1;overflow:auto;padding:18px;display:grid;gap:12px}
    .conv{display:flex;gap:12px;align-items:center;padding:14px;border-radius:20px;background:rgba(255,255,255,0.6);border:1px solid rgba(255,255,255,0.6);box-shadow:0 18px 36px -28px rgba(47,22,52,0.35);cursor:pointer;transition:transform 150ms ease,box-shadow 150ms ease,background 150ms ease}
    .conv img{width:56px;height:56px;border-radius:18px;object-fit:cover;box-shadow:0 12px 24px -18px rgba(47,22,52,0.45)}
    .conv .meta{display:flex;flex-direction:column;gap:2px}
    .conv .meta .name{font-weight:600;font-size:1rem}
    .conv .meta .excerpt{font-size:0.9rem;color:var(--muted)}
    .conv:hover{transform:translateY(-2px);box-shadow:0 26px 42px -30px rgba(47,22,52,0.45);background:rgba(255,255,255,0.85)}
    .conv.active{background:linear-gradient(135deg,rgba(255,61,138,0.18),rgba(178,95,255,0.18));border-color:rgba(255,61,138,0.26)}

    .panel{background:rgba(255,255,255,0.88);border:1px solid rgba(255,255,255,0.9);border-radius:32px;box-shadow:0 30px 70px -36px rgba(47,22,52,0.35);display:flex;flex-direction:column;overflow:hidden}
    [data-theme="dark"] .panel{background:rgba(29,28,54,0.9);border-color:rgba(161,110,255,0.22);box-shadow:0 32px 68px -34px rgba(10,6,27,0.85)}

    .chatHead{display:flex;align-items:center;gap:14px;padding:22px;border-bottom:1px solid rgba(255,61,138,0.14)}
    .chatHead img{width:60px;height:60px;border-radius:22px;object-fit:cover;box-shadow:0 18px 36px -24px rgba(47,22,52,0.4)}
    .chatHead .muted{font-size:0.9rem}
    .chatName{font-weight:600;font-size:1.05rem}
    .chatSub{color:var(--muted);font-size:0.9rem}
    .spacer{flex:1}

    .chatMain{flex:1;overflow:auto;padding:28px;display:flex;flex-direction:column;gap:16px;background:linear-gradient(180deg,rgba(255,247,252,0.6),rgba(255,255,255,0.85))}
    [data-theme="dark"] .chatMain{background:linear-gradient(180deg,rgba(29,28,54,0.75),rgba(16,16,33,0.85))}

    .msg{max-width:min(70%,520px);padding:14px 16px;border-radius:20px;background:rgba(255,255,255,0.92);border:1px solid rgba(255,255,255,0.9);box-shadow:0 12px 30px -24px rgba(47,22,52,0.35);line-height:1.5}
    .mine{margin-left:auto;background:linear-gradient(135deg,var(--brand),var(--brand-2));color:#fff;border:none;box-shadow:0 18px 36px -28px rgba(255,61,138,0.7)}
    .stamp{font-size:0.8rem;color:var(--muted);margin-top:6px}

    .chatInput{display:grid;grid-template-columns:1fr auto;gap:14px;padding:22px;border-top:1px solid rgba(255,61,138,0.14);background:rgba(255,255,255,0.92)}
    .chatInput input{width:100%}
    .chatInput .btn{min-width:140px}

    .empty{padding:32px;text-align:center;color:var(--muted)}

    .badge{display:inline-flex;align-items:center;gap:6px;padding:0.35rem 0.65rem;border-radius:999px;background:rgba(255,61,138,0.15);color:var(--brand);font-size:0.85rem;font-weight:600}

    .conversation-toolbar{display:flex;align-items:center;gap:12px;margin-bottom:12px;flex-wrap:wrap}

    .soft-btn{padding:0.5rem 0.85rem;border-radius:999px;background:rgba(255,61,138,0.12);color:var(--brand);font-weight:600;border:none;cursor:pointer}

    @media(max-width:900px){
      .chatHead{position:sticky;top:0;background:inherit;z-index:2}
      .chatMain{min-height:320px}
      .chatInput{position:sticky;bottom:0;background:inherit}
    }
  </style>
</head>
<body>
<header class="site-header">
  <div class="wrap nav-bar">
    <a class="brand" href="/" aria-label="LoveNow">
      <img src="/assets/brand/logo.svg" alt="Logo LoveNow" />
      <span>LoveNow</span>
    </a>
    <button class="nav-toggle" type="button" aria-expanded="false" aria-controls="primary-menu" data-toggle-nav>
      <span></span>
      <span class="sr-only">Ouvrir le menu</span>
    </button>
    <nav id="primary-menu" class="site-menu" aria-label="Navigation principale">
      <a href="/#discover">Découvrir</a>
      <a href="/matchmaking.html">Matching</a>
      <a href="/conversations.html" aria-current="page">Conversations</a>
      <a href="/profile.html">Mon profil</a>
      <a href="/settings.html">Paramètres</a>
      <div class="session-slot">
        <button id="btnLogout" class="btn ghost" type="button">Se déconnecter</button>
      </div>
    </nav>
    <button class="mode-toggle" type="button" data-toggle-theme aria-label="Basculer le mode d'affichage">
      <svg aria-hidden="true" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6">
        <path d="M12 3a1 1 0 0 1 1 1v1.1a1 1 0 0 1-1 1h-.2a1 1 0 0 1-1-.8 3 3 0 0 0-2.9 2.9 1 1 0 0 1-.8 1H6a1 1 0 0 1-1-1A7 7 0 0 1 12 3Z" />
        <path d="M7 12a5 5 0 1 0 10 0 5 5 0 0 0-10 0Z" />
      </svg>
      <span>Mode</span>
    </button>
  </div>
</header>

<div id="verifyBanner" class="banner" hidden>
  <div><strong>E-mail non vérifié.</strong> Vérifie ton e-mail pour pouvoir envoyer des messages.</div>
  <div class="actions">
    <button id="btnResend" class="btn">Renvoyer le lien</button>
    <button id="btnRefresh" class="btn ghost">Rafraîchir</button>
  </div>
</div>

<main>
  <div class="conversation-app">
    <aside class="sidebar">
      <div class="search">
        <label for="emailStart" class="muted">Démarrer une discussion (par e-mail)</label>
        <div class="conversation-toolbar">
          <input id="emailStart" type="email" placeholder="ex. ami@exemple.com" autocomplete="off">
          <button id="btnStart" class="btn">OK</button>
        </div>
        <p class="muted tip">Astuce : tu peux aussi ouvrir <span class="badge">/conversations.html?startWith=UID</span></p>
      </div>
      <div id="convList" class="list" role="listbox" aria-label="Conversations"></div>
    </aside>

    <section class="panel">
      <div id="chatHead" class="chatHead" hidden>
        <img id="peerAvatar" src="" alt="Avatar de la conversation">
        <div>
          <div id="peerName" class="chatName">Sélectionne une conversation</div>
          <div id="peerCity" class="chatSub"></div>
        </div>
        <span class="spacer"></span>
        <span id="chatStatus" class="badge">Temps réel</span>
      </div>

      <div id="emptyChat" class="empty">Aucune discussion ouverte. Choisis une conversation à gauche ou lance une discussion.</div>
      <div id="chatMain" class="chatMain" hidden></div>

      <div id="chatInput" class="chatInput" hidden>
        <input id="msg" type="text" placeholder="Écrire un message…" maxlength="2000" autocomplete="off">
        <button id="btnSend" class="btn">Envoyer</button>
      </div>
    </section>
  </div>
</main>

<footer>
  <div class="wrap footer-card">
    <small>© LoveNow — Conversations sécurisées</small>
    <div class="footer-links">
      <a href="/privacy.html">Confidentialité</a>
      <a href="/cgu.html">CGU</a>
      <a href="/profile.html">Mon profil</a>
    </div>
  </div>
</footer>

<script type="module">
/* ====== Imports & boot Firebase ====== */
const cfg = window.APP_CONFIG?.firebase;

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
import { getAuth, onAuthStateChanged, sendEmailVerification, signOut } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
import {
  getFirestore, doc, getDoc, setDoc, serverTimestamp, addDoc, collection, onSnapshot, query, where, orderBy, getDocs, limit
} from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

const app = initializeApp(cfg);
loadAppCheck(app);
const auth = getAuth(app);
const db   = getFirestore(app);

/* ====== UI refs ====== */
const $ = s => document.querySelector(s);
const convList   = $("#convList");
const chatHead   = $("#chatHead");
const emptyChat  = $("#emptyChat");
const chatMain   = $("#chatMain");
const chatInput  = $("#chatInput");
const msgInput   = $("#msg");
const btnSend    = $("#btnSend");
const btnStart   = $("#btnStart");
const emailStart = $("#emailStart");
const verifyBanner = $("#verifyBanner");
const btnResend = $("#btnResend");
const btnRefresh = $("#btnRefresh");
const btnLogout = $("#btnLogout");
const peerAvatar=$("#peerAvatar");
const peerName  =$("#peerName");
const peerCity  =$("#peerCity");

/* ====== State ====== */
let ME = null;                 // { uid, email, emailVerified }
let activeConvId = null;       // id du document conversation
let activePeerUid = null;
let unsubMessages = null;
const profileCache = new Map(); // uid -> profile data

/* ====== Helpers ====== */
const fmtTime = (d)=> d ? new Intl.DateTimeFormat('fr-FR',{hour:'2-digit',minute:'2-digit'}).format(d) : '';

async function getProfile(uid){
  if(profileCache.has(uid)) return profileCache.get(uid);
  const snap = await getDoc(doc(db,"profiles",uid));
  const data = snap.exists() ? snap.data() : {};
  profileCache.set(uid, data);
  return data;
}

function renderConvItem(c){
  const other = c.members.find(x=>x!==ME.uid);
  const node  = document.createElement("div");
  node.className = "conv";
  node.dataset.cid = c.id;
  node.dataset.peer = other || "";
  node.setAttribute("role","option");

  const lastTxt = (c.lastMessageText || "").slice(0,80);
  const time = c.lastMessageAt?.toDate ? fmtTime(c.lastMessageAt.toDate()) : (c.createdAt?.toDate ? fmtTime(c.createdAt.toDate()) : "");

  const avatar = c._peer?.photoURL || "https://images.unsplash.com/photo-1502685104226-ee32379fefbe?q=80&w=200&auto=format&fit=crop";
  const name   = c._peer?.name || c._peer?.displayName || "Utilisateur";

  node.innerHTML = `
    <img src="${avatar}" alt="Photo de ${name}">
    <div class="meta">
      <div class="name">${name}</div>
      <div class="excerpt">${lastTxt || "—"} ${time?`· ${time}`:""}</div>
    </div>
  `;
  node.addEventListener("click", ()=> openConversation(c.id, other));
  return node;
}

function appendMessage(m){
  const me = m.from === ME.uid;
  const el = document.createElement("div");
  el.className = "msg" + (me ? " mine" : "");
  const t = m.text || "";
  const when = m.createdAt?.toDate ? fmtTime(m.createdAt.toDate()) : "";
  el.innerHTML = `
    <div>${t.replace(/</g,"&lt;")}</div>
    <div class="stamp">${when}</div>
  `;
  chatMain.appendChild(el);
  chatMain.scrollTop = chatMain.scrollHeight;
}

/* ====== Conversations list (realtime) ====== */
let unsubConv = null;
async function watchConversations(){
  if (unsubConv) unsubConv();

  // Requête simple (évite d’exiger un index) : array-contains sans orderBy
  const q = query(collection(db,"conversations"), where("members","array-contains", ME.uid));
  unsubConv = onSnapshot(q, async (snap)=>{
    // On “enrichit” côté client pour l’affichage (nom/photo de l’autre)
    const items = [];
    for (const d of snap.docs){
      const c = { id:d.id, ...d.data() };
      const other = (c.members||[]).find(x=>x!==ME.uid);
      if (other){
        c._peer = await getProfile(other);
      }
      items.push(c);
    }
    // tri client par dernière activité
    items.sort((a,b)=>{
      const ta = a.lastMessageAt?.toMillis ? a.lastMessageAt.toMillis() : (a.createdAt?.toMillis ? a.createdAt.toMillis() : 0);
      const tb = b.lastMessageAt?.toMillis ? b.lastMessageAt.toMillis() : (b.createdAt?.toMillis ? b.createdAt.toMillis() : 0);
      return tb - ta;
    });

    convList.innerHTML = "";
    if(items.length===0){
      const empty = document.createElement("div");
      empty.className="empty";
      empty.textContent = "Pas encore de conversations. Lance la première via l’e-mail à gauche.";
      convList.appendChild(empty);
    } else {
      for (const c of items) convList.appendChild(renderConvItem(c));
    }

    // Marque active si déjà ouverte
    [...convList.querySelectorAll(".conv")].forEach(n=>{
      if(n.dataset.cid===activeConvId) n.classList.add("active"); else n.classList.remove("active");
    });
  }, (err)=>console.error("Conversations watch error:", err));
}

/* ====== Open / Create conversation ====== */
async function ensureConversationWith(peerUid){
  if (!peerUid || peerUid===ME.uid) throw new Error("UID cible invalide.");
  // Cherche une conversation existante entre nous deux
  const q = query(collection(db,"conversations"), where("members","array-contains", ME.uid));
  const snap = await getDocs(q);
  const existing = snap.docs.find(d => {
    const m = d.data().members||[];
    return m.length===2 && m.includes(peerUid);
  });
  if(existing) return existing.id;

  // Crée la convo
  const ref = await addDoc(collection(db,"conversations"), {
    members:[ME.uid, peerUid],
    createdAt: serverTimestamp(),
    lastMessageText:"",
    lastMessageAt:null
  });
  return ref.id;
}

async function openConversation(cid, peerUid){
  // Nettoie l’ancien flux si besoin
  if (unsubMessages) { unsubMessages(); unsubMessages=null; }
  activeConvId = cid;
  activePeerUid = peerUid;

  // UI header destinataire
  const peer = await getProfile(peerUid);
  peerAvatar.src = peer.photoURL || "https://images.unsplash.com/photo-1502685104226-ee32379fefbe?q=80&w=200&auto=format&fit=crop";
  peerName.textContent = peer.name || peer.displayName || "Utilisateur";
  peerCity.textContent = peer.city ? `📍 ${peer.city}` : "";

  chatHead.hidden = false;
  emptyChat.hidden = true;
  chatMain.hidden = false;
  chatMain.innerHTML = "";
  chatInput.hidden = false;

  // Si mail non vérifié → on laisse lire mais on bloque l’envoi
  btnSend.disabled = !ME.emailVerified;
  msgInput.disabled = !ME.emailVerified;

  // Ecoute temps réel des messages
  const ref = doc(db,"conversations", cid);
  const q = query(collection(ref,"messages"), orderBy("createdAt","asc"), limit(500));
  unsubMessages = onSnapshot(q, (snap)=>{
    chatMain.innerHTML = "";
    snap.forEach(doc=> appendMessage(doc.data()));
  }, (err)=>console.error("Messages watch error:", err));

  // Marque active dans la liste
  [...convList.querySelectorAll(".conv")].forEach(n=>{
    if(n.dataset.cid===activeConvId) n.classList.add("active"); else n.classList.remove("active");
  });
}

/* ====== Send message ====== */
async function sendMessage(){
  const text = (msgInput.value || "").trim();
  if (!text) return;
  if (!activeConvId || !activePeerUid) return alert("Choisis une conversation d’abord.");
  if (!ME.emailVerified){ alert("Valide ton e-mail avant d’envoyer des messages."); return; }

  btnSend.disabled = true;
  try{
    const ref = doc(db,"conversations", activeConvId);
    await addDoc(collection(ref,"messages"), { from: ME.uid, text, createdAt: serverTimestamp() });
    await setDoc(ref, { lastMessageText: text, lastMessageAt: serverTimestamp() }, { merge:true });
    msgInput.value = "";
    msgInput.focus();
  }finally{
    btnSend.disabled = false;
  }
}

/* ====== Start chat by email ====== */
async function startByEmail(){
  const email = (emailStart.value||"").trim().toLowerCase();
  if(!email) return;
  if(!ME?.uid) return;

  // Recherche dans "profiles" (lecture publique selon tes règles)
  const q = query(collection(db,"profiles"), where("email","==", email), limit(1));
  const s = await getDocs(q);
  if(s.empty){ return alert("Aucun profil trouvé pour cet e-mail."); }
  const peerUid = s.docs[0].data().uid;
  if(!peerUid) return alert("Profil cible invalide.");
  const cid = await ensureConversationWith(peerUid);
  await openConversation(cid, peerUid);
}


/* ====== Auth flow ====== */
onAuthStateChanged(auth, async (user)=>{
  if(!user){ location.href="login.html#login"; return; }

  ME = { uid:user.uid, email:user.email||"", emailVerified: !!user.emailVerified };
  verifyBanner.hidden = ME.emailVerified;

  // boutons
  btnLogout.onclick = async ()=>{ await signOut(auth); location.href="login.html"; };
  btnResend?.addEventListener("click", async ()=>{
    try{
      const actionCodeSettings={ url:"https://lovenow.netlify.app/login.html?verified=1", handleCodeInApp:false };
      await sendEmailVerification(auth.currentUser, actionCodeSettings);
      alert("Lien de vérification envoyé ✅");
    }catch(e){ console.error(e); alert("Échec envoi lien"); }
  });
  btnRefresh?.addEventListener("click",()=>location.reload());

  btnSend.addEventListener("click", sendMessage);
  msgInput.addEventListener("keydown",(e)=>{ if(e.key==="Enter") sendMessage(); });
  btnStart.addEventListener("click", startByEmail);

  // Liste des conversations
  watchConversations();

  const startParam = getParam('startWith');
  const cidParam = getParam('cid');
  if(startParam){
    try{
      const cid = await ensureConversationWith(startParam);
      location.replace(`conversations.html?cid=${cid}`);
    }catch(e){ console.error(e); }
  }else if(cidParam){
    try{
      const ref = doc(db,'conversations', cidParam);
      const snap = await getDoc(ref);
      if(snap.exists()){
        const peer = (snap.data().members||[]).find(x=>x!==ME.uid);
        if(peer) await openConversation(cidParam, peer);
      }
    }catch(e){ console.error(e); }
  }
});

/* ====== URL params ====== */
function getParam(name){ return new URL(location.href).searchParams.get(name); }
</script>
<script>loadCrispIfEnabled();</script>
</body>
</html>