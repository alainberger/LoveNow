<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>LoveNow — Conversations</title>
  <style>
    :root{--ln-bg:#0c0f14;--ln-panel:#111622;--ln-ink:#fff;--ln-soft:#a9b1c3;--ln-accent:#ff3b81;}
    body{margin:0;background:var(--ln-bg);color:var(--ln-ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial}
    .wrap{display:grid;grid-template-columns:320px 1fr;min-height:100dvh}
    .left{border-right:1px solid #ffffff10}
    .panel{background:var(--ln-panel);border:1px solid #ffffff14;border-radius:14px;margin:16px;padding:12px}
    .title{margin:16px;font-size:20px}
    .list{list-style:none;margin:0;padding:0;display:flex;flex-direction:column;gap:8px}
    .item{padding:10px;border:1px solid #ffffff14;border-radius:12px;background:#0f1524;cursor:pointer}
    .item small{color:var(--ln-soft)}
    .right{display:flex;flex-direction:column}
    .thread{flex:1;display:flex;flex-direction:column;gap:8px;margin:16px;padding:12px;background:#0f1524;border:1px solid #ffffff14;border-radius:14px;overflow:auto}
    .msg{max-width:70%;padding:8px 10px;border-radius:10px;background:#ffffff14}
    .mine{align-self:flex-end;background:var(--ln-accent)}
    form{display:flex;gap:8px;margin:0 16px 16px}
    input[type=text]{flex:1;background:#12192a;border:1px solid #2a3245;color:#fff;border-radius:10px;padding:10px}
    .ln-btn{border:1px solid #ffffff40;background:#ffffff12;color:#fff;padding:10px 14px;border-radius:10px;cursor:pointer}
    .notice{display:flex;gap:8px;align-items:center;background:#2a2f3d;color:#fff;margin:16px;border-radius:10px;padding:10px}
  </style>
</head>
<body>
  <div class="wrap">
    <aside class="left">
      <h2 class="title">Mes conversations</h2>
      <div id="emailBanner" class="notice" hidden>
        <span>E-mail non vérifié.</span>
        <button id="sendVerify" class="ln-btn">Envoyer le lien</button>
        <button id="refreshAuth" class="ln-btn">Rafraîchir</button>
      </div>
      <div class="panel">
        <ul id="convList" class="list"></ul>
      </div>
    </aside>
    <section class="right">
      <h2 class="title">Messages</h2>
      <div id="thread" class="thread" aria-live="polite"></div>
      <form id="composerForm" autocomplete="off">
        <input id="composerInput" type="text" placeholder="Écrire un message…" />
        <button class="ln-btn" type="submit">Envoyer</button>
      </form>
    </section>
  </div>

  <script>
    window.firebaseConfig = {
      apiKey: "AIzaSyB_-cNA8bxqYCYUp3rUZs-VpiP4DX2wn3M",
      authDomain: "lovenow-officiel.firebaseapp.com",
      projectId: "lovenow-officiel",
      storageBucket: "lovenow-officiel.firebasestorage.app",
      messagingSenderId: "896585801571",
      appId: "1:896585801571:web:cdde87293291dc1900bd56",
      measurementId: "G-QGM25ND7LF"
    };
  </script>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-analytics.js";
    import { getAuth, onAuthStateChanged, sendEmailVerification } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";
    import {
      getFirestore, collection, query, where, orderBy, onSnapshot,
      doc, addDoc, serverTimestamp, getDoc, setDoc, updateDoc
    } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";

    const LAST_TS_FIELD = 'lastMessageAt';

    const app  = initializeApp(window.firebaseConfig);
    try { getAnalytics(app); } catch(e) {}
    const auth = getAuth(app);
    const db   = getFirestore(app);

    const convList = document.getElementById('convList');
    const threadEl = document.getElementById('thread');
    const formEl   = document.getElementById('composerForm');
    const inputEl  = document.getElementById('composerInput');

    const emailBanner = document.getElementById('emailBanner');
    const sendVerify  = document.getElementById('sendVerify');
    const refreshAuth = document.getElementById('refreshAuth');

    let currentUser, currentCid=null;

    onAuthStateChanged(auth, async (user)=>{
      if(!user){ location.href='/login.html'; return; }
      currentUser = user;

      emailBanner.hidden = user.emailVerified;
      formEl.querySelector('button[type="submit"]').disabled = !user.emailVerified;
      sendVerify.onclick = async ()=>{ await sendEmailVerification(user); alert('E-mail de vérification envoyé.'); };
      refreshAuth.onclick = ()=> location.reload();

      const q = query(
        collection(db,'conversations'),
        where('members','array-contains', user.uid),
        orderBy(LAST_TS_FIELD,'desc')
      );
      onSnapshot(q, (snap)=>{
        convList.innerHTML='';
        if(snap.empty){ convList.innerHTML='<li class="item"><small>Aucune conversation.</small></li>'; return; }
        snap.forEach(d=>{
          const c = d.data();
          const li = document.createElement('li');
          li.className = 'item';
          const preview = (c.lastMessage && c.lastMessage.text) ? c.lastMessage.text.slice(0,40) : 'Nouvelle conversation';
          li.innerHTML = `<strong>${preview}</strong><br><small>${d.id}</small>`;
          li.onclick = ()=> openConv(d.id);
          convList.appendChild(li);
        });
      });

      const params = new URLSearchParams(location.search);
      const cid    = params.get('cid');
      if(cid) openConv(cid);
    });

    function scrollBottom(){ threadEl.scrollTop = threadEl.scrollHeight; }

    async function ensureConversationDoc(cid){
      const cRef = doc(db,'conversations',cid);
      const snap = await getDoc(cRef);
      if(!snap.exists()){
        const [u1,u2] = cid.split('_');
        await setDoc(cRef, {
          members: [u1,u2],
          createdAt: serverTimestamp(),
          [LAST_TS_FIELD]: serverTimestamp(),
          lastMessage: null
        });
      }
    }

    async function openConv(cid){
      currentCid = cid;
      threadEl.innerHTML = '<div class="notice">Chargement…</div>';

      await ensureConversationDoc(cid);

      const q = query(
        collection(db,'conversations', cid, 'messages'),
        orderBy('createdAt','asc')
      );
      onSnapshot(q, (snap)=>{
        threadEl.innerHTML='';
        if(snap.empty){ threadEl.innerHTML='<div class="notice">Aucun message pour le moment.</div>'; }
        snap.forEach(m=>{
          const msg = m.data();
          const div = document.createElement('div');
          div.className = 'msg' + (msg.from===currentUser.uid?' mine':'');
          div.textContent = msg.text;
          threadEl.appendChild(div);
        });
        scrollBottom();
      });
    }

    formEl.addEventListener('submit', async (e)=>{
      e.preventDefault();
      if(!currentUser?.emailVerified){ alert('Valide ton e-mail pour écrire.'); return; }
      if(!currentCid){ alert('Choisis une conversation.'); return; }
      const text = inputEl.value.trim();
      if(!text) return;

      await addDoc(collection(db,'conversations', currentCid, 'messages'), {
        from: currentUser.uid,
        text,
        createdAt: serverTimestamp()
      });

      const cRef = doc(db,'conversations', currentCid);
      await updateDoc(cRef, {
        lastMessage: { text, from: currentUser.uid },
        [LAST_TS_FIELD]: serverTimestamp()
      }).catch(async ()=>{
        const [u1,u2] = currentCid.split('_');
        await setDoc(cRef, {
          members:[u1,u2],
          lastMessage:{ text, from: currentUser.uid },
          [LAST_TS_FIELD]: serverTimestamp(),
          createdAt: serverTimestamp()
        }, { merge:true });
      });

      inputEl.value='';
    });
  </script>
</body>
</html>