<!doctype html>
<html lang="fr" data-theme="dark">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Conversations — LoveNow</title>
<meta name="description" content="Messages privés LoveNow."/>
<link rel="canonical" href="https://lovenow.netlify.app/conversations"/>
<meta property="og:title" content="Conversations — LoveNow"/>
<meta property="og:description" content="Messages privés LoveNow."/>
<meta property="og:url" content="https://lovenow.netlify.app/conversations"/>
<meta property="og:image" content="https://via.placeholder.com/1200x630.png?text=LoveNow"/>
<meta name="twitter:card" content="summary_large_image"/>
<link rel="preload" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" as="style" onload="this.rel='stylesheet'"/>
<style>
:root{--bg:#0f1115;--panel:#151a22;--muted:#aab1c3;--text:#e9edf6;--brand:#ff2d55;--brand2:#7a5cf0;--line:#202734}
*{box-sizing:border-box}html,body{margin:0;height:100%}
body{background:var(--bg);color:var(--text);font-family:Inter,system-ui}
a{color:inherit;text-decoration:none}
.wrap{max-width:1100px;margin:0 auto;padding:12px}
header{position:sticky;top:0;z-index:5;background:rgba(15,17,21,.7);backdrop-filter:saturate(140%) blur(8px);border-bottom:1px solid var(--line)}
nav{display:flex;gap:8px;align-items:center;padding:10px 0}
.btn{display:inline-flex;align-items:center;justify-content:center;padding:.55rem .85rem;border-radius:.6rem;background:#232739;border:1px solid #2b2f44;cursor:pointer}
.btn-primary{background:linear-gradient(135deg,var(--brand),var(--brand2));border:none}
.grid{display:grid;grid-template-columns:320px 1fr;gap:12px;margin-top:12px}
@media(max-width:900px){.grid{grid-template-columns:1fr}}
.card{background:var(--panel);border:1px solid var(--line);border-radius:.9rem;overflow:hidden}
.sidebar{display:flex;flex-direction:column;height:70vh}
.search{padding:10px;border-bottom:1px solid var(--line)}
.input{width:100%;padding:.6rem;border-radius:.6rem;background:#0f1115;border:1px solid #2b2f44;color:var(--text)}
.list{overflow:auto}
.item{display:flex;gap:10px;padding:10px;border-bottom:1px solid var(--line);cursor:pointer}
.item:hover{background:#101722}
.item img{width:44px;height:44px;border-radius:10px;object-fit:cover;background:#0c0e12}
.item .meta{display:flex;flex-direction:column;gap:3px}
.item .name{font-weight:600}
.item .last{color:var(--muted);font-size:.9rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:220px}
.chat{display:flex;flex-direction:column;height:70vh}
.head{display:flex;align-items:center;gap:10px;padding:10px;border-bottom:1px solid var(--line)}
.head img{width:38px;height:38px;border-radius:10px;object-fit:cover;background:#0c0e12}
.msgs{flex:1;overflow:auto;padding:12px;display:flex;flex-direction:column;gap:10px}
.bubble{max-width:72%;padding:10px 12px;border-radius:12px;border:1px solid var(--line)}
.me{align-self:flex-end;background:#1e2230}
.them{align-self:flex-start;background:#131a25}
.time{color:var(--muted);font-size:.8rem;margin-top:4px}
.composer{display:flex;gap:8px;padding:10px;border-top:1px solid var(--line)}
.composer input{flex:1}
.banner{background:#1a1e2b;border:1px solid #27314a;border-radius:.8rem;padding:.6rem .8rem;margin:8px 0;display:flex;gap:8px;justify-content:space-between;align-items:center}
.muted{color:var(--muted)}
.toast{position:fixed;right:16px;bottom:16px;background:#111522;border:1px solid #22304a;padding:8px 12px;border-radius:8px}
a:focus,button:focus,input:focus,select:focus,textarea:focus{outline:3px auto;outline-offset:2px}
</style>
<script src="config.js"></script>
</head>
<body>
<header>
  <div class="wrap">
    <nav>
      <a class="btn" href="index.html">← Accueil</a>
      <strong>Conversations</strong>
      <span style="flex:1"></span>
      <a class="btn" href="profile.html">Mon profil</a>
    </nav>
  </div>
</header>

<main class="wrap">
  <div id="verifyBanner" class="banner" hidden>
    <div>E-mail non vérifié : vérifie ton e-mail pour écrire des messages.</div>
    <div style="display:flex;gap:8px">
      <button id="btnResend" class="btn">Renvoyer le lien</button>
      <button id="btnRefresh" class="btn">Rafraîchir</button>
    </div>
  </div>

  <div id="emptyConv" class="card" style="text-align:center;padding:40px" hidden>
    <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="#555" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
    <p>Aucune conversation pour l'instant.</p>
    <a href="/#discover" class="btn btn-primary">Découvrir des profils</a>
  </div>

  <div id="convGrid" class="grid">
    <!-- Liste -->
    <aside class="card sidebar" aria-label="Conversations">
      <div class="search"><input id="q" class="input" placeholder="Rechercher…"></div>
      <div id="list" class="list" role="listbox" aria-label="Liste des conversations"></div>
    </aside>

    <!-- Chat -->
    <section class="card chat" aria-live="polite">
      <div class="head">
        <img id="peerAvatar" src="" alt="Avatar">
        <div>
          <div id="peerName" style="font-weight:600">Sélectionne une conversation</div>
          <div id="peerCity" class="muted" style="font-size:.9rem"></div>
        </div>
        <span style="flex:1"></span>
        <a id="peerOpen" class="btn" href="#" hidden>Voir le profil</a>
      </div>
      <div id="msgs" class="msgs"></div>
      <form id="composer" class="composer">
        <input id="text" class="input" placeholder="Écrire un message…" autocomplete="off" required>
        <button class="btn btn-primary" type="submit">Envoyer</button>
      </form>
    </section>
  </div>
</main>

<!-- Firebase (App, Auth, Firestore) -->
<script type="module">
const $ = s => document.querySelector(s);
const params = new URLSearchParams(location.search);
const withUid = params.get("with"); // pour démarrer un chat direct
function showToast(msg){const t=document.getElementById('toast');t.textContent=msg;t.hidden=false;setTimeout(()=>t.hidden=true,3000);}

const cfg = window.APP_CONFIG?.firebase;
const siteKey = window.APP_CONFIG?.appCheck?.recaptchaV3SiteKey;

import { initializeApp, getApps, getApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
import { initializeAppCheck, ReCaptchaV3Provider } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app-check.js";
import { getAuth, onAuthStateChanged, sendEmailVerification } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
import {
  getFirestore, collection, doc, setDoc, getDoc, addDoc, onSnapshot,
  query, where, orderBy, serverTimestamp, limit
} from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

const app = getApps().length ? getApp() : initializeApp(cfg);
if (siteKey) initializeAppCheck(app,{provider:new ReCaptchaV3Provider(siteKey),isTokenAutoRefreshEnabled:true});
const auth = getAuth(app);
const db   = getFirestore(app);

/* ===== UI helpers ===== */
function bubble({me, text, ts}) {
  const el=document.createElement("div");
  el.className = "bubble " + (me?"me":"them");
  el.innerHTML = `
    <div>${(text||"").replace(/</g,"&lt;")}</div>
    <div class="time">${ts? new Date(ts).toLocaleString("fr-FR") : ""}</div>
  `;
  return el;
}
function itemRow({cid, peer, last}) {
  const row=document.createElement("div");
  row.className="item"; row.dataset.cid=cid;
  row.innerHTML = `
    <img src="${peer.photoURL || "https://images.unsplash.com/photo-1502685104226-ee32379fefbe?q=80&w=600&auto=format&fit=crop"}" alt="">
    <div class="meta">
      <div class="name">${peer.name || "Utilisateur"}</div>
      <div class="last">${last || ""}</div>
    </div>`;
  row.addEventListener("click",()=>openConversation(cid, peer.uid));
  return row;
}

/* ===== Etat courant ===== */
let me=null;            // utilisateur courant
let currentCid=null;    // conversation ouverte
let unsubMsgs=null;     // unsubscribe listener messages
let peersCache=new Map();// uid -> profil

/* ===== Auth gate + bannière vérif ===== */
onAuthStateChanged(auth, async (user)=>{
  if(!user){ location.href="login.html#login"; return; }
  me = user;

  const verified = !!user.emailVerified;
  $("#verifyBanner").hidden = verified;
  $("#composer").style.display = verified ? "flex" : "none";

  $("#btnResend")?.addEventListener("click", async ()=>{
    const btn=$("#btnResend"); const prev=btn.textContent; btn.disabled=true; btn.textContent="Envoi…";
    showToast("Envoi en cours…");
    try{
      const actionCodeSettings={ url:"https://lovenow.netlify.app/login.html?verified=1", handleCodeInApp:false };
      await sendEmailVerification(user, actionCodeSettings);
      showToast("Lien envoyé ✅");
    }catch(e){ showToast("Échec d'envoi. Réessaye."); }
    finally{ btn.disabled=false; btn.textContent=prev; }
  });
  $("#btnRefresh")?.addEventListener("click", ()=>location.reload());

  await loadList();
  if (withUid) await openOrCreateDirect(withUid);
});

/* ===== Utilitaires Firestore ===== */
async function getProfile(uid){
  if(peersCache.has(uid)) return peersCache.get(uid);
  const snap = await getDoc(doc(db,"profiles",uid));
  const p = snap.exists() ? ({uid, ...snap.data()}) :
    {uid, name:"Utilisateur", city:"", photoURL:""};
  peersCache.set(uid,p);
  return p;
}
function pairKey(a,b){ return [a,b].sort().join("_"); }

/* ===== Liste des conversations ===== */
async function loadList(){
  const list=$("#list"); list.innerHTML="";
  const qList = query(collection(db,"conversations"), where("members","array-contains", me.uid), limit(50));
  onSnapshot(qList, async (snap)=>{
    list.innerHTML="";
    const rows = await Promise.all(snap.docs.map(async d=>{
      const data=d.data()||{};
      const other = (data.members||[]).find(x=>x!==me.uid);
      const peer  = await getProfile(other);
      return itemRow({cid:d.id, peer, last:data.lastText||""});
    }));
    rows.sort((a,b)=>0).forEach(r=>list.appendChild(r));
    const empty=rows.length===0;
    document.getElementById('emptyConv').hidden=!empty;
    document.getElementById('convGrid').hidden=empty;
  });
}

/* ===== Ouvrir une conversation + stream messages ===== */
async function openConversation(cid, peerUid){
  currentCid = cid;
  const peer = await getProfile(peerUid);

  $("#peerAvatar").src = peer.photoURL || "https://images.unsplash.com/photo-1502685104226-ee32379fefbe?q=80&w=600&auto=format&fit=crop";
  $("#peerName").textContent = peer.name || "Utilisateur";
  $("#peerCity").textContent = peer.city || "";
  $("#peerOpen").hidden = false;
  $("#peerOpen").href = `/u/${encodeURIComponent(peerUid)}`;

  unsubMsgs?.(); // stop ancien listener
  const qMsgs = query(collection(db,"conversations",cid,"messages"), orderBy("createdAt","asc"), limit(500));
  unsubMsgs = onSnapshot(qMsgs,(snap)=>{
    const box=$("#msgs"); box.innerHTML="";
    snap.forEach(d=>{
      const m=d.data()||{};
      box.appendChild(bubble({
        me: m.from===me.uid,
        text: m.text,
        ts: m.createdAt?.toMillis ? m.createdAt.toMillis() : null
      }));
      box.scrollTop = box.scrollHeight;
    });
  });
}

/* ===== Créer/ouvrir un direct via ?with=UID ===== */
async function openOrCreateDirect(otherUid){
  if(otherUid===me.uid) return;
  const id = pairKey(me.uid, otherUid);
  const ref = doc(db,"conversations", id);
  const snap = await getDoc(ref);
  if(!snap.exists()){
    await setDoc(ref,{
      members:[me.uid, otherUid],
      createdAt: serverTimestamp(),
      lastText:""
    },{merge:true});
  }
  await openConversation(id, otherUid);
}

/* ===== Envoi message ===== */
$("#composer").addEventListener("submit", async (e)=>{
  e.preventDefault();
  if(!me?.emailVerified){ alert("Vérifie d’abord ton e-mail."); return; }
  if(!currentCid){ alert("Choisis une conversation."); return; }
  const text = ($("#text").value||"").trim();
  if(!text) return;

  // retrouve l’autre membre
  const convSnap = await getDoc(doc(db,"conversations", currentCid));
  const mem = convSnap.data()?.members || [];
  const to = mem.find(x=>x!==me.uid) || null;

  const msgRef = collection(db,"conversations", currentCid,"messages");
  await addDoc(msgRef, {
    from: me.uid,
    to,
    text,
    createdAt: serverTimestamp()
  });
  await setDoc(doc(db,"conversations", currentCid), { lastText:text, updatedAt: serverTimestamp() }, { merge:true });
  $("#text").value="";
});

/* ===== Recherche locale dans la liste ===== */
$("#q").addEventListener("input",()=>{
  const q = $("#q").value.toLowerCase();
  for(const row of $("#list").children){
    const name = row.querySelector(".name")?.textContent?.toLowerCase()||"";
    row.style.display = name.includes(q) ? "" : "none";
  }
});
</script>
<div id="toast" class="toast" role="status" aria-live="polite" hidden></div>
</body>
</html>