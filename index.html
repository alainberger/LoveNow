<!doctype html>
<html lang="fr" data-theme="light">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>LoveNow ‚Äî Rencontres 100% simples, 18+</title>
  <meta name="description" content="Rencontrez des profils pr√®s de chez vous. Gratuit au d√©part, 18+. Filtres par ville, √¢ge et plus.">
  <link rel="canonical" href="https://lovenow.netlify.app/">
  <meta property="og:title" content="LoveNow ‚Äî Rencontres 18+">
  <meta property="og:description" content="Profils en temps r√©el, messages s√©curis√©s.">
  <meta property="og:url" content="https://lovenow.netlify.app/">
    <meta property="og:image" content="/assets/og-default.jpg">
    <meta name="twitter:card" content="summary_large_image">
    <link rel="stylesheet" href="/styles/tokens.css">
    <link rel="stylesheet" href="/styles/components.css">
    <link rel="icon" href="/assets/brand/logo.svg" type="image/svg+xml">
    <link rel="manifest" href="/public/manifest.json">
    <script src="/js/features.js"></script>
    <script src="config.js"></script>
    <script defer src="/js/ui.js"></script>
</head>
<body>
  <header class="site-header">
    <div class="wrap nav-bar">
      <a class="brand" href="/" aria-label="LoveNow">
        <img src="/assets/brand/logo.svg" alt="Logo LoveNow" />
        <span>LoveNow</span>
      </a>
      <button class="nav-toggle" type="button" aria-expanded="false" aria-controls="primary-menu" data-toggle-nav>
        <span></span>
        <span class="sr-only">Ouvrir le menu</span>
      </button>
      <nav id="primary-menu" class="site-menu" aria-label="Navigation principale">
        <a href="/#discover">D√©couvrir</a>
        <a href="/matchmaking.html">Matching</a>
        <a href="/conversations.html">Conversations</a>
        <a href="/profile.html">Mon profil</a>
        <a href="/settings.html">Param√®tres</a>
        <a href="/privacy.html">Confidentialit√©</a>
        <a href="/cgu.html">CGU</a>
        <div class="session-slot" id="header-session">
          <a class="btn" href="/login.html#signup">Rejoins-nous gratuitement</a>
        </div>
      </nav>
      <button class="mode-toggle" type="button" data-toggle-theme aria-label="Basculer le mode d'affichage">
        <svg aria-hidden="true" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6">
          <path d="M12 3a1 1 0 0 1 1 1v1.1a1 1 0 0 1-1 1h-.2a1 1 0 0 1-1-.8 3 3 0 0 0-2.9 2.9 1 1 0 0 1-.8 1H6a1 1 0 0 1-1-1A7 7 0 0 1 12 3Z" />
          <path d="M7 12a5 5 0 1 0 10 0 5 5 0 0 0-10 0Z" />
        </svg>
        <span>Mode</span>
      </button>
    </div>
  </header>

  <div id="verifyBanner" class="banner" hidden>
    <div>Adresse e-mail non v√©rifi√©e.</div>
    <div style="display:flex;gap:8px">
      <button id="btnResend" class="btn">Envoyer le lien</button>
      <button id="btnRefresh" class="btn">Rafra√Æchir</button>
    </div>
  </div>

  <main>
    <section class="hero" id="hero">
      <div class="wrap">
        <div class="hero-content">
          <div class="hero-badges">
            <span class="chip">‚ö° Matching en direct</span>
            <span class="chip">üîê Authentification s√©curis√©e</span>
            <span class="chip">üí¨ Messagerie instantan√©e</span>
          </div>
          <h1>LoveNow, des rencontres modernes et authentiques</h1>
          <p>D√©couvrez des profils v√©rifi√©s pr√®s de chez vous, √©changez en toute confiance et laissez l‚Äôalgorithme de matching faire le reste.</p>
          <div class="actions">
            <a class="btn" href="/login.html#signup">Cr√©er mon compte</a>
            <a class="btn ghost" href="/#discover">Explorer les profils</a>
          </div>
          <p class="muted">18+ uniquement ¬∑ Disponible sur mobile &amp; desktop ¬∑ Notifications e-mail en option</p>
        </div>
        <div class="hero-visual" aria-hidden="true">
          <div class="hero-card">
            <div class="mini-profile">
              <div class="hero-avatar">AN</div>
              <div>
                <strong>Anna, 27</strong>
                <span>Paris ¬∑ Caf√© &amp; concerts</span>
              </div>
            </div>
            <div class="stacked">
              <div class="bubble">üí¨ ¬´ J‚Äôai match√© en quelques minutes et la conversation a tout de suite d√©marr√© ! ¬ª</div>
              <div class="bubble">98% profils v√©rifi√©s</div>
            </div>
            <div class="stacked">
              <div class="bubble">üéØ Filtres avanc√©s</div>
              <div class="bubble">üîî Alertes discr√®tes</div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <section id="discover" aria-labelledby="discover-title">
      <div class="wrap">
        <h2 id="discover-title">D√©couvrir des profils</h2>
        <span id="devBadge" class="badge badge--dev" hidden>Mode test</span>
        <p class="lead">Affinez votre recherche par genre, √¢ge ou ville et envoyez un message d√®s que vous avez un match.</p>
        <form id="filters" class="filters" onsubmit="return false">
          <div>
            <label for="gender">Genre</label>
            <select id="gender" name="gender">
              <option value="">Tous</option>
              <option value="f">Femme</option>
              <option value="m">Homme</option>
              <option value="o">Autre</option>
            </select>
          </div>
          <div>
            <label for="ageMin">√Çge min</label>
            <input id="ageMin" name="ageMin" type="number" min="18" max="99" inputmode="numeric" placeholder="18">
          </div>
          <div>
            <label for="ageMax">√Çge max</label>
            <input id="ageMax" name="ageMax" type="number" min="18" max="99" inputmode="numeric" placeholder="35">
          </div>
          <div>
            <label for="city">Ville</label>
            <input id="city" name="city" type="text" placeholder="Paris, Lyon‚Ä¶">
          </div>
          <div class="actions">
            <button class="btn" id="btnSearch" type="button">Rechercher</button>
            <button class="btn ghost" id="btnReset" type="button">R√©initialiser</button>
          </div>
        </form>
        <div id="results" class="cards" aria-live="polite"></div>
        <div id="resultsActions" class="actions" hidden>
          <button id="btnLoadMore" class="btn ghost" type="button">Charger plus</button>
        </div>
        <p id="empty-hint" class="muted" style="display:none">Ajuste les filtres ou compl√®te ton profil pour voir plus de r√©sultats.</p>
      </div>
    </section>
  </main>

  <div id="toast" role="status" aria-live="polite"></div>

  <footer>
    <div class="wrap footer-card">
      <small>¬© LoveNow ‚Äî Rencontres responsables &amp; inclusives</small>
      <div class="footer-links">
        <a href="/privacy.html">Confidentialit√©</a>
        <a href="/cgu.html">CGU</a>
        <a href="/legal/cookies.html">Cookies</a>
        <a href="/blog/index.html">Blog</a>
      </div>
    </div>
  </footer>

  <script type="module">
    import {
      setupFirebase,
      renderVerifyBanner,
      applySessionToHeader,
      safeSignOut,
      getUserPreferences,
      isDevBypassEnabled,
    } from '/js/app-core.js';
    import {
      initAuth,
      resendVerificationEmail,
      refreshUser,
      isEmailVerified,
    } from '/js/auth.js';

    const state = {
      currentUser: null,
      filters: {},
      devBypass: isDevBypassEnabled(),
      lastDoc: null,
      loading: false,
      results: [],
      prefsApplied: false,
      emailVerified: false,
    };

    const PAGE_SIZE = 20;
    const $ = (selector) => document.querySelector(selector);
    const resultsEl = $('#results');
    const resultsActions = $('#resultsActions');
    const btnLoadMore = $('#btnLoadMore');
    const emptyHintEl = $('#empty-hint');
    const toast = $('#toast');
    const filtersForm = $('#filters');
    const btnSearch = $('#btnSearch');
    const btnReset = $('#btnReset');
    const verifyBanner = $('#verifyBanner');
    const btnResend = $('#btnResend');
    const btnRefresh = $('#btnRefresh');
    const headerSlot = document.getElementById('header-session');
    const devBadge = $('#devBadge');

    let toastTimer;

    const showToast = (message) => {
      if (!toast) return;
      toast.textContent = message;
      toast.classList.add('show');
      clearTimeout(toastTimer);
      toastTimer = setTimeout(() => toast.classList.remove('show'), 2400);
    };

    const renderSkeletons = (count = 6) => {
      resultsEl.innerHTML = Array.from({ length: count })
        .map(() => '<div class="skel" aria-hidden="true"></div>')
        .join('');
      emptyHintEl.style.display = 'block';
      resultsActions.hidden = true;
    };

    const updateDevBadge = () => {
      if (!devBadge) return;
      devBadge.hidden = !state.devBypass;
    };

    const normalizeAge = (value) => {
      const parsed = Number(value);
      return Number.isFinite(parsed) ? parsed : null;
    };

    const renderCards = (items, { append = false } = {}) => {
      if (!append) {
        resultsEl.innerHTML = '';
      }
      if (!append && items.length === 0) {
        emptyHintEl.style.display = 'block';
        resultsActions.hidden = true;
        return;
      }
      if (items.length === 0) {
        emptyHintEl.style.display = state.results.length ? 'none' : 'block';
        return;
      }

      emptyHintEl.style.display = state.results.length ? 'none' : 'block';

      const cards = items
        .map((profile) => {
          const uid = profile.uid || profile.id || '';
          const name = profile.name || profile.displayName || 'Utilisateur';
          const initials = name.trim().charAt(0).toUpperCase() || '?';
          const photo = profile.photoURL || profile.photoUrl || '';
          const city = profile.city || 'Ville non renseign√©e';
          const ageValue = profile.age != null ? Number(profile.age) : null;
          const ageLabel = Number.isFinite(ageValue) ? `${ageValue} ans` : '√Çge non renseign√©';
          const bio = profile.bio ? profile.bio.slice(0, 160) : 'Ce membre n‚Äôa pas encore r√©dig√© sa pr√©sentation.';
          const avatar = photo
            ? `<img src="${photo}" alt="Photo de ${name}">`
            : `<span>${initials}</span>`;
          const viewLink = `/user.html?uid=${encodeURIComponent(uid)}`;
          return `
            <article class="card profile-card" tabindex="0" aria-label="Profil de ${name}">
              <div class="profile-card__header">
                <div class="profile-card__avatar">${avatar}</div>
                <div class="profile-card__meta">
                  <strong>${name}</strong>
                  <span>${ageLabel} ¬∑ ${city}</span>
                </div>
              </div>
              <p>${bio}</p>
              <div class="profile-card__actions">
                <a class="btn ghost" href="${viewLink}">Voir le profil</a>
                <button class="btn" data-action="message" data-uid="${uid}">Envoyer un message</button>
              </div>
            </article>
          `;
        })
        .join('');

      if (append) {
        resultsEl.insertAdjacentHTML('beforeend', cards);
      } else {
        resultsEl.innerHTML = cards;
      }

      resultsEl.querySelectorAll('[data-action="message"]').forEach((button) => {
        button.addEventListener('click', () => {
          const targetUid = button.dataset.uid;
          if (!targetUid) return;
          if (!state.currentUser) {
            window.location.href = '/login.html#log_in';
            return;
          }
          if (!state.emailVerified && !state.devBypass) {
            verifyBanner.hidden = false;
            showToast('V√©rifie ton e-mail pour d√©marrer une conversation.');
            return;
          }
          window.location.href = `/conversations.html?startWith=${encodeURIComponent(targetUid)}`;
        });
      });
    };

    const updateQueryString = () => {
      const params = new URLSearchParams();
      if (state.filters.gender) params.set('gender', state.filters.gender);
      if (state.filters.city) params.set('city', state.filters.city);
      if (Number.isFinite(state.filters.ageMin)) params.set('ageMin', state.filters.ageMin);
      if (Number.isFinite(state.filters.ageMax)) params.set('ageMax', state.filters.ageMax);
      const query = params.toString();
      history.replaceState({}, '', query ? `?${query}` : window.location.pathname);
    };

    const setFiltersFromForm = () => {
      if (!filtersForm) return true;
      const gender = filtersForm.gender.value.trim();
      const city = filtersForm.city.value.trim();
      const ageMin = normalizeAge(filtersForm.ageMin.value);
      const ageMax = normalizeAge(filtersForm.ageMax.value);
      if (Number.isFinite(ageMin) && Number.isFinite(ageMax) && ageMin > ageMax) {
        showToast('L‚Äô√¢ge minimum ne peut pas d√©passer l‚Äô√¢ge maximum.');
        return false;
      }
      state.filters = {
        gender,
        city,
        cityLower: city.toLowerCase(),
        ageMin,
        ageMax,
      };
      updateQueryString();
      return true;
    };

    const hydrateFiltersFromUrl = () => {
      if (!filtersForm) return;
      const params = new URLSearchParams(window.location.search);
      const gender = params.get('gender') || '';
      const city = params.get('city') || '';
      const ageMin = params.get('ageMin') || '';
      const ageMax = params.get('ageMax') || '';
      filtersForm.gender.value = gender;
      filtersForm.city.value = city;
      filtersForm.ageMin.value = ageMin;
      filtersForm.ageMax.value = ageMax;
      setFiltersFromForm();
    };

    updateDevBadge();

    const applyPreferenceFilters = (prefs = {}) => {
      if (!filtersForm) return false;
      const prev = JSON.stringify(state.filters);
      filtersForm.ageMin.value = prefs.ageMin ?? '';
      filtersForm.ageMax.value = prefs.ageMax ?? '';
      filtersForm.city.value = prefs.city ?? '';
      setFiltersFromForm();
      return JSON.stringify(state.filters) !== prev;
    };

    (async () => {
      const { auth, db, authModule, firestoreModule } = await setupFirebase();
      const { signOut } = authModule;
      const {
        collection,
        query,
        where,
        orderBy,
        limit,
        startAfter,
        getDocs,
      } = firestoreModule;

      const fetchProfiles = async ({ append = false } = {}) => {
        if (append && !state.lastDoc) return;
        const clauses = [];
        if (state.filters.gender) {
          clauses.push(where('gender', '==', state.filters.gender));
        }
        if (state.filters.cityLower) {
          clauses.push(where('cityLower', '==', state.filters.cityLower));
        }
        const baseCollection = collection(db, 'users');
        const baseOrder = [orderBy('updatedAt', 'desc')];
        let q = query(baseCollection, ...clauses, ...baseOrder, limit(PAGE_SIZE));
        if (append && state.lastDoc) {
          q = query(baseCollection, ...clauses, ...baseOrder, startAfter(state.lastDoc), limit(PAGE_SIZE));
        }
        const snapshot = await getDocs(q);
        state.lastDoc = snapshot.docs[snapshot.docs.length - 1] || null;
        let list = snapshot.docs.map((docSnap) => ({ id: docSnap.id, ...docSnap.data() }));
        if (state.currentUser?.uid) {
          list = list.filter((profile) => profile.uid !== state.currentUser.uid);
        }
        if (Number.isFinite(state.filters.ageMin)) {
          list = list.filter((profile) => Number(profile.age) >= state.filters.ageMin);
        }
        if (Number.isFinite(state.filters.ageMax)) {
          list = list.filter((profile) => Number(profile.age) <= state.filters.ageMax);
        }
        if (!append) {
          state.results = list;
        } else {
          state.results = state.results.concat(list);
        }
        if (append) {
          renderCards(list, { append: true });
        } else {
          renderCards(state.results);
        }
        resultsActions.hidden = !state.lastDoc || snapshot.size < PAGE_SIZE;
        if (!state.results.length) {
          emptyHintEl.style.display = 'block';
        } else {
          emptyHintEl.style.display = 'none';
        }
      };

      renderVerifyBanner({
        banner: verifyBanner,
        resendBtn: btnResend,
        refreshBtn: btnRefresh,
        onResend: async () => {
          try {
            await resendVerificationEmail();
            showToast('Lien de v√©rification envoy√© ‚úÖ');
          } catch (err) {
            if (err?.code === 'cooldown') {
              showToast(`R√©essaie dans ${err.remaining}s.`);
            } else if (err?.message === 'not-authenticated') {
              showToast('Connecte-toi pour renvoyer le lien.');
            } else {
              showToast('Envoi impossible pour le moment.');
            }
            throw err;
          }
        },
        onRefresh: async () => {
          try {
            const refreshed = await refreshUser();
            state.emailVerified = refreshed?.emailVerified || isEmailVerified();
            if (state.emailVerified || state.devBypass) {
              verifyBanner.hidden = true;
              showToast('Statut mis √† jour ‚úÖ');
            }
          } catch (err) {
            if (err?.message === 'not-authenticated') {
              showToast('Connecte-toi pour rafra√Æchir.');
            } else {
              console.error('refresh failed', err);
              showToast('Actualisation impossible pour le moment.');
            }
            throw err;
          }
        },
      });

      await initAuth({
        onAuthenticated: async ({ user, emailVerified }) => {
          state.currentUser = user;
          state.emailVerified = emailVerified;
          if (user) {
            applySessionToHeader(headerSlot, user, {
              onSignOutClick: (event) => safeSignOut(auth, signOut, event?.currentTarget),
            });
            if (emailVerified || state.devBypass) {
              verifyBanner.hidden = true;
            } else {
              verifyBanner.hidden = false;
            }
            if (!state.prefsApplied && (!window.location.search || window.location.search.length <= 1)) {
              try {
                const prefs = await getUserPreferences(db, firestoreModule, user.uid);
                const shouldRefetch = applyPreferenceFilters(prefs || {});
                if (shouldRefetch) {
                  state.lastDoc = null;
                  state.loading = true;
                  renderSkeletons();
                  await fetchProfiles();
                }
              } catch (err) {
                console.error('apply preferences failed', err);
              } finally {
                state.prefsApplied = true;
              }
            } else {
              state.prefsApplied = true;
            }
          } else {
            applySessionToHeader(headerSlot, null, { onSignOutClick: () => {} });
            verifyBanner.hidden = true;
            state.prefsApplied = false;
          }
          updateDevBadge();
        },
        onUnauthenticated: () => {
          applySessionToHeader(headerSlot, null, { onSignOutClick: () => {} });
          verifyBanner.hidden = true;
          state.prefsApplied = false;
          state.currentUser = null;
          state.emailVerified = false;
        },
        onVerificationRequired: () => {
          if (!state.devBypass) {
            verifyBanner.hidden = false;
          }
        },
      });

      hydrateFiltersFromUrl();
      state.loading = true;
      renderSkeletons();
      try {
        await fetchProfiles();
      } catch (err) {
        console.error('fetchProfiles failed', err);
        showToast('Impossible de charger les profils pour le moment.');
        resultsEl.innerHTML = '';
      } finally {
        state.loading = false;
      }

      btnSearch?.addEventListener('click', async () => {
        if (!setFiltersFromForm()) return;
        state.lastDoc = null;
        state.loading = true;
        renderSkeletons();
        try {
          await fetchProfiles();
          showToast('Filtres appliqu√©s ‚úÖ');
        } catch (err) {
          console.error('search failed', err);
          showToast('Impossible de r√©cup√©rer les profils.');
        } finally {
          state.loading = false;
        }
      });

      btnReset?.addEventListener('click', async () => {
        filtersForm.reset();
        state.filters = {};
        updateQueryString();
        state.lastDoc = null;
        state.loading = true;
        renderSkeletons();
        try {
          await fetchProfiles();
          showToast('Filtres r√©initialis√©s');
        } catch (err) {
          console.error('reset failed', err);
          showToast('R√©initialisation impossible pour le moment.');
        } finally {
          state.loading = false;
        }
      });

      btnLoadMore?.addEventListener('click', async () => {
        if (state.loading) return;
        state.loading = true;
        try {
          await fetchProfiles({ append: true });
        } catch (err) {
          console.error('load more failed', err);
          showToast('Impossible de charger davantage de profils.');
        } finally {
          state.loading = false;
        }
      });
    })();
  </script>
  <script>loadCrispIfEnabled();</script>
  <script>
    if (window.__FEATURES__?.PWA_ENABLED && 'serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/service-worker.js');
      });
    }
  </script>
</body>
</html>
