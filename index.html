<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>LoveNow ‚Äî Rencontres pr√®s de chez toi</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;800&display=swap" rel="stylesheet">
  <style>
    :root{--bg:#0d0d10;--card:#151921;--line:#222a35;--txt:#f6f8fa;--muted:#aeb6c2;--acc:#ff4d6d;--acc2:#8f51ea;--ok:#30d158;--danger:#ff6464}
    *{box-sizing:border-box} html,body{margin:0;background:var(--bg);color:var(--txt);font-family:Poppins,system-ui,Arial}
    a{color:#ff6bb5;text-decoration:none}
    .wrap{max-width:1100px;margin:0 auto;padding:16px 18px}
    header{position:sticky;top:0;z-index:50;backdrop-filter:saturate(140%) blur(8px);background:linear-gradient(180deg,rgba(0,0,0,.7),rgba(0,0,0,.45));border-bottom:1px solid var(--line)}
    .row{display:flex;gap:14px;align-items:center;justify-content:space-between}
    .logo{font-weight:800;color:var(--acc)}
    .nav-btn{border:1px solid #fff9;padding:8px 14px;border-radius:999px;background:none;color:#fff;cursor:pointer}
    .nav-btn:hover{background:#fff;color:#000}
    .nav-btn.danger{border-color:var(--danger)}
    .hero{display:grid;place-items:center;min-height:64vh;text-align:center;padding:30px 18px;background:linear-gradient(135deg,var(--acc),#ff6bb5,var(--acc2))}
    .hero h1{font-size:clamp(28px,6vw,48px);margin:6px 0 10px;font-weight:800}
    .cta{display:inline-block;background:#fff;color:#000;font-weight:800;border-radius:999px;padding:14px 28px;border:0;cursor:pointer}
    section{padding:32px 18px} h2{margin:0 0 12px}
    .grid{display:grid;gap:16px}.g-2{grid-template-columns:repeat(2,1fr)}@media(max-width:900px){.g-2{grid-template-columns:1fr}}
    .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:18px}
    .form{display:grid;gap:10px}.form input,.form textarea{width:100%;border-radius:10px;border:1px solid var(--line);background:#0f1320;color:#fff;padding:10px}
    .form button{border:0;border-radius:10px;padding:12px 16px;background:var(--acc);color:#000;font-weight:800;cursor:pointer}
    .file input{display:none}.file span{display:inline-block;border:1px dashed var(--line);padding:10px;border-radius:10px;cursor:pointer}
    .avatar-wrap{text-align:center;margin-top:8px}.avatar-wrap img{width:120px;height:120px;border-radius:50%;object-fit:cover;border:2px solid var(--line)}
    .list{display:grid;gap:8px;max-height:280px;overflow:auto}
    .item{display:flex;align-items:center;gap:10px;border:1px solid var(--line);padding:10px;border-radius:10px}
    .item img{width:44px;height:44px;border-radius:50%;object-fit:cover}
    .item .grow{flex:1}.item button{padding:8px 10px;border:0;border-radius:999px;background:var(--acc);font-weight:700}
    .item .sub{color:#aeb6c2;font-size:12px}
    .badge{display:inline-block;font-size:11px;padding:2px 8px;border-radius:999px}
    .badge.ok{background:#193a25;color:#b9f6c3;border:1px solid #2f6243}
    .badge.warn{background:#3a2a19;color:#ffe1b3;border:1px solid #6a4b28}
    .divider{height:1px;background:var(--line);margin:12px 0}
    .chat{display:grid;grid-template-columns:260px 1fr;gap:10px}@media(max-width:900px){.chat{grid-template-columns:1fr}}
    .chat-people{border:1px solid var(--line);border-radius:10px;max-height:360px;overflow:auto}
    .people-item{display:flex;gap:8px;align-items:center;padding:10px;border-bottom:1px solid var(--line);cursor:pointer}
    .people-item .badge{margin-left:auto;background:var(--acc);color:#000;font-weight:800}
    .chat-box{display:grid;grid-template-rows:auto 1fr auto;border:1px solid var(--line);border-radius:10px;min-height:320px}
    .chat-head{display:flex;gap:8px;align-items:center;border-bottom:1px solid var(--line);padding:8px 10px}
    .messages{padding:10px;display:flex;flex-direction:column;gap:6px;max-height:260px;overflow:auto}
    .msg{max-width:80%;padding:8px 10px;border-radius:10px;border:1px solid var(--line)}
    .me{align-self:flex-end;background:#1c1f27}.them{align-self:flex-start;background:#11141b}
    .send{display:flex;gap:8px;border-top:1px solid var(--line);padding:8px}.send input{flex:1}
    .banner{display:none;background:#201a00;color:#ffe58f;border-bottom:1px solid #665500;padding:10px}
    .banner .btn{margin-left:8px;border:0;background:#ffd34d;color:#000;border-radius:8px;padding:6px 10px;font-weight:800}
    .notice{display:none;background:#121a12;border:1px solid #274b27;color:#cbeacb;padding:8px 10px;border-radius:10px;margin:8px}
    #toast{position:fixed;left:50%;transform:translateX(-50%);bottom:18px;background:#000d;border:1px solid var(--line);padding:10px 14px;border-radius:12px;display:none;z-index:90}
    .muted{color:#aeb6c2}.danger-btn{background:var(--danger)!important;color:#000!important}
    /* mini modale */
    .modal{position:fixed;inset:0;background:#0008;display:none;place-items:center;z-index:60}
    .modal.open{display:grid}
    .modal-card{width:min(560px,94vw);background:var(--card);border:1px solid var(--line);border-radius:14px;padding:0 0 18px}
    .tabs{display:flex;gap:6px;align-items:center;border-bottom:1px solid var(--line);padding:10px}
    .tabs button{background:none;border:0;color:#fff;opacity:.7;font-weight:700;padding:10px 12px;border-bottom:2px solid transparent;cursor:pointer}
    .tabs button.active{opacity:1;border-color:var(--acc)} .tabs .close{margin-left:auto;font-size:22px}
    .pane{display:none;padding:18px}.pane.active{display:block}
  </style>
</head>
<body>
  <header>
    <div class="wrap row">
      <div class="logo">üíò LoveNow</div>
      <nav>
        <button id="btnOpenAuth" class="nav-btn">Connexion</button>
        <button id="btnLogout" class="nav-btn danger" style="display:none">Se d√©connecter</button>
      </nav>
    </div>
    <!-- Bandeau global non v√©rifi√© -->
    <div id="verifyBanner" class="banner">
      Ton e-mail n‚Äôest pas v√©rifi√©.
      <button id="btnSendVerify" class="btn">Valider mon e-mail</button>
      <button id="btnRefreshVerify" class="btn">Rafra√Æchir</button>
    </div>
  </header>

  <main id="main">
    <section class="hero">
      <h1>Rencontre l‚Äôamour pr√®s de chez toi</h1>
      <p>Inscris-toi en 2 minutes, d√©couvre des profils r√©els √† proximit√© et commence √† discuter. Gratuit au lancement.</p>
      <button class="cta" id="ctaStart">Rejoins-nous gratuitement</button>
    </section>

    <section id="app" class="wrap" style="display:none">
      <h2>Bienvenue <span id="hiName"></span> üëã</h2>

      <div class="grid g-2">
        <!-- ======= Profil ======= -->
        <div class="card">
          <!-- AVERTISSEMENT / BOUTON AU-DESSUS DU PROFIL -->
          <div id="verifyCard" class="notice" style="display:none">
            <strong>V√©rifie ton e-mail pour profiter de tout üíå</strong><br>
            <button id="btnVerifyCard" class="btn" style="margin-top:6px">Valider mon e-mail</button>
            <button id="btnVerifyCardRefresh" class="btn" style="margin-top:6px">Rafra√Æchir</button>
          </div>

          <h3>Mon profil</h3>
          <form id="editProfileForm" class="form">
            <label>Nom <input id="name" maxlength="30" required></label>
            <label>√Çge <input id="age" type="number" min="18" max="100" required></label>
            <label>Bio (500 max)
              <textarea id="bio" maxlength="500" rows="3" placeholder="Parle un peu de toi‚Ä¶"></textarea>
            </label>
            <div class="row">
              <label class="file"><input type="file" id="avatarFile" accept="image/*"><span>Ajouter/mettre √† jour ma photo</span></label>
              <button type="submit">Enregistrer</button>
            </div>
          </form>
          <div class="avatar-wrap"><img id="avatarPreview" alt="Avatar"/></div>
        </div>

        <!-- ======= D√©couverte + Chat ======= -->
        <div class="card">
          <!-- RAPPEL AU-DESSUS DE LA LISTE DES PROFILS -->
          <div id="verifyStrip" class="banner" style="display:none">
            Tu dois d‚Äôabord valider ton e-mail pour envoyer des messages.
            <button id="btnVerifyStrip" class="btn">Valider mon e-mail</button>
            <button id="btnVerifyStripRefresh" class="btn">Rafra√Æchir</button>
          </div>

          <h3>Profils proches</h3>
          <div id="profilesList" class="list"></div>

          <div class="divider"></div>

          <h3>Chat</h3>
          <div class="chat">
            <div class="chat-people" id="conversationsList"></div>
            <div class="chat-box">
              <div class="chat-head">
                <div id="chatTitle" class="muted">Aucune conversation</div>
                <div id="inviteBox" class="notice"></div>
              </div>
              <div id="messagesList" class="messages"></div>
              <form id="sendMsgForm" class="send">
                <input id="msgInput" placeholder="√âcrire un message‚Ä¶" maxlength="500"/>
                <button type="submit">Envoyer</button>
              </form>
            </div>
          </div>
        </div>
      </div>
    </section>

    <section id="cta" class="wrap">
      <div class="card" style="text-align:center">
        <h2>Pr√™t¬∑e √† tenter ta chance ?</h2>
        <p class="muted">Inscription en 2 minutes. 18+ uniquement.</p>
        <button class="cta" id="ctaOpenAuth2">Cr√©er un compte</button>
      </div>
    </section>
  </main>

  <!-- Auth modal -->
  <div class="modal" id="modalAuth" aria-hidden="true">
    <div class="modal-card">
      <div class="tabs">
        <button data-tab="signup" class="active" type="button">Inscription</button>
        <button data-tab="login" type="button">Connexion</button>
        <button id="closeAuth" class="close" aria-label="Fermer">√ó</button>
      </div>

      <div id="paneSignup" class="pane active">
        <form id="signupForm" class="form">
          <label>Email <input id="suEmail" type="email" required autocomplete="email"></label>
          <label>Mot de passe <input id="suPass" type="password" minlength="6" required autocomplete="new-password"></label>
          <div class="row">
            <label>Nom <input id="suName" maxlength="30" required></label>
            <label>√Çge <input id="suAge" type="number" min="18" max="100" required></label>
          </div>
          <label>Bio (500 max)
            <textarea id="suBio" maxlength="500" rows="3"></textarea>
          </label>
          <label class="file"><input type="file" id="suAvatar" accept="image/*"><span>Photo de profil (optionnel)</span></label>
          <button type="submit">Cr√©er mon compte</button>
        </form>
      </div>

      <div id="paneLogin" class="pane">
        <form id="loginForm" class="form">
          <label>Email <input id="liEmail" type="email" required autocomplete="email"></label>
          <label>Mot de passe <input id="liPass" type="password" minlength="6" required autocomplete="current-password"></label>
          <button type="submit">Se connecter</button>
          <button type="button" id="btnForgot" class="danger-btn" style="margin-top:8px">Mot de passe oubli√©</button>
        </form>
      </div>
    </div>
  </div>

  <div id="toast" role="status" aria-live="polite"></div>

  <script type="module">
    // ===== Utils =====
    const $=(s,c=document)=>c.querySelector(s), $$=(s,c=document)=>Array.from(c.querySelectorAll(s));
    const toast=(m,ms=2400)=>{const t=$("#toast");t.textContent=m;t.style.display="block";setTimeout(()=>t.style.display="none",ms);}
    const sanitize=s=>String(s||"").replace(/[<>]/g,"");
    const chatIdFor=(a,b)=>[a,b].sort().join("_");

    // ===== Firebase =====
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, updateProfile, sendEmailVerification, sendPasswordResetEmail, reload } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getFirestore, doc, setDoc, getDoc, updateDoc, addDoc, collection, query, where, orderBy, limit, getDocs, onSnapshot, serverTimestamp, increment } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    import { initializeAppCheck, ReCaptchaV3Provider } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app-check.js";

    // Cloudinary (unsigned)
    const CLOUD_NAME="dyqxadd0j"; const UPLOAD_PRESET="profile_pics";
    async function uploadImage(file){const fd=new FormData();fd.append("file",file);fd.append("upload_preset",UPLOAD_PRESET);const r=await fetch(`https://api.cloudinary.com/v1_1/${CLOUD_NAME}/image/upload`,{method:"POST",body:fd});if(!r.ok)throw new Error("Upload Cloudinary √©chou√©");return r.json();}

    const firebaseConfig={apiKey:"AIzaSyB_-cNA8bxqYCYUp3rUZs-VpiP4DX2wn3M",authDomain:"lovenow-officiel.firebaseapp.com",projectId:"lovenow-officiel",storageBucket:"lovenow-officiel.firebasestorage.app",messagingSenderId:"896585801571",appId:"1:896585801571:web:cdde87293291dc1900bd56",measurementId:"G-QGM25ND7LF"};
    const app=initializeApp(firebaseConfig);
    initializeAppCheck(app,{provider:new ReCaptchaV3Provider("6LfjpsErAAAAAExN2IvBq-K475TeJooeNzl9liPD"),isTokenAutoRefreshEnabled:true});
    const auth=getAuth(app); const db=getFirestore(app);

    // ===== UI refs =====
    const appWrap=$("#app"), btnLogout=$("#btnLogout"), hiName=$("#hiName");
    const verifyBanner=$("#verifyBanner"), btnVerifyBanner=$("#btnSendVerify"), btnRefreshBanner=$("#btnRefreshVerify");
    const verifyCard=$("#verifyCard"), btnVerifyCard=$("#btnVerifyCard"), btnVerifyCardRefresh=$("#btnVerifyCardRefresh");
    const verifyStrip=$("#verifyStrip"), btnVerifyStrip=$("#btnVerifyStrip"), btnVerifyStripRefresh=$("#btnVerifyStripRefresh");
    const profilesList=$("#profilesList"), convList=$("#conversationsList"), msgsList=$("#messagesList"), sendForm=$("#sendMsgForm"), msgInput=$("#msgInput"), chatTitle=$("#chatTitle"), inviteBox=$("#inviteBox");

    // ===== Modal auth =====
    const modal=$("#modalAuth"); const setTab=w=>{$$("#modalAuth .tabs button").forEach(b=>b.classList.toggle("active",b.dataset.tab===w));$("#paneSignup").classList.toggle("active",w==="signup");$("#paneLogin").classList.toggle("active",w==="login");}
    const openAuth=w=>{modal.classList.add("open");setTab(w||"signup")}; const closeAuth=()=>modal.classList.remove("open");
    $("#btnOpenAuth").onclick=()=>openAuth("signup"); $("#ctaStart").onclick=()=>openAuth("signup"); $("#ctaOpenAuth2").onclick=()=>openAuth("signup"); $("#closeAuth").onclick=closeAuth; modal.addEventListener("click",e=>{if(e.target===modal)closeAuth();});
    $$("#modalAuth .tabs button").forEach(b=>b.addEventListener("click",()=>setTab(b.dataset.tab)));

    // ===== Helpers email verify UI =====
    function updateVerifyUIs(user){
      const verified=!!user?.emailVerified;
      verifyBanner.style.display=verified?"none":"block";
      verifyCard.style.display=verified?"none":"block";
      verifyStrip.style.display=verified?"none":"block";
      msgInput.disabled=!verified;
      // changer les boutons "Message" si non v√©rifi√©
      profilesList.querySelectorAll("button[data-uid]").forEach(b=>{
        if(verified){ b.disabled=false; b.textContent="Message"; b.dataset.action="chat"; }
        else{ b.disabled=false; b.textContent="Valider mon e-mail"; b.dataset.action="verify"; }
      });
    }
    async function syncEmailVerified(user){
      if(!user) return;
      try{
        await updateDoc(doc(db,"users",user.uid),{ emailVerified: !!user.emailVerified, email: user.email || null });
      }catch{}
    }
    async function sendVerify(){
      const u=auth.currentUser; if(!u) return;
      await sendEmailVerification(u,{url:location.origin}); toast("E-mail de validation envoy√©.");
    }
    async function refreshVerify(){
      const u=auth.currentUser; if(!u) return; await reload(u); updateVerifyUIs(u); await syncEmailVerified(u);
    }
    [btnVerifyBanner,btnVerifyCard,btnVerifyStrip].forEach(b=>b.onclick=sendVerify);
    [btnRefreshBanner,btnVerifyCardRefresh,btnVerifyStripRefresh].forEach(b=>b.onclick=refreshVerify);

    // ===== Sign up / login / forgot =====
    $("#signupForm").addEventListener("submit",async e=>{
      e.preventDefault();
      const email=$("#suEmail").value.trim(), pass=$("#suPass").value.trim(), name=sanitize($("#suName").value).slice(0,30), age=parseInt($("#suAge").value,10), bio=sanitize($("#suBio").value).slice(0,500), file=$("#suAvatar").files[0];
      if(age<18){toast("18+ requis");return;}
      try{
        const {user}=await createUserWithEmailAndPassword(auth,email,pass);
        let photoUrl=""; if(file){const up=await uploadImage(file); photoUrl=up.secure_url||"";}
        await setDoc(doc(db,"users",user.uid),{name,age,bio,photoUrl,photos:photoUrl?[photoUrl]:[],createdAt:serverTimestamp(),emailVerified:false,email:user.email});
        await updateProfile(user,{displayName:name,photoURL:photoUrl||null});
        await sendEmailVerification(user,{url:location.origin}); toast("Compte cr√©√©. V√©rifie ton e-mail ‚úâÔ∏è");
        closeAuth();
      }catch(err){ toast(err.message||"Erreur d‚Äôinscription"); }
    });
    $("#loginForm").addEventListener("submit",async e=>{
      e.preventDefault();
      try{ await signInWithEmailAndPassword(auth,$("#liEmail").value.trim(),$("#liPass").value.trim()); closeAuth(); toast("Connect√© !"); }
      catch(err){ toast(err.message||"Erreur de connexion"); }
    });
    $("#btnForgot").onclick=async ()=>{
      const email=$("#liEmail").value.trim(); if(!email){toast("Entre ton e-mail");return;}
      try{ await sendPasswordResetEmail(auth,email,{url:location.origin}); toast("Lien de r√©initialisation envoy√©."); }
      catch(err){ toast(err.message||"Impossible d‚Äôenvoyer le lien"); }
    };
    btnLogout.onclick=()=>signOut(auth);

    // ===== State =====
    let currentPeer=null, currentConv=null, unsubMessages=null, unsubConversations=null;

    onAuthStateChanged(auth, async user=>{
      if(user){
        appWrap.style.display=""; $("#btnOpenAuth").style.display="none"; btnLogout.style.display="";
        $("#hiName").textContent=user.displayName||"toi";
        updateVerifyUIs(user); await syncEmailVerified(user);
        await prefillProfile(); await loadProfiles(); await listenConversations();
      }else{
        appWrap.style.display="none"; $("#btnOpenAuth").style.display=""; btnLogout.style.display="none"; verifyBanner.style.display="none"; stopListening();
      }
    });

    function stopListening(){ if(unsubMessages){unsubMessages();unsubMessages=null;} if(unsubConversations){unsubConversations();unsubConversations=null;} msgsList.innerHTML=""; chatTitle.textContent="Aucune conversation"; }

    // ===== Profil (prefill / save) =====
    async function prefillProfile(){
      const me=auth.currentUser; if(!me) return;
      try{ const s=await getDoc(doc(db,"users",me.uid)); if(s.exists()){const u=s.data(); $("#name").value=u.name||""; $("#age").value=u.age||""; $("#bio").value=u.bio||""; if(u.photoUrl) $("#avatarPreview").src=u.photoUrl;} }catch{}
    }
    $("#editProfileForm").addEventListener("submit",async e=>{
      e.preventDefault(); const me=auth.currentUser; if(!me) return;
      const name=sanitize($("#name").value).slice(0,30), age=parseInt($("#age").value,10), bio=sanitize($("#bio").value).slice(0,500), file=$("#avatarFile").files[0];
      const updates={name,age,bio}; if(file){const up=await uploadImage(file); updates.photoUrl=up.secure_url; updates.photos=[up.secure_url]; $("#avatarPreview").src=up.secure_url;}
      try{ await updateDoc(doc(db,"users",me.uid),updates); await updateProfile(me,{displayName:name,photoURL:updates.photoUrl||me.photoURL||null}); toast("Profil mis √† jour"); await loadProfiles(); }catch(err){ toast(err.message||"Erreur de mise √† jour"); }
    });

    // ===== Profils proches =====
    async function loadProfiles(){
      const me=auth.currentUser; if(!me) return;
      const q=query(collection(db,"users"), orderBy("createdAt","desc"), limit(40));
      const snap=await getDocs(q);
      profilesList.innerHTML="";
      snap.forEach(d=>{
        if(d.id===me.uid) return;
        const u=d.data(); const verified=u.emailVerified===true;
        const div=document.createElement("div"); div.className="item";
        div.innerHTML=`
          <img src="${u.photoUrl||'https://placehold.co/80x80?text=üë§'}" alt="">
          <div class="grow">
            <div><strong>${u.name||"Sans nom"}</strong> ¬∑ ${u.age||"?"} ans
              ${verified?'<span class="badge ok">‚úÖ v√©rifi√©</span>':'<span class="badge warn">‚ö†Ô∏è non v√©rifi√©</span>'}
            </div>
            <div class="sub">${(u.bio||"").slice(0,70)}</div>
          </div>
          <button data-uid="${d.id}" data-action="chat">Message</button>
        `;
        profilesList.appendChild(div);
      });
      // appliquer l‚Äô√©tat v√©rification courant
      updateVerifyUIs(auth.currentUser);
    }

    profilesList.addEventListener("click",async e=>{
      const btn=e.target.closest("button[data-uid]"); if(!btn) return;
      const action=btn.dataset.action;
      if(action==="verify"){ await sendVerify(); return; }
      const me=auth.currentUser; if(!me?.emailVerified){ toast("Valide d‚Äôabord ton e-mail ‚úâÔ∏è"); return; }
      await openChatWith(btn.dataset.uid);
    });

    // ===== Conversations & messages =====
    async function listenConversations(){
      const me=auth.currentUser; if(!me) return;
      if(unsubConversations){unsubConversations();unsubConversations=null;}
      const qConv=query(collection(db,"conversations"), where("members","array-contains",me.uid), orderBy("lastAt","desc"));
      unsubConversations=onSnapshot(qConv,snap=>{
        convList.innerHTML=""; snap.forEach(c=>{
          const data=c.data(); const other=data.members.find(x=>x!==me.uid)||"";
          const unread=(data.unread&&data.unread[me.uid])?data.unread[me.uid]:0;
          const item=document.createElement("div"); item.className="people-item";
          item.innerHTML=`<div><div><strong>${data.lastSenderName||"Conversation"}</strong></div><small class="muted">${new Date(data.lastAt?.toDate?.()||Date.now()).toLocaleString()}</small></div>${unread?`<span class="badge">${unread}</span>`:""}`;
          item.onclick=()=>openChatWith(other); convList.appendChild(item);
        });
      },err=>{toast("Erreur conversations");console.error(err);});
    }

    async function ensureConversation(meUid,peerUid){
      const cid=chatIdFor(meUid,peerUid); const ref=doc(db,"conversations",cid); const s=await getDoc(ref);
      if(!s.exists()){
        await setDoc(ref,{
          members:[meUid,peerUid],
          status:{[meUid]:"accepted",[peerUid]:"pending"},
          lastText:"", lastSender:"", lastSenderName:"", lastAt:serverTimestamp(),
          unread:{[meUid]:0,[peerUid]:0}, createdAt:serverTimestamp()
        });
      }
      return ref;
    }

    async function openChatWith(peerUid){
      const me=auth.currentUser; if(!me) return; currentPeer=peerUid; const cid=chatIdFor(me.uid,peerUid);
      const ref=await ensureConversation(me.uid,peerUid); currentConv=cid;
      chatTitle.textContent="Discussion"; inviteBox.style.display="none"; inviteBox.innerHTML="";
      const convSnap=await getDoc(ref); if(convSnap.exists()){const c=convSnap.data(); const my=c.status?.[me.uid]||"accepted"; const other=c.status?.[peerUid]||"accepted";
        if(my==="pending"){ inviteBox.style.display="block"; inviteBox.innerHTML=`<strong>Invitation re√ßue</strong> ‚Äî accepter ? <div style="margin-top:6px"><button id="btnAccept" class="btn">Accepter</button> <button id="btnRefuse" class="btn danger-btn">Refuser</button></div>`;
          $("#btnAccept").onclick=async()=>{await updateDoc(ref,{["status."+me.uid]:"accepted"}); inviteBox.style.display="none"; toast("Invitation accept√©e ‚úÖ");};
          $("#btnRefuse").onclick=async()=>{await updateDoc(ref,{["status."+me.uid]:"blocked"}); toast("Conversation bloqu√©e");}; }
        else if(other==="pending"){ inviteBox.style.display="block"; inviteBox.textContent="En attente d‚Äôacceptation‚Ä¶"; }
      }
      listenMessages(); try{ await updateDoc(doc(db,"conversations",cid),{["unread."+me.uid]:0}); }catch{}
    }

    function listenMessages(){
      if(unsubMessages){unsubMessages();unsubMessages=null;}
      const me=auth.currentUser; if(!me||!currentPeer) return; const cid=chatIdFor(me.uid,currentPeer);
      const qMsg=query(collection(db,"messages"), where("chatId","==",cid), orderBy("createdAt","asc"), limit(500));
      unsubMessages=onSnapshot(qMsg,snap=>{ msgsList.innerHTML=""; snap.forEach(d=>{const m=d.data(); const div=document.createElement("div"); div.className="msg "+(m.senderId===me.uid?"me":"them"); div.textContent=m.text; msgsList.appendChild(div);}); msgsList.scrollTop=msgsList.scrollHeight; },err=>{toast("Erreur de lecture des messages.");console.error(err);});
    }

    sendForm.addEventListener("submit",async e=>{
      e.preventDefault(); const me=auth.currentUser; if(!me||!currentPeer){toast("Choisis un profil");return;}
      if(!me.emailVerified){toast("Valide d‚Äôabord ton e-mail ‚úâÔ∏è");return;}
      const text=sanitize(msgInput.value.trim()); if(!text) return; if(text.length>500){toast("500 caract√®res max");return;}
      const cid=chatIdFor(me.uid,currentPeer); const ref=doc(db,"conversations",cid); const s=await getDoc(ref); const st=s.data()?.status||{};
      if(st[me.uid]!=="accepted"||st[currentPeer]==="blocked"){toast("Invitation non accept√©e.");return;}
      await addDoc(collection(db,"messages"),{chatId:cid,senderId:me.uid,receiverId:currentPeer,text,createdAt:serverTimestamp()});
      try{await updateDoc(ref,{lastText:text,lastSender:me.uid,lastSenderName:me.displayName||"Quelqu‚Äôun",lastAt:serverTimestamp(),["unread."+currentPeer]:increment(1)});}catch{}
      msgInput.value="";
    });
  </script>
</body>
</html>