<!doctype html>
<html lang="fr" data-theme="light">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>LoveNow — Rencontres 100% simples, 18+</title>
  <meta name="description" content="Rencontrez des profils près de chez vous. Gratuit au départ, 18+. Filtres par ville, âge et plus.">
  <link rel="canonical" href="https://lovenow.netlify.app/">
  <meta property="og:title" content="LoveNow — Rencontres 18+">
  <meta property="og:description" content="Profils en temps réel, messages sécurisés.">
  <meta property="og:url" content="https://lovenow.netlify.app/">
    <meta property="og:image" content="/assets/og-default.jpg">
    <meta name="twitter:card" content="summary_large_image">
    <link rel="stylesheet" href="/styles/tokens.css">
    <link rel="stylesheet" href="/styles/components.css">
    <link rel="icon" href="/assets/brand/logo.svg" type="image/svg+xml">
  <script src="config.js"></script>
</head>
<body>
  <header>
    <div class="wrap">
      <nav aria-label="Navigation principale">
        <a href="/" aria-label="Accueil">
          <img src="/assets/brand/logo.svg" alt="LoveNow" style="height:32px" />
        </a>
        <div class="grow"></div>
        <a href="/#discover" class="ghost btn">Découvrir</a>
        <a href="/conversations.html" class="ghost btn">Conversations</a>
        <a href="/profile.html" class="ghost btn">Mon profil</a>
        <a href="/privacy.html" class="ghost btn">Confidentialité</a>
        <a href="/cgu.html" class="ghost btn">CGU</a>
        <span id="header-session"><a href="/login.html#signup" class="btn">Rejoins-nous gratuitement</a></span>
      </nav>
    </div>
  </header>

  <div id="verifyBanner" class="banner" hidden>
    <div>Adresse e-mail non vérifiée.</div>
    <div style="display:flex;gap:8px">
      <button id="btnResend" class="btn">Envoyer le lien</button>
      <button id="btnRefresh" class="btn">Rafraîchir</button>
    </div>
  </div>

  <main>
    <section class="hero">
      <div class="wrap">
        <h1>Rencontrez en toute simplicité — réservé aux 18+</h1>
        <p class="lead">Des profils proches de chez vous. Filtres clairs, messages sécurisés, confidentialité maîtrisée.</p>
        <p>
          <a class="btn" href="/login.html#signup">Créer mon compte</a>
          <a class="btn ghost" href="/#discover">Découvrir des profils</a>
        </p>
      </div>
    </section>

    <section id="discover" aria-labelledby="discover-title">
      <div class="wrap">
        <h2 id="discover-title">Découvrir des profils</h2>
        <form id="filters" class="filters" onsubmit="return false">
          <div>
            <label for="gender">Genre</label>
            <select id="gender" name="gender">
              <option value="">Tous</option>
              <option value="f">Femme</option>
              <option value="m">Homme</option>
              <option value="o">Autre</option>
            </select>
          </div>
          <div>
            <label for="ageMin">Âge min</label>
            <input id="ageMin" name="ageMin" type="number" min="18" max="99" inputmode="numeric" placeholder="18">
          </div>
          <div>
            <label for="ageMax">Âge max</label>
            <input id="ageMax" name="ageMax" type="number" min="18" max="99" inputmode="numeric" placeholder="35">
          </div>
          <div>
            <label for="city">Ville</label>
            <input id="city" name="city" type="text" placeholder="Paris, Lyon…">
          </div>
          <div class="actions">
            <button class="btn" id="btnSearch" type="button">Rechercher</button>
            <button class="btn ghost" id="btnReset" type="button">Réinitialiser</button>
          </div>
        </form>
        <div id="results" class="cards" aria-live="polite"></div>
        <p id="empty-hint" class="muted" style="display:none">Ajuste les filtres ou complète ton profil pour voir plus de résultats.</p>
      </div>
    </section>
  </main>

  <div id="toast" role="status" aria-live="polite"></div>

  <footer>
    <div class="wrap" style="padding:24px 16px;color:#666">
      <small>© LoveNow — <a href="/privacy.html">Confidentialité</a> · <a href="/cgu.html">CGU</a></small>
    </div>
  </footer>

  <script type="module">
    const cfg = window.APP_CONFIG?.firebase;
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut, sendEmailVerification } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
    import { getFirestore, collection, query, where, orderBy, limit, getDocs } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    const app = initializeApp(cfg);
    loadAppCheck(app);
    const auth = getAuth(app);
    const db   = getFirestore(app);

    const $ = s=>document.querySelector(s);
    const resultsEl=$('#results'), emptyHintEl=$('#empty-hint'), toast=$('#toast');
    const verifyBanner=$('#verifyBanner'), btnResend=$('#btnResend'), btnRefresh=$('#btnRefresh');

    let currentUser=null;

    const showToast = msg=>{toast.textContent=msg;toast.style.display='block';setTimeout(()=>toast.style.display='none',2200);};
    function renderSkeletons(n=6){resultsEl.innerHTML=Array.from({length:n}).map(()=>'<div class="skel" aria-hidden="true"></div>').join('');emptyHintEl.style.display='block';}
    const DEMO=[
      {uid:'demo1',name:'Alice',age:25,city:'Paris',bio:'Profil démo'},
      {uid:'demo2',name:'Bob',age:30,city:'Lyon',bio:'Profil démo'}
    ];
    function renderCards(items){
      if(!items.length){renderSkeletons();return;}
      emptyHintEl.style.display='none';
      resultsEl.innerHTML=items.map(p=>{
        const id=p.uid||p.id||'';
        const viewLink=currentUser?`/profile-public.html?id=${id}`:'/login.html#login';
        return `<article class="card" tabindex="0" aria-label="Profil">
          <div style="font-weight:700">${p.name||p.displayName||'—'}</div>
          <div class="muted">${(p.age??'—')} ans · ${p.city||'—'}</div>
          <p>${p.bio||'—'}</p>
          <div class="actions"><a class="btn ghost" href="${viewLink}">Voir le profil</a><button class="btn btnMessage" data-uid="${id}">Message</button></div>
        </article>`;
      }).join('');
      resultsEl.querySelectorAll('.btnMessage').forEach(btn=>{
        btn.addEventListener('click',()=>{
          const uid=btn.dataset.uid;
          if(!currentUser){ location.href='/login.html#login'; return; }
          if(!currentUser.emailVerified){ verifyBanner.hidden=false; showToast('Vérifie ton e-mail pour discuter.'); return; }
          location.href=`/conversations.html?startWith=${uid}`;
        });
      });
    }

    async function fetchProfiles(filters={}){
      const clauses=[];
      if(filters.gender) clauses.push(where('gender','==',filters.gender));
      if(filters.city) clauses.push(where('city','==',filters.city));
      const q=query(collection(db,'profiles'),...clauses,orderBy('createdAt','desc'),limit(200));
      const snap=await getDocs(q);
      return snap.docs.map(d=>d.data());
    }
    function filterByAge(list){
      const min=parseInt($('#ageMin').value,10);
      const max=parseInt($('#ageMax').value,10);
      return list.filter(p=>{
        const a=parseInt(p.age,10);
        if(Number.isFinite(min) && a<min) return false;
        if(Number.isFinite(max) && a>max) return false;
        return true;
      });
    }
    async function apply(filters){
      renderSkeletons();
      try{
        const list=await fetchProfiles(filters);
        const final=filterByAge(list);
        renderCards(final.length?final:DEMO);
      }catch(e){console.error(e);renderCards(DEMO);}
    }

    const state={filters:{}};
    document.getElementById('btnSearch').onclick=()=>{
      const f=document.getElementById('filters');
      state.filters={gender:f.gender.value.trim(),city:f.city.value.trim()};
      const p=new URLSearchParams();
      const vals={gender:state.filters.gender,ageMin:f.ageMin.value.trim(),ageMax:f.ageMax.value.trim(),city:state.filters.city};
      for(const [k,v] of Object.entries(vals)){if(v) p.set(k,v);} history.replaceState({},'',p.toString()?`?${p}`:location.pathname);
      apply(state.filters);
    };
    document.getElementById('btnReset').onclick=()=>{document.getElementById('filters').reset();state.filters={};history.replaceState({},'',location.pathname);renderCards([]);showToast('Filtres réinitialisés');};

    renderSkeletons();
    apply(state.filters);

    onAuthStateChanged(auth, user=>{
      currentUser=user;
      const slot=document.getElementById('header-session');
      if(user){
        const initial=(user.displayName||user.email||'?')[0].toUpperCase();
        slot.innerHTML=`<a href="/profile.html" class="ghost btn">${initial}</a> <button class="ghost btn" id="btnSignOut">Se déconnecter</button>`;
        document.getElementById('btnSignOut').onclick=()=>signOut(auth);
        if(!user.emailVerified){
          verifyBanner.hidden=false;
          btnResend.onclick=async()=>{
            try{const actionCodeSettings={url:'https://lovenow.netlify.app/login.html?verified=1',handleCodeInApp:false};await sendEmailVerification(user,actionCodeSettings);alert('Lien envoyé ✅');}catch(e){alert('Échec envoi lien');}
          };
          btnRefresh.onclick=()=>location.reload();
        }else{
          verifyBanner.hidden=true;
        }
      }else{
        slot.innerHTML=`<a href="/login.html#signup" class="btn">Rejoins-nous gratuitement</a>`;
        verifyBanner.hidden=true;
      }
    });
  </script>
  <script>loadCrispIfEnabled();</script>
</body>
</html>