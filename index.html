<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>LoveNow ‚Äî Rencontres gratuites, proches de toi</title>
  <meta name="description" content="LoveNow : rencontres gratuites et locales. Inscris-toi en 2 minutes, d√©couvre des profils proches, discute en toute confiance.">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#0d0d10; --card:#151921; --line:#222a35; --txt:#f6f8fa; --muted:#aeb6c2;
      --acc:#ff4d6d; --acc2:#8f51ea; --acc3:#ff6bb5; --ok:#30d158; --danger:#ff6464;
    }
    *{box-sizing:border-box}
    html,body{margin:0;background:var(--bg);color:var(--txt);font-family:'Poppins',system-ui,Segoe UI,Arial,sans-serif}
    a{color:var(--acc3);text-decoration:none}
    .wrap{max-width:1100px;margin:0 auto;padding:16px 18px}
    header{position:sticky;top:0;z-index:50;backdrop-filter:saturate(140%) blur(8px);
      background:linear-gradient(180deg,rgba(0,0,0,.7),rgba(0,0,0,.45));border-bottom:1px solid var(--line)}
    .row{display:flex;gap:14px;align-items:center;justify-content:space-between}
    .logo{font-weight:800;letter-spacing:.3px;color:var(--acc)}
    .nav-btn{border:1px solid #ffffffaa;padding:8px 14px;border-radius:999px;background:none;color:#fff;cursor:pointer}
    .nav-btn:hover{background:#fff;color:#000}
    .nav-btn.danger{border-color:var(--danger)}
    .hero{display:grid;place-items:center;min-height:64vh;text-align:center;padding:30px 18px;
      background:radial-gradient(1000px 500px at 15% 10%,rgba(255,77,109,.2),transparent 60%),
                 radial-gradient(1000px 500px at 85% 10%,rgba(143,81,234,.25),transparent 60%),
                 linear-gradient(135deg,var(--acc),var(--acc3),var(--acc2))}
    .hero h1{font-size:clamp(28px,6vw,48px);margin:6px 0 10px;font-weight:800}
    .hero p{max-width:640px;margin:0 auto 18px;color:#fff;opacity:.95}
    .cta{display:inline-block;background:#fff;color:#000;font-weight:800;border-radius:999px;padding:14px 28px;border:0;cursor:pointer}
    .uspbar{display:flex;gap:10px;justify-content:center;margin-top:14px;flex-wrap:wrap}
    .pill{border:1px solid #ffffff80;color:#fff;padding:6px 12px;border-radius:999px;font-size:12px;opacity:.9}
    section{padding:40px 18px}
    h2{margin:0 0 12px}
    .muted{color:var(--muted)}
    .grid{display:grid;gap:16px}
    .g-2{grid-template-columns:repeat(2,1fr)}
    @media(max-width:900px){.g-2{grid-template-columns:1fr}}
    .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:18px}
    .form{display:grid;gap:10px}
    .form input,.form textarea{width:100%;border-radius:10px;border:1px solid var(--line);background:#0f1320;color:#fff;padding:10px}
    .form button{border:0;border-radius:10px;padding:12px 16px;background:var(--acc);color:#000;font-weight:800;cursor:pointer}
    .file input{display:none}
    .file span{display:inline-block;border:1px dashed var(--line);padding:10px;border-radius:10px;cursor:pointer}
    .avatar-wrap{margin-top:10px;text-align:center}
    .avatar-wrap img{width:120px;height:120px;border-radius:50%;object-fit:cover;border:2px solid var(--line)}
    .list{display:grid;gap:8px;max-height:280px;overflow:auto}
    .item{display:flex;align-items:center;gap:10px;border:1px solid var(--line);padding:10px;border-radius:10px}
    .item img{width:44px;height:44px;border-radius:50%;object-fit:cover}
    .item .grow{flex:1}
    .item button{padding:8px 10px;border:0;border-radius:999px;background:var(--acc);font-weight:700}
    .divider{height:1px;background:var(--line);margin:12px 0}
    .chat{display:grid;grid-template-columns:240px 1fr;gap:10px}
    @media(max-width:900px){.chat{grid-template-columns:1fr}}
    .chat-people{border:1px solid var(--line);border-radius:10px;max-height:320px;overflow:auto}
    .people-item{padding:10px;border-bottom:1px solid var(--line);cursor:pointer;display:flex;gap:8px;align-items:center}
    .badge{display:inline-block;background:#fff;color:#000;font-size:11px;border-radius:999px;padding:2px 8px;margin-left:auto}
    .chat-box{display:grid;grid-template-rows:auto 1fr auto;border:1px solid var(--line);border-radius:10px}
    .chat-head{padding:10px;border-bottom:1px solid var(--line);display:flex;gap:8px;align-items:center}
    .messages{padding:10px;display:flex;flex-direction:column;gap:6px;max-height:280px;overflow:auto}
    .msg{max-width:80%;padding:8px 10px;border-radius:10px;border:1px solid var(--line)}
    .me{align-self:flex-end;background:#1c1f27}
    .them{align-self:flex-start;background:#11141b}
    .send{display:flex;gap:8px;border-top:1px solid var(--line);padding:8px}
    .send input{flex:1}
    .footer{padding:24px 18px;border-top:1px solid var(--line);text-align:center;color:var(--muted);font-size:14px}
    #toast{position:fixed;left:50%;transform:translateX(-50%);bottom:18px;background:#000d;border:1px solid var(--line);
      padding:10px 14px;border-radius:12px;display:none;z-index:200}
    .sr-only{position:absolute;left:-99999px;top:auto;width:1px;height:1px;overflow:hidden}

    .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.55);z-index:100}
    .modal.open{display:flex}
    .modal-card{min-width:320px;max-width:580px;background:var(--card);border:1px solid var(--line);border-radius:14px}
    .tabs{display:flex;gap:8px;align-items:center;padding:10px}
    .tabs button{background:#0f1320;color:#fff;border:1px solid var(--line);padding:8px 12px;border-radius:8px;cursor:pointer}
    .tabs button.active{outline:2px solid var(--acc)}
    .close{margin-left:auto;background:none;border:0;color:#fff;font-size:22px;cursor:pointer}
    .pane{display:none;padding:10px}
    .pane.active{display:block}

    .bar{display:none;padding:10px;text-align:center;background:#ffeecc;color:#000;border-bottom:1px solid #e1c17a}
    .bar.show{display:block}
    .bar .btn{margin-left:8px;padding:6px 10px;border-radius:8px;border:0;background:#111;color:#fff;cursor:pointer}
  </style>
</head>
<body>
  <a class="sr-only" href="#main">Aller au contenu</a>

  <div id="verifyBar" class="bar">
    ‚úâÔ∏è Adresse e-mail non v√©rifi√©e.
    <button id="btnResendVerify" class="btn">Renvoyer le mail</button>
    <button id="btnIveVerified" class="btn">J‚Äôai v√©rifi√©</button>
  </div>

  <header>
    <div class="wrap row">
      <div class="logo" aria-label="LoveNow">üíò LoveNow</div>
      <nav aria-label="Navigation">
        <button id="btnOpenAuth" class="nav-btn">Connexion</button>
        <button id="btnLogout" class="nav-btn danger" style="display:none">Se d√©connecter</button>
      </nav>
    </div>
  </header>

  <main id="main">
    <section class="hero">
      <h1>Rencontre l‚Äôamour pr√®s de chez toi</h1>
      <p>Inscris-toi en 2 minutes, d√©couvre des profils r√©els √† proximit√© et commence √† discuter. 100% gratuit au lancement.</p>
      <button class="cta" id="ctaStart">Rejoins-nous gratuitement</button>
      <div class="uspbar">
        <span class="pill">üî• Gratuit au d√©part</span>
        <span class="pill">üìç Local & rapide</span>
        <span class="pill">üîí S√©curit√© & respect</span>
      </div>
    </section>

    <section id="app" class="wrap" style="display:none">
      <h2>Bienvenue <span id="hiName"></span> üëã</h2>

      <div class="grid g-2">
        <!-- PROFIL -->
        <div class="card">
          <h3>Mon profil</h3>
          <form id="editProfileForm" class="form">
            <label>Nom
              <input id="name" name="name" maxlength="30" required>
            </label>
            <label>√Çge
              <input id="age" name="age" type="number" min="18" max="100" required>
            </label>
            <label>Bio (500 max)
              <textarea id="bio" name="bio" maxlength="500" rows="3" placeholder="Parle un peu de toi‚Ä¶"></textarea>
            </label>
            <div class="row">
              <label class="file">
                <input type="file" id="avatarFile" accept="image/*">
                <span>Ajouter/mettre √† jour ma photo</span>
              </label>
              <button type="submit">Enregistrer</button>
            </div>
          </form>
          <div class="avatar-wrap">
            <img id="avatarPreview" alt="Avatar" />
          </div>
        </div>

        <!-- LISTES + CHAT -->
        <div class="card">
          <h3>Profils proches</h3>
          <div id="profilesList" class="list"></div>

          <div class="divider"></div>

          <h3>Invitations</h3>
          <div id="requestsList" class="list"></div>

          <div class="divider"></div>

          <h3>Chat</h3>
          <div class="chat">
            <div class="chat-people">
              <div id="conversationsList"></div>
            </div>
            <div class="chat-box">
              <div class="chat-head">
                <div id="chatTitle" class="muted">Pas de conversation ouverte</div>
                <span id="chatStatus" class="pill" style="margin-left:auto;display:none"></span>
                <button id="btnAccept" class="nav-btn" style="display:none">Accepter</button>
                <button id="btnDecline" class="nav-btn danger" style="display:none">Refuser</button>
              </div>
              <div id="messagesList" class="messages"></div>
              <form id="sendMsgForm" class="send">
                <input id="msgInput" placeholder="√âcrire un message‚Ä¶" maxlength="500" />
                <button type="submit">Envoyer</button>
              </form>
            </div>
          </div>
        </div>
      </div>
    </section>

    <section id="cta" class="wrap">
      <div class="card" style="text-align:center">
        <h2>Pr√™t¬∑e √† tenter ta chance ?</h2>
        <p class="muted">Inscription en 2 minutes. 18+ uniquement.</p>
        <button class="cta" id="ctaOpenAuth2">Cr√©er un compte</button>
      </div>
    </section>
  </main>

  <footer>
    <div class="wrap footer">
      ¬© 2025 LoveNow ‚Äî <a href="#">Mentions l√©gales</a> ¬∑ <a href="#">Confidentialit√©</a> ¬∑ 18+ uniquement
    </div>
  </footer>

  <!-- MODALE AUTH -->
  <div class="modal" id="modalAuth" aria-hidden="true" role="dialog" aria-label="Authentification">
    <div class="modal-card">
      <div class="tabs">
        <button data-tab="signup" class="active" type="button">Inscription</button>
        <button data-tab="login" type="button">Connexion</button>
        <button id="closeAuth" class="close" aria-label="Fermer">√ó</button>
      </div>

      <div id="paneSignup" class="pane active">
        <form id="signupForm" class="form">
          <label>Email <input id="suEmail" type="email" required autocomplete="email"></label>
          <label>Mot de passe <input id="suPass" type="password" minlength="6" required autocomplete="new-password"></label>
          <div class="row">
            <label>Nom <input id="suName" maxlength="30" required></label>
            <label>√Çge <input id="suAge" type="number" min="18" max="100" required></label>
          </div>
          <label>Bio (500 max)
            <textarea id="suBio" maxlength="500" rows="3" placeholder="Parle un peu de toi‚Ä¶"></textarea>
          </label>
          <label class="file">
            <input type="file" id="suAvatar" accept="image/*">
            <span>Photo de profil (optionnel)</span>
          </label>
          <button type="submit">Cr√©er mon compte</button>
        </form>
      </div>

      <div id="paneLogin" class="pane">
        <form id="loginForm" class="form">
          <label>Email <input id="liEmail" type="email" required autocomplete="email"></label>
          <label>Mot de passe <input id="liPass" type="password" minlength="6" required autocomplete="current-password"></label>
          <div style="display:flex;gap:10px;align-items:center">
            <button type="submit">Se connecter</button>
            <button id="btnForgot" type="button" class="nav-btn">Mot de passe oubli√©</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- TOAST -->
  <div id="toast" role="status" aria-live="polite"></div>

  <script type="module">
    // Helpers
    const $  = (sel, ctx=document) => ctx.querySelector(sel);
    const $$ = (sel, ctx=document) => Array.from(ctx.querySelectorAll(sel));
    function toast(msg, ms=2200){ const t=$("#toast"); t.textContent=msg; t.style.display="block"; setTimeout(()=>t.style.display="none", ms); }
    const sanitize = (s="") => s.replace(/[<>]/g,"");
    const chatIdFor = (a,b) => [a,b].sort().join("_");

    // UI Auth modal
    const modal = $("#modalAuth");
    function openAuth(which="signup"){ modal.classList.add("open"); setTab(which); }
    function closeAuth(){ modal.classList.remove("open"); }
    $("#btnOpenAuth")?.addEventListener("click", ()=> openAuth("signup"));
    $("#ctaStart")?.addEventListener("click", ()=> openAuth("signup"));
    $("#ctaOpenAuth2")?.addEventListener("click", ()=> openAuth("signup"));
    $("#closeAuth")?.addEventListener("click", closeAuth);
    modal.addEventListener("click", (e)=>{ if(e.target===modal) closeAuth(); });

    const tabs = $$("#modalAuth .tabs button");
    function setTab(which){
      tabs.forEach(b=> b.classList.toggle("active", b.dataset.tab===which));
      $("#paneSignup").classList.toggle("active", which==="signup");
      $("#paneLogin").classList.toggle("active", which==="login");
    }
    tabs.forEach(b=> b.addEventListener("click", ()=> setTab(b.dataset.tab)));

    // ==== Cloudinary (unsigned)
    const CLOUD_NAME   = "dyqxadd0j";
    const UPLOAD_PRESET= "profile_pics";
    async function uploadImage(file){
      const url = `https://api.cloudinary.com/v1_1/${CLOUD_NAME}/image/upload`;
      const fd  = new FormData();
      fd.append("file", file);
      fd.append("upload_preset", UPLOAD_PRESET);
      const r = await fetch(url, { method:"POST", body: fd });
      if(!r.ok) throw new Error("Upload Cloudinary √©chou√©");
      return r.json();
    }

    // ==== Firebase (CDN)
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-analytics.js";
    import {
      getAuth, onAuthStateChanged, createUserWithEmailAndPassword,
      signInWithEmailAndPassword, signOut, updateProfile,
      sendEmailVerification, sendPasswordResetEmail, reload
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import {
      getFirestore, doc, setDoc, getDoc, updateDoc, addDoc,
      collection, query, where, orderBy, limit, getDocs, onSnapshot,
      serverTimestamp, arrayUnion, arrayRemove
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    import { initializeAppCheck, ReCaptchaV3Provider } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app-check.js";

    // Config (ton projet)
    const firebaseConfig = {
      apiKey: "AIzaSyB_-cNA8bxqYCYUp3rUZs-VpiP4DX2wn3M",
      authDomain: "lovenow-officiel.firebaseapp.com",
      projectId: "lovenow-officiel",
      storageBucket: "lovenow-officiel.firebasestorage.app",
      messagingSenderId: "896585801571",
      appId: "1:896585801571:web:cdde87293291dc1900bd56",
      measurementId: "G-QGM25ND7LF"
    };
    const RECAPTCHA_SITE_KEY = "6LfjpsErAAAAAExN2IvBq-K475TeJooeNzl9liPD";

    const app = initializeApp(firebaseConfig);
    try{ getAnalytics(app); }catch{}
    initializeAppCheck(app, {
      provider: new ReCaptchaV3Provider(RECAPTCHA_SITE_KEY),
      isTokenAutoRefreshEnabled: true
    });

    const auth = getAuth(app);
    const db   = getFirestore(app);

    // Refs UI principales
    const verifyBar = $("#verifyBar");
    const btnResendVerify = $("#btnResendVerify");
    const btnIveVerified  = $("#btnIveVerified");
    const appWrap   = $("#app");
    const btnLogout = $("#btnLogout");
    const hiName    = $("#hiName");
    const profilesList = $("#profilesList");
    const convList  = $("#conversationsList");
    const reqList   = $("#requestsList");
    const msgsList  = $("#messagesList");
    const sendForm  = $("#sendMsgForm");
    const msgInput  = $("#msgInput");
    const chatTitle = $("#chatTitle");
    const chatStatus= $("#chatStatus");
    const btnAccept = $("#btnAccept");
    const btnDecline= $("#btnDecline");

    // ==== Auth: inscription
    $("#signupForm")?.addEventListener("submit", async (e)=>{
      e.preventDefault();
      const email = $("#suEmail").value.trim();
      const pass  = $("#suPass").value.trim();
      const name  = sanitize($("#suName").value.trim()).slice(0,30);
      const age   = parseInt($("#suAge").value,10);
      const bio   = sanitize($("#suBio").value.trim()).slice(0,500);
      const file  = $("#suAvatar").files[0];
      if(age < 18){ toast("18+ requis"); return; }
      try{
        const cred = await createUserWithEmailAndPassword(auth, email, pass);
        const uid = cred.user.uid;

        // Upload photo si fournie
        let photoUrl = "";
        if(file){ const up = await uploadImage(file); photoUrl = up.secure_url || ""; }

        // Doc user
        await setDoc(doc(db,"users",uid), {
          name, age, bio, createdAt: serverTimestamp(),
          photoUrl, photos: photoUrl ? [photoUrl] : []
        });

        await updateProfile(cred.user, { displayName: name, photoURL: photoUrl || null });

        // V√©rification e-mail
        await sendEmailVerification(cred.user);
        toast("Compte cr√©√©. V√©rifie ton e-mail !");
        closeAuth();
      }catch(err){
        if(err.code === "auth/email-already-in-use"){
          toast("Adresse d√©j√† utilis√©e ‚Äî utilisez la connexion.");
          setTab("login");
        }else{
          toast(err.message || "Erreur d‚Äôinscription");
        }
      }
    });

    // Connexion
    $("#loginForm")?.addEventListener("submit", async (e)=>{
      e.preventDefault();
      const email = $("#liEmail").value.trim();
      const pass  = $("#liPass").value.trim();
      try{
        await signInWithEmailAndPassword(auth, email, pass);
        toast("Connect√© !");
        closeAuth();
      }catch(err){ toast(err.message || "Erreur de connexion"); }
    });

    // Mot de passe oubli√©
    $("#btnForgot")?.addEventListener("click", async ()=>{
      const email = $("#liEmail").value.trim();
      if(!email){ toast("Entre d‚Äôabord ton e-mail"); return; }
      try{
        await sendPasswordResetEmail(auth, email);
        toast("Lien de r√©initialisation envoy√©.");
      }catch(err){ toast(err.message || "Erreur d‚Äôenvoi"); }
    });

    // D√©connexion
    btnLogout?.addEventListener("click", async ()=>{ await signOut(auth); });

    // V√©rif e-mail bar
    btnResendVerify.addEventListener("click", async ()=>{
      const user = auth.currentUser; if(!user) return;
      await sendEmailVerification(user);
      toast("Mail envoy√©.");
    });
    btnIveVerified.addEventListener("click", async ()=>{
      const user = auth.currentUser; if(!user) return;
      await reload(user);
      if(user.emailVerified){ toast("Merci !"); verifyBar.classList.remove("show"); }
      else toast("Toujours non v√©rifi√©.");
    });

    // === √âtat Auth
    onAuthStateChanged(auth, async (user)=>{
      if(user){
        btnLogout.style.display = "";
        appWrap.style.display = "";
        $("#btnOpenAuth").style.display = "none";
        hiName.textContent = user.displayName || "toi";
        verifyBar.classList.toggle("show", !user.emailVerified);

        // Pr√©remplissage
        try{
          const snap = await getDoc(doc(db,"users",user.uid));
          if(snap.exists()){
            const u = snap.data();
            $("#name").value = u.name || "";
            $("#age").value  = u.age || "";
            $("#bio").value  = u.bio || "";
            if(u.photoUrl) $("#avatarPreview").src = u.photoUrl;
          }
        }catch{}
        loadProfiles();
        listenMyConversations();
        listRequests();
      }else{
        btnLogout.style.display = "none";
        appWrap.style.display = "none";
        $("#btnOpenAuth").style.display = "";
        verifyBar.classList.remove("show");
      }
    });

    // === Mise √† jour profil
    $("#editProfileForm")?.addEventListener("submit", async (e)=>{
      e.preventDefault();
      const user = auth.currentUser; if(!user) return;
      const name = sanitize($("#name").value.trim()).slice(0,30);
      const age  = parseInt($("#age").value,10);
      const bio  = sanitize($("#bio").value.trim()).slice(0,500);
      const file = $("#avatarFile").files[0];
      try{
        const updates = { name, age, bio };
        if(file){
          const up = await uploadImage(file);
          updates.photoUrl = up.secure_url;
          updates.photos   = [up.secure_url];
          $("#avatarPreview").src = up.secure_url;
        }
        await updateDoc(doc(db,"users",user.uid), updates);
        await updateProfile(user, { displayName: name, photoURL: updates.photoUrl || user.photoURL || null });
        toast("Profil mis √† jour");
        loadProfiles();
      }catch(err){ toast(err.message || "Erreur de mise √† jour"); }
    });

    // === Profils
    async function loadProfiles(){
      const me = auth.currentUser; if(!me) return;
      try{
        const q = query(collection(db,"users"), orderBy("createdAt","desc"), limit(50));
        const snap = await getDocs(q);
        profilesList.innerHTML = "";
        snap.forEach(d=>{
          if(d.id === me.uid) return;
          const u = d.data();
          const div = document.createElement("div");
          div.className = "item";
          div.innerHTML = `
            <img src="${u.photoUrl || 'https://placehold.co/80x80?text=üë§'}" alt="">
            <div class="grow">
              <div><strong>${u.name || "Sans nom"}</strong> ¬∑ ${u.age || "?"} ans</div>
              <div class="muted">${(u.bio||"").slice(0,70)}</div>
            </div>
            <button data-uid="${d.id}">Message</button>
          `;
          profilesList.appendChild(div);
        });
      }catch(err){ console.warn(err); }
    }

    profilesList.addEventListener("click", async (e)=>{
      const btn = e.target.closest("button[data-uid]");
      if(!btn) return;
      openChatWith(btn.dataset.uid, true); // true => cr√©er demande si inexistante
    });

    // === Conversations (invitations + liste)
    let currentPeer = null;
    let currentCid  = null;
    let unsubMessages = null;
    let unsubConvList = null;

    function listenMyConversations(){
      const me = auth.currentUser; if(!me) return;
      if(unsubConvList) { unsubConvList(); unsubConvList = null; }
      const qConv = query(collection(db,"conversations"), where("members","array-contains", me.uid), orderBy("lastAt","desc"));
      unsubConvList = onSnapshot(qConv, snap=>{
        convList.innerHTML = "";
        snap.forEach(docu=>{
          const c = docu.data();
          const other = c.members.find(x=>x!==me.uid) || "inconnu";
          const div = document.createElement("div");
          div.className = "people-item";
          const unread = (c.unread && c.unread[me.uid]) ? `<span class="badge">${c.unread[me.uid]}</span>` : "";
          div.innerHTML = `<span>${other.slice(0,6)}‚Ä¶</span>${unread}`;
          div.addEventListener("click", ()=> openChatWith(other, false, docu.id));
          convList.appendChild(div);
        });
      }, err=> toast("Erreur de lecture des conversations"));
    }

    function listRequests(){
      const me = auth.currentUser; if(!me) return;
      const qR = query(collection(db,"conversations"), where("members","array-contains", me.uid), orderBy("lastAt","desc"));
      onSnapshot(qR, (snap)=>{
        reqList.innerHTML = "";
        snap.forEach(d=>{
          const c = d.data();
          const accepted = (c.accepted||[]);
          const iAmAccepted = accepted.includes(me.uid);
          const bothAccepted = accepted.length===2;
          if(bothAccepted) return;
          // Si je ne suis pas accept√© => j'ai une demande √† accepter
          if(!iAmAccepted){
            const other = c.members.find(x=>x!==me.uid);
            const row = document.createElement("div");
            row.className="item";
            row.innerHTML = `
              <div class="grow"><strong>Invitation</strong> de ${other.slice(0,6)}‚Ä¶</div>
              <button data-accept="${d.id}">Accepter</button>
              <button class="danger" data-decline="${d.id}">Refuser</button>
            `;
            reqList.appendChild(row);
          }
        });
      });
      reqList.addEventListener("click", async (e)=>{
        const a = e.target.closest("[data-accept]");
        const r = e.target.closest("[data-decline]");
        if(a){ await acceptConversation(a.dataset.accept); }
        if(r){ await declineConversation(r.dataset.decline); }
      });
    }

    async function getOrCreateConversation(peerUid){
      const me = auth.currentUser; if(!me) return null;
      const cid = chatIdFor(me.uid, peerUid);
      const ref = doc(db,"conversations", cid);
      const s = await getDoc(ref);
      if(s.exists()) return { id: cid, data: s.data() };
      await setDoc(ref, {
        chatId: cid,
        members: [me.uid, peerUid],
        createdBy: me.uid,
        accepted: [me.uid],          // je valide d'embl√©e ma demande
        lastAt: serverTimestamp(),
        lastText: ""
      });
      return { id: cid, data: { members:[me.uid,peerUid], accepted:[me.uid] } };
    }

    async function acceptConversation(cid){
      const me = auth.currentUser; if(!me) return;
      await updateDoc(doc(db,"conversations", cid), { accepted: arrayUnion(me.uid), lastAt: serverTimestamp() });
      toast("Invitation accept√©e");
    }
    async function declineConversation(cid){
      await updateDoc(doc(db,"conversations", cid), { declinedAt: serverTimestamp() });
      toast("Invitation refus√©e");
    }

    async function openChatWith(peerUid, createIfMissing=false, knownCid=null){
      const me = auth.currentUser; if(!me) return;
      currentPeer = peerUid;
      currentCid  = knownCid || chatIdFor(me.uid, peerUid);
      if(createIfMissing){
        const { id } = await getOrCreateConversation(peerUid);
        currentCid = id;
      }
      chatTitle.textContent = "Chat avec " + (peerUid.slice(0,6)) + "‚Ä¶";
      listenConversationHeader();
      listenMessages();
    }

    function listenConversationHeader(){
      const me = auth.currentUser; if(!me || !currentCid) return;
      const ref = doc(db,"conversations", currentCid);
      onSnapshot(ref, (s)=>{
        if(!s.exists()) return;
        const c = s.data();
        const accepted = c.accepted || [];
        const bothAccepted = accepted.length===2;
        const iAmAccepted  = accepted.includes(me.uid);
        const otherAccepted= accepted.includes(currentPeer);
        btnAccept.style.display = (!iAmAccepted) ? "" : "none";
        btnDecline.style.display= (!iAmAccepted) ? "" : "none";
        chatStatus.style.display = "";
        if(bothAccepted){ chatStatus.textContent = "Priv√©"; chatStatus.style.background="#2ecc71"; }
        else if(!iAmAccepted){ chatStatus.textContent = "Invitation re√ßue"; chatStatus.style.background="#f1c40f"; }
        else if(!otherAccepted){ chatStatus.textContent = "En attente‚Ä¶"; chatStatus.style.background="#f1c40f"; }
      });
    }
    btnAccept.addEventListener("click",()=> acceptConversation(currentCid));
    btnDecline.addEventListener("click",()=> declineConversation(currentCid));

    // === Messages (temps r√©el)
    function listenMessages(){
      if(unsubMessages){ unsubMessages(); unsubMessages = null; }
      const me = auth.currentUser; if(!me || !currentPeer || !currentCid) return;

      // Marquer comme lu
      updateDoc(doc(db,"conversations", currentCid), { ["unread."+me.uid]: 0 }).catch(()=>{});

      const qMsg = query(collection(db,"messages"),
        where("chatId","==",currentCid),
        orderBy("createdAt","asc"),
        limit(200)
      );
      unsubMessages = onSnapshot(qMsg, (snap)=>{
        msgsList.innerHTML = "";
        snap.forEach(docu=>{
          const m = docu.data();
          const div = document.createElement("div");
          div.className = "msg " + (m.senderId===me.uid ? "me" : "them");
          div.textContent = m.text;
          msgsList.appendChild(div);
        });
        msgsList.scrollTop = msgsList.scrollHeight;
      }, err=> toast("Erreur de lecture des messages."));
    }

    sendForm?.addEventListener("submit", async (e)=>{
      e.preventDefault();
      const me = auth.currentUser; if(!me || !currentPeer || !currentCid){ toast("Choisis une conversation."); return; }
      if(!me.emailVerified){ toast("V√©rifie d‚Äôabord ton e-mail."); return; }

      // V√©rifier si la conversation est accept√©e par les deux
      const cSnap = await getDoc(doc(db,"conversations", currentCid));
      if(!cSnap.exists()){ toast("Conversation inconnue"); return; }
      const acc = cSnap.data().accepted || [];
      if(!(acc.includes(me.uid) && acc.includes(currentPeer))){
        toast("En attente d‚Äôacceptation de l‚Äôinvitation.");
        return;
      }

      const text = sanitize(msgInput.value.trim());
      if(!text) return;
      if(text.length>500){ toast("500 caract√®res max"); return; }

      await addDoc(collection(db,"messages"), {
        chatId: currentCid,
        senderId: me.uid,
        receiverId: currentPeer,
        text,
        createdAt: serverTimestamp()
      });

      // MAJ conversation (dernier message + unread pour le destinataire)
      await updateDoc(doc(db,"conversations", currentCid), {
        lastText: text,
        lastAt: serverTimestamp(),
        ["unread."+currentPeer]: (cSnap.data().unread?.[currentPeer] || 0) + 1
      });

      msgInput.value = "";
    });
  </script>
</body>
</html>