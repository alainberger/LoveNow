<!doctype html>
<html lang="fr">
<head>
  <!-- =========================
       LoveNow ‚Äî Index complet (SPA)
       =========================
       ‚úÖ √Ä v√©rifier une fois (Firebase Console)
       ‚Ä¢ Authentification ‚Üí Param√®tres ‚Üí Domaines autoris√©s :
         - lovenow.netlify.app
         - (ton futur domaine custom si besoin)
       ‚Ä¢ Authentification ‚Üí Mod√®les d‚Äôe-mail : logo & couleurs (optionnel)
       ‚Ä¢ Firestore ‚Üí R√®gles & Index cr√©√©s (tu les as d√©j√† faits)
       ‚Ä¢ App Check reCAPTCHA v3 : cl√© site activ√©e
       ‚Ä¢ Cloudinary : preset unsigned "profile_pics" + cloud_name "dyqxadd0j"
  -->
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>LoveNow ‚Äî Rencontres proches de toi</title>
  <meta name="description" content="LoveNow : rencontres locales et messagerie priv√©e. 100% gratuit au lancement.">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#0d0d10; --card:#151921; --line:#222a35; --txt:#f6f8fa; --muted:#aeb6c2;
      --acc:#ff4d6d; --acc2:#8f51ea; --acc3:#ff6bb5; --ok:#30d158; --danger:#ff6464;
      --warn:#ffcf40; --warn-bg:#201a00; --warn-line:#665500;
    }
    *{box-sizing:border-box}
    html,body{margin:0;background:var(--bg);color:var(--txt);font-family:'Poppins',system-ui,Segoe UI,Arial,sans-serif}
    a{color:var(--acc3);text-decoration:none}
    .wrap{max-width:1100px;margin:0 auto;padding:16px 18px}
    header{position:sticky;top:0;z-index:50;backdrop-filter:saturate(140%) blur(8px);
      background:linear-gradient(180deg,rgba(0,0,0,.7),rgba(0,0,0,.45));border-bottom:1px solid var(--line)}
    .row{display:flex;gap:14px;align-items:center;justify-content:space-between}
    .logo{font-weight:800;letter-spacing:.3px;color:var(--acc)}
    .nav-btn{border:1px solid #ffffffaa;padding:8px 14px;border-radius:999px;background:none;color:#fff;cursor:pointer}
    .nav-btn:hover{background:#fff;color:#000}
    .nav-btn.danger{border-color:var(--danger)}
    .hero{display:grid;place-items:center;min-height:68vh;text-align:center;padding:30px 18px;
      background:radial-gradient(1000px 500px at 15% 10%,rgba(255,77,109,.2),transparent 60%),
                 radial-gradient(1000px 500px at 85% 10%,rgba(143,81,234,.25),transparent 60%),
                 linear-gradient(135deg,var(--acc),var(--acc3),var(--acc2))}
    .hero h1{font-size:clamp(28px,6vw,48px);margin:6px 0 10px;font-weight:800}
    .hero p{max-width:640px;margin:0 auto 18px;color:#fff;opacity:.95}
    .cta{display:inline-block;background:#fff;color:#000;font-weight:800;border-radius:999px;padding:14px 28px;border:0;cursor:pointer}
    .uspbar{display:flex;gap:10px;justify-content:center;margin-top:14px;flex-wrap:wrap}
    .pill{border:1px solid #ffffff80;color:#fff;padding:6px 12px;border-radius:999px;font-size:12px;opacity:.9}
    section{padding:40px 18px}
    h2{margin:0 0 12px}
    .muted{color:var(--muted)}
    .grid{display:grid;gap:16px}
    .g-2{grid-template-columns:repeat(2,1fr)}
    @media(max-width:900px){.g-2{grid-template-columns:1fr}}
    .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:18px}
    .form{display:grid;gap:10px}
    .form input,.form textarea{width:100%;border-radius:10px;border:1px solid var(--line);background:#0f1320;color:#fff;padding:10px}
    .form button{border:0;border-radius:10px;padding:12px 16px;background:var(--acc);color:#000;font-weight:800;cursor:pointer}
    .file input{display:none}.file span{display:inline-block;border:1px dashed var(--line);padding:10px;border-radius:10px;cursor:pointer}
    .avatar-wrap{margin-top:10px;text-align:center}
    .avatar-wrap img{width:120px;height:120px;border-radius:50%;object-fit:cover;border:2px solid var(--line)}
    .list{display:grid;gap:8px;max-height:320px;overflow:auto}
    .item{display:flex;align-items:center;gap:10px;border:1px solid var(--line);padding:10px;border-radius:10px}
    .item img{width:44px;height:44px;border-radius:50%;object-fit:cover}
    .item .grow{flex:1}
    .item button{padding:8px 10px;border:0;border-radius:999px;background:var(--acc);font-weight:700}
    .divider{height:1px;background:var(--line);margin:12px 0}
    .chat{display:grid;grid-template-columns:260px 1fr;gap:10px}
    @media(max-width:900px){.chat{grid-template-columns:1fr}}
    .chat-people{border:1px solid var(--line);border-radius:10px;max-height:360px;overflow:auto}
    .people-item{display:flex;gap:8px;align-items:center;padding:10px;border-bottom:1px solid var(--line);cursor:pointer}
    .people-item .badge{margin-left:auto;background:var(--acc);color:#000;border-radius:999px;font-weight:800;padding:2px 8px;font-size:12px}
    .people-item small{color:var(--muted)}
    .people-item.active{background:#0f1320}
    .chat-box{display:grid;grid-template-rows:auto 1fr auto;border:1px solid var(--line);border-radius:10px;min-height:360px}
    .chat-head{display:flex;gap:8px;align-items:center;border-bottom:1px solid var(--line);padding:8px 10px}
    .messages{padding:10px;display:flex;flex-direction:column;gap:6px;max-height:300px;overflow:auto}
    .msg{max-width:80%;padding:8px 10px;border-radius:10px;border:1px solid var(--line)}
    .me{align-self:flex-end;background:#1c1f27}
    .them{align-self:flex-start;background:#11141b}
    .send{display:flex;gap:8px;border-top:1px solid var(--line);padding:8px}
    .send input{flex:1}
    .footer{padding:24px 18px;border-top:1px solid var(--line);text-align:center;color:var(--muted);font-size:14px}
    #toast{position:fixed;left:50%;transform:translateX(-50%);bottom:18px;background:#000d;border:1px solid var(--line);
      padding:10px 14px;border-radius:12px;display:none;z-index:90;min-width:240px;text-align:center}
    .sr-only{position:absolute;left:-99999px;top:auto;width:1px;height:1px;overflow:hidden}
    .banner{display:none;background:var(--warn-bg);color:#ffe58f;border-bottom:1px solid var(--warn-line);padding:10px}
    .banner .btn{margin-left:8px;border:0;background:var(--warn);color:#000;border-radius:8px;padding:6px 10px;font-weight:800}
    .notice{display:none;background:#121a12;border:1px solid #274b27;color:#cbeacb;padding:8px 10px;border-radius:10px;margin:8px 0}
    .warnCard{display:none;background:var(--warn-bg);border:1px solid var(--warn-line);color:#ffe58f;padding:8px 10px;border-radius:10px;margin-bottom:10px}
    .warnCard .btn{margin-left:6px;border:0;background:var(--warn);color:#000;border-radius:8px;padding:6px 10px;font-weight:800}
    button[disabled]{opacity:.6;pointer-events:none}
  </style>
</head>
<body>
  <a class="sr-only" href="#main">Aller au contenu</a>

  <header>
    <div class="wrap row">
      <div class="logo" aria-label="LoveNow">üíò LoveNow</div>
      <nav aria-label="Navigation">
        <button id="btnOpenAuth" class="nav-btn">Connexion</button>
        <button id="btnLogout" class="nav-btn danger" style="display:none">Se d√©connecter</button>
      </nav>
    </div>
    <!-- Bandeau global si e-mail non v√©rifi√© -->
    <div id="verifyEmailBar" class="banner" role="status" aria-live="polite">
      Votre e-mail n‚Äôest pas v√©rifi√©.
      <button id="btnSendVerify" class="btn">Valider mon e-mail</button>
      <button id="btnRefreshVerify" class="btn">Rafra√Æchir</button>
    </div>
  </header>

  <main id="main">
    <!-- HERO -->
    <section class="hero">
      <h1>Rencontre l‚Äôamour pr√®s de chez toi</h1>
      <p>Inscris-toi en 2 minutes, d√©couvre des profils r√©els √† proximit√© et commence √† discuter. 100% gratuit au lancement.</p>
      <button class="cta" id="ctaStart">Rejoins-nous gratuitement</button>
      <div class="uspbar">
        <span class="pill">üî• Gratuit au d√©part</span>
        <span class="pill">üìç Local & rapide</span>
        <span class="pill">üîí S√©curit√© & respect</span>
      </div>
    </section>

    <!-- APP -->
    <section id="app" class="wrap" style="display:none">
      <h2>Bienvenue <span id="hiName"></span> üëã</h2>

      <div class="grid g-2">
        <!-- PROFIL -->
        <div class="card">
          <!-- Encart v√©rification AU-DESSUS du profil -->
          <div id="verifyCard" class="warnCard">
            Votre e-mail n‚Äôest pas v√©rifi√©.
            <button id="btnSendVerify2" class="btn">Valider mon e-mail</button>
            <button id="btnRefreshVerify2" class="btn">Rafra√Æchir</button>
          </div>

          <h3>Mon profil</h3>
          <form id="editProfileForm" class="form">
            <label>Nom <input id="name" maxlength="30" required></label>
            <label>√Çge <input id="age" type="number" min="18" max="100" required></label>
            <label>Bio (500 max)
              <textarea id="bio" maxlength="500" rows="3" placeholder="Parle un peu de toi‚Ä¶"></textarea>
            </label>
            <div class="row">
              <label class="file">
                <input type="file" id="avatarFile" accept="image/*">
                <span>Ajouter/mettre √† jour ma photo</span>
              </label>
              <button type="submit">Enregistrer</button>
            </div>
          </form>
          <div class="avatar-wrap">
            <img id="avatarPreview" alt="Avatar" />
          </div>
        </div>

        <!-- D√âCOUVERTE + CHAT -->
        <div class="card">
          <h3>Profils proches</h3>
          <div id="profilesList" class="list"></div>

          <div class="divider"></div>

          <h3>Chat</h3>
          <div class="chat">
            <div class="chat-people" id="conversationsList"></div>
            <div class="chat-box">
              <div class="chat-head">
                <div id="chatTitle" class="muted">Aucune conversation</div>
                <div id="inviteBox" class="notice"></div>
              </div>
              <div id="messagesList" class="messages"></div>
              <form id="sendMsgForm" class="send">
                <input id="msgInput" placeholder="√âcrire un message‚Ä¶" maxlength="500" />
                <button type="submit">Envoyer</button>
              </form>
            </div>
          </div>

        </div>
      </div>
    </section>

    <!-- CTA FINAL -->
    <section id="cta" class="wrap">
      <div class="card" style="text-align:center">
        <h2>Pr√™t¬∑e √† tenter ta chance ?</h2>
        <p class="muted">Inscription en 2 minutes. 18+ uniquement.</p>
        <a class="cta" href="cgu.html" style="margin-right:8px">CGU</a>
        <a class="cta" href="confidentialite.html" style="margin-right:8px">Confidentialit√©</a>
        <a class="cta" href="mentions-legales.html">Mentions l√©gales</a>
      </div>
    </section>
  </main>

  <footer>
    <div class="wrap footer">
      ¬© 2025 LoveNow ‚Äî <a href="mentions-legales.html">Mentions l√©gales</a> ¬∑ <a href="confidentialite.html">Confidentialit√©</a> ¬∑ 18+ uniquement
    </div>
  </footer>

  <!-- MODALE AUTH -->
  <div class="modal" id="modalAuth" aria-hidden="true" role="dialog" aria-label="Authentification" style="display:none;align-items:center;justify-content:center;background:#0008;position:fixed;inset:0;z-index:60">
    <div class="card" style="width:min(680px,92vw);padding:0">
      <div class="row" style="padding:10px;border-bottom:1px solid var(--line)">
        <div>
          <button data-tab="signup" class="nav-btn">Inscription</button>
          <button data-tab="login" class="nav-btn">Connexion</button>
        </div>
        <button id="closeAuth" class="nav-btn">√ó</button>
      </div>

      <div id="paneSignup" style="padding:12px;display:none">
        <form id="signupForm" class="form">
          <label>Email <input id="suEmail" type="email" required autocomplete="email"></label>
          <label>Mot de passe <input id="suPass" type="password" minlength="6" required autocomplete="new-password"></label>
          <div class="row">
            <label>Nom <input id="suName" maxlength="30" required></label>
            <label>√Çge <input id="suAge" type="number" min="18" max="100" required></label>
          </div>
          <label>Bio (500 max)
            <textarea id="suBio" maxlength="500" rows="3" placeholder="Parle un peu de toi‚Ä¶"></textarea>
          </label>
          <label class="file">
            <input type="file" id="suAvatar" accept="image/*">
            <span>Photo de profil (optionnel)</span>
          </label>
          <button type="submit">Cr√©er mon compte</button>
        </form>
      </div>

      <div id="paneLogin" style="padding:12px;display:none">
        <form id="loginForm" class="form">
          <label>Email <input id="liEmail" type="email" required autocomplete="email"></label>
          <label>Mot de passe <input id="liPass" type="password" minlength="6" required autocomplete="current-password"></label>
          <button type="submit">Se connecter</button>
          <button type="button" id="btnForgot" class="nav-btn danger" style="margin-top:8px;border-color:transparent">Mot de passe oubli√©</button>
        </form>
      </div>
    </div>
  </div>

  <!-- TOAST -->
  <div id="toast" role="status" aria-live="polite"></div>

  <!-- ========== JS (module) ========== -->
  <script type="module">
    // ---------- Utils ----------
    const $=(s,c=document)=>c.querySelector(s), $$=(s,c=document)=>Array.from(c.querySelectorAll(s));
    function toast(m,ms=2600){const t=$("#toast");t.textContent=m;t.style.display="block";setTimeout(()=>t.style.display="none",ms)}
    const sanitize = s=> (s||"").replace(/[<>]/g,"");
    const chatIdFor = (a,b)=>[a,b].sort().join("_");
    const setLoading=(btn,on,labelBusy="...")=>{
      if(!btn) return;
      if(on){ btn.dataset._label = btn.textContent; btn.textContent = labelBusy; btn.setAttribute("disabled",""); }
      else { btn.textContent = btn.dataset._label || btn.textContent; btn.removeAttribute("disabled"); }
    };

    // ---------- UI modal ----------
    const modal=$("#modalAuth");
    const openAuth=w=>{modal.style.display="flex"; setTab(w||"signup")};
    const closeAuth=()=>{modal.style.display="none"};
    $("#btnOpenAuth")?.addEventListener("click",()=>openAuth("signup"));
    $("#ctaStart")?.addEventListener("click",()=>openAuth("signup"));
    $("#closeAuth")?.addEventListener("click",closeAuth);
    modal.addEventListener("click",e=>{if(e.target===modal)closeAuth();});
    function setTab(which){
      const bSignup = $("[data-tab='signup']"), bLogin=$("[data-tab='login']");
      bSignup.classList.toggle("active",which==="signup");
      bLogin.classList.toggle("active",which==="login");
      $("#paneSignup").style.display = which==="signup" ? "block" : "none";
      $("#paneLogin").style.display  = which==="login"  ? "block" : "none";
    }
    $$("[data-tab]").forEach(b=>b.addEventListener("click",()=>setTab(b.dataset.tab)));

    // ---------- Firebase (CDN v10) ----------
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-analytics.js";
    import {
      getAuth,onAuthStateChanged,createUserWithEmailAndPassword,signInWithEmailAndPassword,
      signOut,updateProfile,sendEmailVerification,sendPasswordResetEmail,reload
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import {
      getFirestore,doc,setDoc,getDoc,updateDoc,addDoc,collection,query,where,
      orderBy,limit,getDocs,onSnapshot,serverTimestamp,increment
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    import { initializeAppCheck, ReCaptchaV3Provider } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app-check.js";

    // ---------- Cloudinary (unsigned) ----------
    const CLOUD_NAME="dyqxadd0j";         // ton cloud name
    const UPLOAD_PRESET="profile_pics";    // preset unsigned cr√©√©
    async function uploadImage(file){
      const fd=new FormData();
      fd.append("file",file);
      fd.append("upload_preset",UPLOAD_PRESET);
      const r=await fetch(`https://api.cloudinary.com/v1_1/${CLOUD_NAME}/image/upload`,{method:"POST",body:fd});
      if(!r.ok) throw new Error("Upload Cloudinary √©chou√©");
      return r.json(); // => { secure_url, ... }
    }

    // ---------- Config Firebase ----------
    const firebaseConfig={
      apiKey:"AIzaSyB_-cNA8bxqYCYUp3rUZs-VpiP4DX2wn3M",
      authDomain:"lovenow-officiel.firebaseapp.com",
      projectId:"lovenow-officiel",
      storageBucket:"lovenow-officiel.firebasestorage.app",
      messagingSenderId:"896585801571",
      appId:"1:896585801571:web:cdde87293291dc1900bd56",
      measurementId:"G-QGM25ND7LF"
    };
    const RECAPTCHA_SITE_KEY="6LfjpsErAAAAAExN2IvBq-K475TeJooeNzl9liPD";

    const app=initializeApp(firebaseConfig);
    try{ getAnalytics(app); }catch{}
    initializeAppCheck(app,{provider:new ReCaptchaV3Provider(RECAPTCHA_SITE_KEY),isTokenAutoRefreshEnabled:true});

    const auth=getAuth(app);
    const db=getFirestore(app);

    // ---------- Refs ----------
    const appWrap=$("#app"), btnLogout=$("#btnLogout"), hiName=$("#hiName");
    const profilesList=$("#profilesList"), convList=$("#conversationsList");
    const msgsList=$("#messagesList"), sendForm=$("#sendMsgForm"), msgInput=$("#msgInput");
    const chatTitle=$("#chatTitle"), inviteBox=$("#inviteBox");
    const verifyBar=$("#verifyEmailBar"), verifyCard=$("#verifyCard");
    const btnSendVerify=$("#btnSendVerify"), btnRefreshVerify=$("#btnRefreshVerify");
    const btnSendVerify2=$("#btnSendVerify2"), btnRefreshVerify2=$("#btnRefreshVerify2");

    // ---------- Erreurs lisibles ----------
    const friendlyError=(e)=>{
      const code=e?.code||"";
      if(code.includes("too-many-requests")) return "Trop de tentatives. R√©essaie dans une minute.";
      if(code.includes("network-request-failed")) return "Probl√®me r√©seau. V√©rifie ta connexion.";
      if(code.includes("unauthorized-continue-uri")) return "Domaine de retour non autoris√© (ajoute le domaine dans Firebase > Auth > Domaines autoris√©s).";
      return e?.message||"Une erreur est survenue.";
    };

    // ---------- V√©rification e-mail ----------
    const actionCodeSettings={ url: window.location.origin + '/?verified=1', handleCodeInApp:false };

    async function sendVerification(user, btn){
      if(!user) return toast("Connecte-toi d‚Äôabord.");
      if(btn) setLoading(btn,true,"Envoi‚Ä¶");
      try{
        try{ await sendEmailVerification(user, actionCodeSettings); }
        catch(err){
          if((err?.code||"").includes("unauthorized-continue-uri")){
            await sendEmailVerification(user); // fallback
          } else { throw err; }
        }
        toast("E-mail de validation envoy√© ‚úâÔ∏è (v√©rifie SPAM)");
      }catch(e){ console.debug(e); toast(friendlyError(e)); }
      finally{ if(btn) setLoading(btn,false); }
    }
    async function refreshVerification(user, btn){
      if(!user) return;
      if(btn) setLoading(btn,true,"Maj‚Ä¶");
      try{ await reload(user); updateVerifyUI(user); }
      catch(e){ console.debug(e); toast(friendlyError(e)); }
      finally{ if(btn) setLoading(btn,false); }
    }
    function wireVerifyButtons(){
      btnSendVerify?.addEventListener("click",()=>sendVerification(auth.currentUser,btnSendVerify));
      btnRefreshVerify?.addEventListener("click",()=>refreshVerification(auth.currentUser,btnRefreshVerify));
      btnSendVerify2?.addEventListener("click",()=>sendVerification(auth.currentUser,btnSendVerify2));
      btnRefreshVerify2?.addEventListener("click",()=>refreshVerification(auth.currentUser,btnRefreshVerify2));
    }
    wireVerifyButtons();

    function updateVerifyUI(user){
      const verified=!!user?.emailVerified;
      verifyBar.style.display = verified ? "none" : "block";
      verifyCard.style.display = verified ? "none" : "block";
      msgInput.disabled = !verified; // bloque l‚Äôenvoi si non v√©rifi√©
    }

    // ---------- Auth: inscription ----------
    $("#signupForm")?.addEventListener("submit",async e=>{
      e.preventDefault();
      const email=$("#suEmail").value.trim();
      const pass=$("#suPass").value.trim();
      const name=sanitize($("#suName").value.trim()).slice(0,30);
      const age=parseInt($("#suAge").value,10);
      const bio=sanitize($("#suBio").value.trim()).slice(0,500);
      const file=$("#suAvatar").files[0];
      if(age<18){ toast("18+ requis"); return; }
      try{
        const cred=await createUserWithEmailAndPassword(auth,email,pass);
        const uid=cred.user.uid;

        let photoUrl="";
        if(file){ const up=await uploadImage(file); photoUrl=up.secure_url||""; }

        await setDoc(doc(db,"users",uid),{
          name, age, bio, createdAt: serverTimestamp(),
          photoUrl, photos: photoUrl ? [photoUrl] : []
        });
        await updateProfile(cred.user,{displayName:name,photoURL:photoUrl||null});
        // envoi v√©rification auto
        await sendVerification(cred.user,null);

        toast("Compte cr√©√© ‚Äî v√©rifie ton e-mail ‚úâÔ∏è");
        closeAuth();
      }catch(err){
        if(err.code==="auth/email-already-in-use"){ toast("Adresse d√©j√† utilis√©e ‚Äî connecte-toi."); setTab("login"); }
        else { toast(friendlyError(err)); }
      }
    });

    // ---------- Auth: connexion / reset / logout ----------
    $("#loginForm")?.addEventListener("submit",async e=>{
      e.preventDefault();
      const email=$("#liEmail").value.trim();
      const pass=$("#liPass").value.trim();
      try{
        await signInWithEmailAndPassword(auth,email,pass);
        toast("Connect√© !");
        closeAuth();
      }catch(err){ toast(friendlyError(err)); }
    });
    $("#btnForgot")?.addEventListener("click",async ()=>{
      const email=$("#liEmail").value.trim();
      if(!email){ toast("Entre d‚Äôabord ton e-mail"); return; }
      try{
        try{ await sendPasswordResetEmail(auth,email,actionCodeSettings); }
        catch(err){
          if((err?.code||"").includes("unauthorized-continue-uri")){
            await sendPasswordResetEmail(auth,email); // fallback
          } else throw err;
        }
        toast("Lien de r√©initialisation envoy√©.");
      }catch(e){ toast(friendlyError(e)); }
    });
    btnLogout?.addEventListener("click",async ()=>{ await signOut(auth); });

    // ---------- √âtat auth ----------
    let currentPeer=null, currentConv=null, unsubMessages=null, unsubConversations=null;

    onAuthStateChanged(auth, async user=>{
      if(user){
        try{ await reload(user) }catch{}
        $("#btnOpenAuth").style.display="none";
        btnLogout.style.display="";
        appWrap.style.display="";
        hiName.textContent=user.displayName||"toi";
        updateVerifyUI(user);

        // Si on revient de l‚Äôe-mail (?verified=1) et pas encore rafra√Æchi
        if(new URLSearchParams(location.search).has("verified") && !user.emailVerified){
          toast("Clique ‚ÄòRafra√Æchir‚Äô pour mettre √† jour le statut.");
        }

        // Charger profil
        try{
          const s=await getDoc(doc(db,"users",user.uid));
          if(s.exists()){
            const u=s.data();
            $("#name").value=u.name||"";
            $("#age").value=u.age||"";
            $("#bio").value=u.bio||"";
            if(u.photoUrl) $("#avatarPreview").src=u.photoUrl;
          }
        }catch{}
        loadProfiles();
        listenConversations();
      }else{
        $("#btnOpenAuth").style.display="";
        btnLogout.style.display="none";
        appWrap.style.display="none";
        verifyBar.style.display="none";
        verifyCard.style.display="none";
        stopListening();
      }
    });

    function stopListening(){
      if(unsubMessages){unsubMessages();unsubMessages=null}
      if(unsubConversations){unsubConversations();unsubConversations=null}
      msgsList.innerHTML="";
      chatTitle.textContent="Aucune conversation";
    }

    // ---------- Mise √† jour profil ----------
    $("#editProfileForm")?.addEventListener("submit",async e=>{
      e.preventDefault();
      const user=auth.currentUser; if(!user) return;
      const name=sanitize($("#name").value.trim()).slice(0,30);
      const age=parseInt($("#age").value,10);
      const bio=sanitize($("#bio").value.trim()).slice(0,500);
      const file=$("#avatarFile").files[0];
      try{
        const upd={name,age,bio};
        if(file){
          const up=await uploadImage(file);
          upd.photoUrl=up.secure_url;
          upd.photos=[up.secure_url];
          $("#avatarPreview").src=up.secure_url;
        }
        await updateDoc(doc(db,"users",user.uid),upd);
        await updateProfile(user,{displayName:name,photoURL:upd.photoUrl||user.photoURL||null});
        toast("Profil mis √† jour");
        loadProfiles();
      }catch(err){ toast(friendlyError(err)); }
    });

    // ---------- Profils (liste) ----------
    async function loadProfiles(){
      const me=auth.currentUser; if(!me) return;
      try{
        const q=query(collection(db,"users"), orderBy("createdAt","desc"), limit(30));
        const snap=await getDocs(q);
        profilesList.innerHTML="";
        snap.forEach(d=>{
          if(d.id===me.uid) return;
          const u=d.data();
          const div=document.createElement("div");
          div.className="item";
          div.innerHTML=`
            <img src="${u.photoUrl||'https://placehold.co/80x80?text=üë§'}" alt="">
            <div class="grow">
              <div><strong>${u.name||"Sans nom"}</strong> ¬∑ ${u.age||"?"} ans</div>
              <div class="muted">${(u.bio||"").slice(0,70)}</div>
            </div>
            <button data-uid="${d.id}">Message</button>
          `;
          div.querySelector("button").addEventListener("click",()=>openChatWith(d.id));
          profilesList.appendChild(div);
        });
      }catch(e){ console.debug(e); }
    }

    // ---------- Conversations & messages ----------
    function listenConversations(){
      const me=auth.currentUser; if(!me) return;
      if(unsubConversations){unsubConversations();unsubConversations=null}
      const qConv=query(collection(db,"conversations"),
                        where("members","array-contains",me.uid),
                        orderBy("lastAt","desc"));
      unsubConversations=onSnapshot(qConv,snap=>{
        convList.innerHTML="";
        snap.forEach(c=>{
          const data=c.data();
          const otherId=data.members.find(x=>x!==me.uid);
          const unread=(data.unread&&data.unread[me.uid])?data.unread[me.uid]:0;
          const item=document.createElement("div");
          item.className="people-item";
          item.innerHTML=`
            <div>
              <div><strong>${data.lastSenderName||"Discussion"}</strong>
                <small class="muted">¬∑ ${new Date(data.lastAt?.toDate?.()||Date.now()).toLocaleString()}</small>
              </div>
              <small>${sanitize(data.lastText||"")}</small>
            </div>
            ${unread?`<span class="badge">${unread}</span>`:""}
          `;
          item.addEventListener("click",()=>openChatWith(otherId));
          convList.appendChild(item);
        });
      },err=>{ console.debug(err); toast("Erreur: conversations"); });
    }

    async function ensureConversation(meUid,peerUid){
      const cid=chatIdFor(meUid,peerUid);
      const ref=doc(db,"conversations",cid);
      const s=await getDoc(ref);
      if(!s.exists()){
        await setDoc(ref,{
          members:[meUid,peerUid],
          status:{[meUid]:"accepted",[peerUid]:"pending"}, // invitation
          lastText:"", lastSender:"", lastSenderName:"",
          lastAt: serverTimestamp(),
          unread:{[meUid]:0,[peerUid]:0},
          createdAt: serverTimestamp()
        });
      }
      return ref;
    }

    async function openChatWith(peerUid){
      const me=auth.currentUser; if(!me) return;
      const ref=await ensureConversation(me.uid,peerUid);
      const cid=chatIdFor(me.uid,peerUid);
      chatTitle.textContent="Discussion";
      inviteBox.style.display="none"; inviteBox.innerHTML="";

      const cs=await getDoc(ref);
      if(cs.exists()){
        const c=cs.data();
        const my=c.status?.[me.uid]||"accepted";
        const other=c.status?.[peerUid]||"accepted";
        if(my==="pending"){
          inviteBox.style.display="block";
          inviteBox.innerHTML=`
            <strong>Invitation re√ßue</strong> ‚Äî accepter pour discuter ?
            <div style="margin-top:6px">
              <button id="btnAccept" class="btn" style="background:#ffd34d;color:#000;border:0;border-radius:8px;padding:6px 10px;font-weight:800">Accepter</button>
              <button id="btnRefuse" class="btn" style="background:#ff6464;color:#000;border:0;border-radius:8px;padding:6px 10px;font-weight:800">Refuser</button>
            </div>`;
          $("#btnAccept").onclick=async()=>{ await updateDoc(ref,{["status."+me.uid]:"accepted"}); inviteBox.style.display="none"; toast("Invitation accept√©e ‚úÖ"); };
          $("#btnRefuse").onclick=async()=>{ await updateDoc(ref,{["status."+me.uid]:"blocked"}); toast("Conversation bloqu√©e"); };
        } else if(other==="pending"){
          inviteBox.style.display="block";
          inviteBox.textContent="En attente d‚Äôacceptation‚Ä¶";
        }
      }

      currentPeer=peerUid;
      currentConv=cid;
      listenMessages();
      try{ await updateDoc(doc(db,"conversations",cid),{["unread."+me.uid]:0}); }catch{}
    }

    function listenMessages(){
      if(unsubMessages){unsubMessages();unsubMessages=null}
      const me=auth.currentUser; if(!me||!currentPeer) return;
      const cid=chatIdFor(me.uid,currentPeer);
      const q=query(collection(db,"messages"),
                    where("chatId","==",cid),
                    orderBy("createdAt","asc"),
                    limit(500));
      unsubMessages=onSnapshot(q,snap=>{
        msgsList.innerHTML="";
        snap.forEach(d=>{
          const m=d.data();
          const div=document.createElement("div");
          div.className="msg "+(m.senderId===me.uid?"me":"them");
          div.textContent=m.text;
          msgsList.appendChild(div);
        });
        msgsList.scrollTop=msgsList.scrollHeight;
      }, err=>{ console.debug(err); toast("Erreur de lecture des messages."); });
    }

    // ---------- Envoi ----------
    sendForm?.addEventListener("submit",async e=>{
      e.preventDefault();
      const me=auth.currentUser;
      if(!me||!currentPeer){ toast("Choisis un profil"); return; }
      if(!me.emailVerified){ toast("Valide d‚Äôabord ton e-mail ‚úâÔ∏è"); return; }

      const text=sanitize(msgInput.value.trim());
      if(!text) return;
      if(text.length>500){ toast("500 caract√®res max"); return; }

      const cid=chatIdFor(me.uid,currentPeer);
      const ref=doc(db,"conversations",cid);
      const cSnap=await getDoc(ref);
      const st=cSnap.data()?.status||{};
      if(st[me.uid]!=="accepted"||st[currentPeer]==="blocked"){
        toast("Invitation non accept√©e."); return;
      }

      await addDoc(collection(db,"messages"),{
        chatId:cid,
        senderId:me.uid,
        receiverId:currentPeer,
        text,
        createdAt: serverTimestamp()
      });
      try{
        await updateDoc(ref,{
          lastText:text,
          lastSender:me.uid,
          lastSenderName: me.displayName||"Quelqu‚Äôun",
          lastAt: serverTimestamp(),
          ["unread."+currentPeer]: increment(1)
        });
      }catch{}
      msgInput.value="";
    });

    // ---------- Brancher boutons v√©rif (header + encart) ----------
    (function initVerifyButtons(){
      btnSendVerify?.addEventListener("click",()=>sendVerification(auth.currentUser,btnSendVerify));
      btnRefreshVerify?.addEventListener("click",()=>refreshVerification(auth.currentUser,btnRefreshVerify));
      btnSendVerify2?.addEventListener("click",()=>sendVerification(auth.currentUser,btnSendVerify2));
      btnRefreshVerify2?.addEventListener("click",()=>refreshVerification(auth.currentUser,btnRefreshVerify2));
    })();
  </script>
</body>
</html>